@echo off
REM AgogSaaS Smoke Test - All 4 Layers
REM Tests that all phases are operational

echo.
echo ================================================
echo   AgogSaaS - Smoke Test (All 4 Layers)
echo ================================================
echo.

REM Check if services are running
echo [Checking] Services status...
docker ps | findstr "agogsaas" >nul
if %errorlevel% neq 0 (
    echo [ERROR] Services not running! Run quick-start.bat first.
    exit /b 1
)
echo [OK] Services are running
echo.

REM Test Phase 1: Validation (Pre-commit hooks)
echo ================================================
echo Phase 1: VALIDATION (Pre-commit Hooks)
echo ================================================
if exist .git-hooks\pre-commit (
    echo [OK] Pre-commit hook exists
    echo [OK] Layer 1 (Validation) is configured
) else (
    echo [WARNING] Pre-commit hook not found
)
echo.

REM Test Phase 2: Monitoring (Health endpoints)
echo ================================================
echo Phase 2: MONITORING (Health Dashboard)
echo ================================================
echo [Testing] Backend health endpoint...
curl -s http://localhost:4001/health >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] Backend health endpoint responding
) else (
    echo [ERROR] Backend health endpoint not responding
)

echo [Testing] PostgreSQL connection...
docker exec agogsaas-backend psql postgresql://agogsaas_user:${DB_PASSWORD}@postgres:5432/agogsaas -c "SELECT 1" >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] PostgreSQL connected
) else (
    echo [WARNING] PostgreSQL connection check failed
)

echo [Testing] Frontend monitoring dashboard...
curl -s http://localhost:3000 >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] Frontend accessible at http://localhost:3000
    echo [OK] Monitoring dashboard at http://localhost:3000/monitoring
) else (
    echo [WARNING] Frontend not responding
)
echo.

REM Test Phase 3: Orchestration (NATS)
echo ================================================
echo Phase 3: ORCHESTRATION (NATS Jetstream)
echo ================================================
echo [Testing] NATS health...
curl -s http://localhost:8223/healthz >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] NATS server healthy
) else (
    echo [ERROR] NATS server not responding
)

echo [Testing] NATS streams...
docker exec agogsaas-backend node -e "const nats = require('nats'); (async () => { try { const nc = await nats.connect({ servers: 'nats://nats:4222' }); const jsm = await nc.jetstreamManager(); const streams = await jsm.streams.list().next(); console.log('NATS streams OK'); nc.close(); } catch(e) { console.error(e.message); process.exit(1); } })()" 2>&1 | findstr "OK"
if %errorlevel% == 0 (
    echo [OK] NATS Jetstream operational
) else (
    echo [WARNING] Could not verify NATS streams
)
echo.

REM Test Phase 4: Memory (Ollama + Vector DB)
echo ================================================
echo Phase 4: MEMORY (Ollama Embeddings)
echo ================================================
echo [Testing] Ollama service...
curl -s http://localhost:11434/api/tags >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] Ollama service responding
) else (
    echo [ERROR] Ollama service not responding
)

echo [Testing] nomic-embed-text model...
docker exec agogsaas-ollama ollama list | findstr "nomic-embed-text" >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] nomic-embed-text model installed
) else (
    echo [WARNING] Model not installed - run: docker exec agogsaas-ollama ollama pull nomic-embed-text
)

echo [Testing] pgvector extension...
docker exec agogsaas-postgres psql -U agogsaas_user -d agogsaas -c "SELECT extname FROM pg_extension WHERE extname='vector'" | findstr "vector" >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] pgvector extension enabled
) else (
    echo [WARNING] pgvector extension not found
)

echo [Testing] memories table...
docker exec agogsaas-postgres psql -U agogsaas_user -d agogsaas -c "\d memories" >nul 2>&1
if %errorlevel% == 0 (
    echo [OK] memories table exists
) else (
    echo [WARNING] memories table not found - run migrations
)
echo.

echo ================================================
echo   Smoke Test Summary
echo ================================================
echo.
echo Services:
echo   - PostgreSQL:  http://localhost:5433 (5432 used by WMS)
echo   - NATS:        http://localhost:4223 (monitoring: :8223, 4222 used by WMS)
echo   - Ollama:      http://localhost:11434
echo   - Backend API: http://localhost:4001/graphql
echo   - Frontend:    http://localhost:3000
echo   - Monitoring:  http://localhost:3000/monitoring
echo.
echo Layers:
echo   Layer 1 (Validation):    Pre-commit hooks
echo   Layer 2 (Monitoring):    Dashboard at /monitoring
echo   Layer 3 (Orchestration): NATS Jetstream
echo   Layer 4 (Memory):        Ollama + pgvector
echo.
echo [TIP] Run detailed Phase 4 test:
echo   docker exec agogsaas-backend npm run test:memory
echo.
