# CONFORMED DIMENSIONS - Vector DB Memory
# Purpose: Queryable dimensional model for AI agents
# Usage: AI can query "What is the grain of the Customer dimension?" and get structured answer

type: dimensional_model_memory
category: conformed_dimensions
version: "1.0"
last_updated: "2025-12-17"

# Core principle for AI agents to understand
principles:
  olap_drives_oltp: "OLAP requirements drive OLTP schema design. Business intelligence needs determine what data we capture."
  semantic_consistency: "Column names must have ONE meaning across entire enterprise. No overloading."
  kimball_methodology: "Use Kimball dimensional modeling: Bus Matrix, conformed dimensions, fact grain definitions"

# Conformed Dimensions (reused across all fact tables)
dimensions:

  date:
    name: "Date Dimension"
    grain: "One row per day"
    type: "Type 0 (no changes)"
    surrogate_key: "date_key"
    natural_key: "date_actual"
    attributes:
      - date_key           # YYYYMMDD surrogate
      - date_actual        # DATE
      - day_of_week
      - day_of_month
      - day_of_year
      - week_of_year
      - month_number
      - month_name
      - quarter_number
      - year_number
      - fiscal_period
      - is_weekend
      - is_holiday
      - holiday_name
    oltp_column_standard: "<event>_date"
    examples:
      - column: "order_date"
        meaning: "Date sales order was placed"
      - column: "invoice_date"
        meaning: "Date invoice was generated"
      - column: "shipment_date"
        meaning: "Date shipment occurred"
      - column: "production_date"
        meaning: "Date production run occurred"
    business_rule: "All _date columns refer to calendar date (YYYY-MM-DD), not datetime"

  time_of_day:
    name: "Time of Day Dimension"
    grain: "One row per minute (or second for high-frequency events)"
    type: "Type 0 (no changes)"
    surrogate_key: "time_key"
    natural_key: "time_actual"
    attributes:
      - time_key           # HHMMSS surrogate
      - time_actual        # TIME
      - hour_24
      - hour_12
      - minute
      - second
      - am_pm
      - shift              # 1st, 2nd, 3rd
      - business_hours     # Y/N
    oltp_column_standard: "<event>_time or <event>_timestamp"
    examples:
      - column: "clock_in_time"
        meaning: "Time employee clocked in"
      - column: "event_timestamp"
        meaning: "Precise moment of equipment event"
      - column: "reading_timestamp"
        meaning: "Precise moment of sensor reading"
    business_rule: "Use _timestamp (TIMESTAMPTZ) for precision events, _time (TIME) for time-of-day only"

  customer:
    name: "Customer Dimension"
    grain: "One row per customer per change"
    type: "Type 2 (track changes)"
    surrogate_key: "customer_key"
    natural_key: "customer_code"
    attributes:
      - customer_key       # Surrogate
      - customer_code      # Natural key
      - customer_name
      - legal_name
      - customer_type
      - credit_limit
      - payment_terms
      - sales_rep_key      # FK to Employee
      - pricing_tier
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "customer_id"
    oltp_table: "customers"
    oltp_primary_key: "id"
    examples:
      - column: "customer_id"
        meaning: "The customer who is buying/receiving goods or services"
    business_rule: "Customer dimension tracks who BUYS. For 3PL, use separate customer_id (owner) vs ship_to_customer_id (recipient)"
    scd_requirements:
      - "Add effective_from_date DATE NOT NULL DEFAULT CURRENT_DATE"
      - "Add effective_to_date DATE DEFAULT '9999-12-31'"
      - "Add is_current_version BOOLEAN DEFAULT TRUE"
      - "Unique constraint: (tenant_id, customer_code, effective_from_date)"

  product:
    name: "Product Dimension"
    grain: "One row per product per change"
    type: "Type 2 (track changes)"
    surrogate_key: "product_key"
    natural_key: "product_code"
    attributes:
      - product_key
      - product_code
      - product_name
      - product_category
      - packaging_type
      - design_width_inches
      - design_height_inches
      - standard_cost
      - list_price
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "product_id"
    oltp_table: "products"
    oltp_primary_key: "id"
    business_rule: "Product = sellable finished good. Use material_id for raw materials/substrates"
    scd_requirements:
      - "Add effective_from_date DATE NOT NULL DEFAULT CURRENT_DATE"
      - "Add effective_to_date DATE DEFAULT '9999-12-31'"
      - "Add is_current_version BOOLEAN DEFAULT TRUE"

  material:
    name: "Material Dimension"
    grain: "One row per material per change"
    type: "Type 2 (track changes)"
    surrogate_key: "material_key"
    natural_key: "material_code"
    attributes:
      - material_key
      - material_code
      - material_name
      - material_type      # RAW_MATERIAL, SUBSTRATE, INK, etc.
      - material_category
      - primary_uom
      - standard_cost
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "material_id"
    oltp_table: "materials"
    oltp_primary_key: "id"
    business_rule: "Material = inputs to manufacturing. Products can also be materials (type=FINISHED_GOOD)"
    scd_requirements:
      - "Add effective_from_date DATE NOT NULL DEFAULT CURRENT_DATE"
      - "Add effective_to_date DATE DEFAULT '9999-12-31'"
      - "Add is_current_version BOOLEAN DEFAULT TRUE"

  facility:
    name: "Facility Dimension"
    grain: "One row per facility per change"
    type: "Type 2 (track changes)"
    surrogate_key: "facility_key"
    natural_key: "facility_code"
    attributes:
      - facility_key
      - facility_code
      - facility_name
      - facility_type      # FACTORY, WAREHOUSE, OFFICE
      - city
      - state
      - country
      - timezone
      - is_edge_site
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "facility_id"
    oltp_table: "facilities"
    oltp_primary_key: "id"
    business_rule: "Use ship_to_facility_id vs bill_to_facility_id when different"

  work_center:
    name: "Work Center Dimension"
    grain: "One row per work center per change"
    type: "Type 2 (track changes)"
    surrogate_key: "work_center_key"
    natural_key: "work_center_code"
    attributes:
      - work_center_key
      - work_center_code
      - work_center_name
      - work_center_type   # OFFSET_PRESS, DIGITAL_PRESS, etc.
      - facility_key       # FK
      - max_sheet_width
      - max_sheet_height
      - max_colors
      - production_rate_per_hour
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "work_center_id"
    oltp_table: "work_centers"
    oltp_primary_key: "id"

  employee:
    name: "Employee Dimension"
    grain: "One row per employee per change"
    type: "Type 2 (track changes)"
    surrogate_key: "employee_key"
    natural_key: "employee_number"
    attributes:
      - employee_key
      - employee_number
      - first_name
      - last_name
      - full_name
      - job_title
      - department
      - facility_key       # FK
      - supervisor_employee_key  # FK
      - hire_date
      - termination_date
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "employee_id or <role>_user_id"
    oltp_table: "employees"
    oltp_primary_key: "id"
    business_rule: "Use employee_id for hourly workers. Use <role>_user_id for knowledge workers (inspector_user_id, buyer_user_id). Always use _user_id suffix for audit columns (created_by_user_id)"

  vendor:
    name: "Vendor Dimension"
    grain: "One row per vendor per change"
    type: "Type 2 (track changes)"
    surrogate_key: "vendor_key"
    natural_key: "vendor_code"
    attributes:
      - vendor_key
      - vendor_code
      - vendor_name
      - legal_name
      - vendor_type
      - payment_terms
      - on_time_delivery_pct
      - quality_rating_pct
      - overall_rating
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "vendor_id"
    oltp_table: "vendors"
    oltp_primary_key: "id"

  security_zone:
    name: "Security Zone Dimension"
    grain: "One row per security zone per change"
    type: "Type 2 (track changes)"
    surrogate_key: "security_zone_key"
    natural_key: "zone_code"
    attributes:
      - security_zone_key
      - zone_code
      - zone_name
      - zone_level         # STANDARD, RESTRICTED, SECURE, HIGH_SECURITY, VAULT
      - facility_key       # FK
      - requires_badge
      - requires_biometric
      - requires_dual_control
      - effective_from_date
      - effective_to_date
      - is_current
    oltp_column_standard: "security_zone_id"
    oltp_table: "security_zones"
    oltp_primary_key: "id"

# Column Naming Standards (semantic consistency rules for AI)
column_naming_standards:

  date_columns:
    pattern: "<event>_date"
    data_type: "DATE"
    examples:
      order_date: "Date sales order was placed"
      invoice_date: "Date invoice was generated"
      shipment_date: "Date shipment occurred"
      production_date: "Date production run occurred"
      inspection_date: "Date quality inspection performed"
    rule: "All _date columns refer to calendar date (YYYY-MM-DD), not datetime"

  timestamp_columns:
    pattern: "<event>_timestamp"
    data_type: "TIMESTAMPTZ"
    examples:
      event_timestamp: "Precise moment of equipment event"
      reading_timestamp: "Precise moment of sensor reading"
      custody_transfer_timestamp: "Precise moment of custody transfer"
    rule: "Use _timestamp for precision date+time events with timezone"

  time_columns:
    pattern: "<event>_time"
    data_type: "TIME"
    examples:
      clock_in_time: "Time employee clocked in"
      clock_out_time: "Time employee clocked out"
    rule: "Use _time ONLY for time-of-day without date component"

  audit_columns:
    pattern: "<action>_at"
    data_type: "TIMESTAMPTZ"
    examples:
      created_at: "When record was created"
      updated_at: "When record was last updated"
      deleted_at: "When record was soft-deleted"
      approved_at: "When record was approved"
    rule: "Use _at suffix for audit trail timestamps"

  quantity_columns:
    pattern: "quantity_<context>"
    data_type: "DECIMAL(18,4)"
    examples:
      quantity_ordered: "Quantity customer ordered"
      quantity_shipped: "Quantity shipped to customer"
      quantity_invoiced: "Quantity invoiced"
      quantity_received: "Quantity received from vendor"
      quantity_on_hand: "Current inventory quantity"
      quantity_available: "Available for allocation"
      quantity_allocated: "Reserved quantity"
      good_quantity: "Good production output"
      scrap_quantity: "Scrap/waste quantity"
    rule: "Always specify WHAT quantity. Never use generic 'quantity'"

  amount_columns:
    pattern: "<context>_amount"
    data_type: "DECIMAL(18,4)"
    examples:
      unit_price: "Price per unit"
      line_amount: "Extended line total"
      subtotal: "Sum before tax/shipping"
      tax_amount: "Tax amount"
      shipping_amount: "Shipping cost"
      discount_amount: "Discount amount"
      total_amount: "Grand total"
      debit_amount: "GL debit (always positive)"
      credit_amount: "GL credit (always positive)"
    rule: "Use specific context. GL must use debit_amount/credit_amount, not generic 'amount'"

  rate_percentage_columns:
    pattern: "<metric>_percent or <rate>_per_<unit>"
    data_type: "DECIMAL(8,4) or DECIMAL(18,4)"
    examples:
      discount_percentage: "0-100 range"
      margin_percentage: "Can be negative"
      oee_percent: "0-100 range"
      on_time_delivery_pct: "0-100 range"
      hourly_rate: "Currency per hour"
      exchange_rate: "Conversion multiplier"
    rule: "Percentages stored as 0-100, not 0-1. Rates include _per_ or _rate"

# AI Query Examples (how agents should use this memory)
ai_query_examples:

  - query: "What is the grain of the Customer dimension?"
    answer: "One row per customer per change (SCD Type 2)"

  - query: "What should I name a column for invoice date?"
    answer: "invoice_date (DATE type). Follows pattern <event>_date for calendar dates"

  - query: "How do I handle customer changes over time?"
    answer: "Use SCD Type 2: effective_from_date, effective_to_date, is_current_version. Track history for dimensional analysis"

  - query: "What's the difference between product_id and material_id?"
    answer: "product_id = sellable finished goods. material_id = raw materials, substrates, inputs. Products can also be materials (type=FINISHED_GOOD)"

  - query: "Should I use 'quantity' or 'quantity_ordered'?"
    answer: "ALWAYS use quantity_<context> like quantity_ordered, quantity_shipped, quantity_on_hand. Never use generic 'quantity'"

  - query: "How do I name GL amount columns?"
    answer: "Use debit_amount and credit_amount (both positive). Never use generic 'amount' in journal entries"

  - query: "What's the standard for audit trail columns?"
    answer: "created_at, updated_at, deleted_at (TIMESTAMPTZ with _at suffix). created_by_user_id, updated_by_user_id, deleted_by_user_id (always include _user_id suffix)"

# Memory metadata for vector DB
memory_metadata:
  embeddings_needed: true
  searchable_fields:
    - dimension names
    - column patterns
    - business rules
    - examples
  related_concepts:
    - "Kimball methodology"
    - "Star schema"
    - "Fact tables"
    - "ETL"
    - "Business intelligence"
  version_history:
    - version: "1.0"
      date: "2025-12-17"
      changes: "Initial dimensional model definition"
