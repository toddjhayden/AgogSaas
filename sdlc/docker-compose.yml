# SDLC Platform - Development Stack
# Container naming: sdlc-*
# Database: Uses VPS (api.agog.fyi) - no local postgres
# Use: docker-compose -f sdlc/docker-compose.yml up -d
# Requires: sdlc/.env file with credentials

services:
  # NATS Jetstream - Agent Communication
  nats:
    image: nats:latest
    container_name: sdlc-nats
    command:
      - "-c"
      - "/etc/nats/nats-server.conf"
    ports:
      - "4223:4222"  # Client port
      - "8223:8222"  # Monitoring port
    volumes:
      - sdlc_nats_data:/data
      - ./infrastructure/nats/nats-server.conf:/etc/nats/nats-server.conf
    restart: unless-stopped
    networks:
      - sdlc_network

  # Ollama - AI Model Server (embeddings + local LLM)
  ollama:
    image: ollama/ollama:latest
    container_name: sdlc-ollama
    ports:
      - "11434:11434"
    volumes:
      - sdlc_ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - sdlc_network

  # SDLC Core - Orchestration System
  core:
    build:
      context: ./core
      dockerfile: Dockerfile
    container_name: sdlc-core
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      # NATS Configuration (local)
      NATS_URL: nats://nats:4222
      NATS_USER: ${NATS_USER:?NATS_USER required}
      NATS_PASSWORD: ${NATS_PASSWORD:?NATS_PASSWORD required}
      # SDLC API (VPS) - all database operations go through API
      SDLC_API_URL: ${SDLC_API_URL:?SDLC_API_URL required}
      SDLC_AGENT_ID: ${SDLC_AGENT_ID:-local-sdlc-core}
      # Workflow persistence database (optional - degraded mode if not set)
      DATABASE_URL: ${DATABASE_URL:-}
      # Ollama for embeddings (local)
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      # Managed project paths (mounted from projects/)
      PROJECT_ROOT: ${PROJECT_ROOT:-/workspace/projects}
    ports:
      - "4002:4000"  # SDLC API
    depends_on:
      nats:
        condition: service_started
      ollama:
        condition: service_started
    volumes:
      # SDLC core code
      - ./core/src:/app/src
      - ./core/scripts:/app/scripts
      - ./core/package.json:/app/package.json
      - sdlc_core_node_modules:/app/node_modules
      # Agent personas
      - ./agents/personas:/app/agents/personas
      - ./agents/onboarding:/app/agents/onboarding
      # Managed projects (each project has sdlc.config.json)
      - ../projects:/workspace/projects
      # Logs
      - ./logs:/app/logs
    command: npm run daemon:full
    restart: unless-stopped
    networks:
      - sdlc_network

volumes:
  sdlc_nats_data:
    name: sdlc_nats_data
  sdlc_core_node_modules:
    name: sdlc_core_node_modules
  sdlc_ollama_data:
    name: sdlc_ollama_data

networks:
  sdlc_network:
    name: sdlc_network
    driver: bridge
