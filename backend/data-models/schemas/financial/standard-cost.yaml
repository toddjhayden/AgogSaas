version: '0.1'
metadata:
  domain: financial
  priority: high
  estimatedEffort: 1-week
  blocksKPIs: 8+
  status: draft

entity:
  name: StandardCost
  description: |
    Standard (planned/budgeted) costs for parts, operations, and activities.
    Foundation for cost variance analysis, value-added vs non-value-added costing.
    Links to production orders for planned costs, compared against actuals for variance.
    Blocks 8+ cost control, variance analysis, and value stream mapping KPIs.
  
  tables:
    - name: standard_costs
      description: Standard cost master data
    - name: cost_centers
      description: Cost center definitions for GL mapping
    - name: cost_categories
      description: Cost categories (value-added vs non-value-added)
      
  properties:
    # Standard Cost Record
    standard_cost_id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # What is being costed
    cost_object_type:
      type: enum
      description: Type of item being costed
      values:
        - material (raw materials, substrates)
        - operation (production operation)
        - equipment_hour (machine hour rate)
        - labor_hour (labor hour rate by skill)
        - overhead (overhead allocation)
        - activity (ABC costing activity)
      constraints:
        - not_null
        - indexed
    
    cost_object_id:
      type: uuid
      description: ID of the object (material_id, equipment_id, etc.)
      constraints:
        - indexed
    
    cost_object_code:
      type: varchar(50)
      description: Human-readable identifier
      constraints:
        - not_null
        - unique: [tenant_id, cost_object_type, cost_object_code]
    
    cost_object_description:
      type: text
      description: What is being costed
      examples:
        - "80# Gloss Text, 25x38 sheets"
        - "4-Color Press Operation (per hour)"
        - "Operator labor, Level 2 (per hour)"
        - "Material handling activity (per move)"
    
    # Cost Components
    material_cost:
      type: decimal
      description: Standard material cost component
      constraints:
        - not_null
        - default: 0
        - check: material_cost >= 0
    
    labor_cost:
      type: decimal
      description: Standard labor cost component
      constraints:
        - not_null
        - default: 0
        - check: labor_cost >= 0
    
    equipment_cost:
      type: decimal
      description: Standard equipment/machine cost component
      constraints:
        - not_null
        - default: 0
        - check: equipment_cost >= 0
    
    overhead_cost:
      type: decimal
      description: Standard overhead cost component
      constraints:
        - not_null
        - default: 0
        - check: overhead_cost >= 0
    
    total_standard_cost:
      type: decimal
      description: Total standard cost (sum of components)
      constraints:
        - not_null
        - check: total_standard_cost = material_cost + labor_cost + equipment_cost + overhead_cost
        - check: total_standard_cost >= 0
    
    # Unit of Measure
    cost_per_unit:
      type: varchar(50)
      description: What unit this cost applies to
      examples:
        - "per sheet"
        - "per pound"
        - "per hour"
        - "per piece"
        - "per setup"
      constraints:
        - not_null
    
    # Cost Center & GL Mapping
    cost_center_id:
      type: uuid
      description: Cost center for GL posting
      constraints:
        - foreign_key: cost_centers.cost_center_id
        - indexed
    
    gl_account:
      type: varchar(50)
      description: General ledger account code
      constraints:
        - indexed
    
    # Value Analysis
    value_category:
      type: enum
      description: Value-added classification
      values:
        - value_added (customer pays for this)
        - business_value_added (necessary but not customer-visible)
        - non_value_added (waste, should eliminate)
      constraints:
        - not_null
        - indexed
    
    reason_code_category:
      type: enum
      description: Reason/accountability category (for scrap, rework)
      values:
        - material_defect (vendor quality issue)
        - equipment_failure (machine breakdown)
        - operator_error (human error)
        - design_issue (engineering problem)
        - setup_waste (normal makeready)
        - process_variation (random variation)
      constraints:
        - indexed
    
    financial_impact_category:
      type: varchar(50)
      description: Financial reporting category
      examples:
        - "Direct material"
        - "Direct labor"
        - "Manufacturing overhead"
        - "Quality costs"
        - "Waste and scrap"
    
    # Effective Dates
    effective_from:
      type: date
      description: When this standard cost becomes effective
      constraints:
        - not_null
        - indexed
    
    effective_to:
      type: date
      description: When this standard cost expires (null = current)
      constraints:
        - indexed
    
    is_current:
      type: boolean
      description: True if this is the current active standard
      constraints:
        - not_null
        - default: true
        - indexed
    
    # Calculation Basis
    calculation_method:
      type: text
      description: How this standard was calculated
      examples:
        - "Material cost from vendor quote + 5% freight"
        - "Labor: 2.5 hours × $35/hour average rate"
        - "Overhead: 150% of direct labor cost"
    
    assumptions:
      type: text
      description: Assumptions used in calculation
    
    # Variance Targets
    variance_threshold_percent:
      type: decimal
      description: Acceptable variance percentage
      constraints:
        - default: 10
        - check: variance_threshold_percent >= 0
    
    # Audit
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    approved_by:
      type: uuid
      description: Who approved this standard cost
      constraints:
        - foreign_key: users.id
    
    approved_at:
      type: timestamp
      description: When standard was approved

  # Cost Centers
  costCenters:
    name: CostCenter
    description: Cost centers for organizational cost tracking and GL mapping
    
    properties:
      cost_center_id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()
      
      tenant_id:
        type: uuid
        description: Multi-tenant isolation
        constraints:
          - not_null
          - foreign_key: tenants.id
          - indexed
      
      cost_center_code:
        type: varchar(20)
        description: Cost center code
        constraints:
          - not_null
          - unique: [tenant_id, cost_center_code]
      
      cost_center_name:
        type: varchar(100)
        description: Cost center name
        constraints:
          - not_null
      
      cost_center_type:
        type: enum
        description: Type of cost center
        values:
          - production (direct production costs)
          - support (indirect support costs)
          - administrative (overhead)
          - sales (sales & marketing)
        constraints:
          - not_null
      
      gl_account_prefix:
        type: varchar(20)
        description: GL account prefix for this cost center
      
      manager_id:
        type: uuid
        description: Cost center manager
        constraints:
          - foreign_key: users.id
      
      site_id:
        type: uuid
        description: Site this cost center belongs to
        constraints:
          - foreign_key: sites.site_id
      
      is_active:
        type: boolean
        constraints:
          - not_null
          - default: true

  indexes:
    # Standard cost indexes
    - name: idx_std_cost_tenant
      table: standard_costs
      columns: [tenant_id]
      type: btree
    
    - name: idx_std_cost_object
      table: standard_costs
      columns: [tenant_id, cost_object_type, cost_object_code]
      type: btree
    
    - name: idx_std_cost_current
      table: standard_costs
      columns: [tenant_id, is_current, cost_object_type]
      type: btree
      where: is_current = true
    
    - name: idx_std_cost_effective
      table: standard_costs
      columns: [tenant_id, effective_from, effective_to]
      type: btree
    
    - name: idx_std_cost_value_category
      table: standard_costs
      columns: [tenant_id, value_category]
      type: btree
    
    # Cost center indexes
    - name: idx_cost_center_tenant
      table: cost_centers
      columns: [tenant_id]
      type: btree
    
    - name: idx_cost_center_type
      table: cost_centers
      columns: [tenant_id, cost_center_type]
      type: btree

  kpisEnabled:
    critical:
      - cost_variance (actual vs standard)
      - material_price_variance
      - labor_efficiency_variance
    
    high:
      - value_added_ratio
      - non_value_added_cost
      - cost_per_unit_trend
      - overhead_absorption_rate
    
    medium:
      - standard_cost_accuracy
      - cost_center_performance

  relatedEntities:
    - production-order.yaml (uses standard costs for planning)
    - job-cost.yaml (compares actual costs to standard)
    - material-consumption.yaml (material actual vs standard)
    - labor-tracking.yaml (labor actual vs standard)
    - asset-hierarchy.yaml (cost centers map to sites/lines)

  migrationNotes: |
    Standard Cost table enables variance analysis and value stream costing.
    
    Cost Object Types:
    1. Material - standard cost per sheet, pound, roll
    2. Operation - standard cost per hour (press, bindery, etc.)
    3. Equipment Hour - machine hour rate including depreciation
    4. Labor Hour - labor rate by skill level
    5. Overhead - allocation rate (% of direct labor or per unit)
    6. Activity - ABC costing (setup cost, material move cost, etc.)
    
    Variance Analysis:
    - Material: (Actual Qty × Actual Price) - (Actual Qty × Standard Price)
    - Labor: (Actual Hours × Actual Rate) - (Std Hours × Std Rate)
    - Overhead: Actual Overhead - (Std Rate × Actual Activity)
    
    Value-Added Classification:
    - Value-Added: Printing, cutting, folding (customer pays for)
    - Business-Value-Added: Inspection, material handling (necessary overhead)
    - Non-Value-Added: Rework, scrap, excess inventory (eliminate)
    
    Reason Code Financial Mapping:
    - Material Defect → Charge vendor, track supplier quality costs
    - Operator Error → Training opportunity, track by operator
    - Equipment Failure → Maintenance cost, justify replacement
    - Setup Waste → Normal, but track for SMED improvement
    
    Cost Center Mapping:
    - Production cost centers by line (Offset Line 1, Digital Line A)
    - Support cost centers (Maintenance, Quality, Material Handling)
    - Administrative overhead (Sales, Accounting, IT)
    - Used for GL posting and departmental P&L
    
    Blue-Green Deployment:
    - New tables, safe to add
    - Start with material standard costs (from materials.yaml unit_cost)
    - Add operation costs (from equipment hourly rates)
    - Add labor costs (from labor rate tables)
    - Production-order.yaml adds FKs to link standard costs
    - Job-cost.yaml adds variance fields (actual - standard)
