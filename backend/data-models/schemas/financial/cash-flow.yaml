version: '0.1'
metadata:
  domain: financial
  priority: high
  estimatedEffort: 1-week
  blocksKPIs: 10+
  status: draft

entity:
  name: CashFlow
  description: |
    Period-based cash flow tracking for burn rate, DSO, DPO, CCC analysis.
    Essential for cash management and working capital optimization.
    Blocks 10+ cash flow and liquidity KPIs.
  
  tables:
    - name: cash_flows
      description: Period-based cash flow records

  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # Period
    period:
      type: date
      description: Period end date
      constraints:
        - not_null
    
    period_type:
      type: enum
      description: Granularity of cash tracking
      values:
        - day
        - week
        - month
        - quarter
        - year
      constraints:
        - not_null
    
    # Cash Inflows
    cash_inflows_operations:
      type: decimal
      description: Customer payments, collections
      constraints:
        - not_null
        - default: 0
        - check: cash_inflows_operations >= 0
    
    cash_inflows_investing:
      type: decimal
      description: Asset sales, investment returns
      constraints:
        - not_null
        - default: 0
        - check: cash_inflows_investing >= 0
    
    cash_inflows_financing:
      type: decimal
      description: Loans, equity investments
      constraints:
        - not_null
        - default: 0
        - check: cash_inflows_financing >= 0
    
    total_cash_inflows:
      type: decimal
      description: Total cash received
      constraints:
        - not_null
        - check: total_cash_inflows = cash_inflows_operations + cash_inflows_investing + cash_inflows_financing
    
    # Cash Outflows
    cash_outflows_operations:
      type: decimal
      description: Payroll, utilities, materials, rent
      constraints:
        - not_null
        - default: 0
        - check: cash_outflows_operations >= 0
    
    cash_outflows_capex:
      type: decimal
      description: Equipment purchases, capital expenditures
      constraints:
        - not_null
        - default: 0
        - check: cash_outflows_capex >= 0
    
    cash_outflows_debt:
      type: decimal
      description: Loan payments, interest
      constraints:
        - not_null
        - default: 0
        - check: cash_outflows_debt >= 0
    
    total_cash_outflows:
      type: decimal
      description: Total cash spent
      constraints:
        - not_null
        - check: total_cash_outflows = cash_outflows_operations + cash_outflows_capex + cash_outflows_debt
    
    # Net Position
    net_cash_flow:
      type: decimal
      description: Inflows - outflows
      constraints:
        - not_null
        - check: net_cash_flow = total_cash_inflows - total_cash_outflows
    
    opening_balance:
      type: decimal
      description: Cash balance at period start
      constraints:
        - not_null
    
    closing_balance:
      type: decimal
      description: Cash balance at period end
      constraints:
        - not_null
        - check: closing_balance = opening_balance + net_cash_flow
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_cash_flows_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_cash_flows_period
      columns: [tenant_id, period_type, period]
      type: btree
      unique: true
    
    - name: idx_cash_flows_date_range
      columns: [tenant_id, period]
      type: btree
      description: For trend analysis

  kpisEnabled:
    critical:
      - cash_burn_rate
      - cash_reserves_in_days
      - operating_cash_flow
      - free_cash_flow
    
    high:
      - days_sales_outstanding (with AR data)
      - days_payables_outstanding (with AP data)
      - cash_conversion_cycle
      - runway
    
    medium:
      - cash_flow_adequacy_ratio
      - average_days_delinquent
      - overdues_ratio

  relatedEntities:
    - financial-statement.yaml
    - accounts-receivable.yaml
    - accounts-payable.yaml
    - invoice.yaml

  migrationNotes: |
    High priority for Phase 4 - needed for cash management.
    
    Migration Considerations:
    - Unique constraint on (tenant_id, period_type, period)
    - Opening balance of period N must equal closing balance of period N-1
    - Consider trigger to validate balance continuity
    - Daily tracking recommended for burn rate analysis
    
    Data Population:
    - Automated daily/monthly aggregation from transactions
    - Bank reconciliation integration
    - Manual adjustments for accruals
    
    Blue-Green Deployment:
    - New table, safe to add
    - No foreign keys from other tables initially

