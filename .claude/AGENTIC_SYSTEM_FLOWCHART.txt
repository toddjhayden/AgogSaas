================================================================================
                        AGOG AGENTIC SYSTEM FLOWCHART
                     Complete Multi-Agent Workflow System
                  ALL STATES, ERROR PATHS & RECOVERY MECHANISMS
           (Updated with DEPLOYED Gap Fixes - Last Updated: 2025-12-29)
================================================================================

SYSTEM ARCHITECTURE OVERVIEW
================================================================================

agogsaas/
â”œâ”€â”€ project-spirit/
â”‚   â””â”€â”€ owner_requests/
â”‚       â””â”€â”€ OWNER_REQUESTS.md              â† OWNER INPUT (Human adds requirements)
â”‚
â”œâ”€â”€ Implementation/
â”‚   â””â”€â”€ print-industry-erp/
â”‚       â”œâ”€â”€ agent-backend/                 â† AGENT ORCHESTRATION (Docker)
â”‚       â”‚   â”œâ”€â”€ src/
â”‚       â”‚   â”‚   â”œâ”€â”€ orchestration/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ strategic-orchestrator.service.ts    â† Main controller
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ orchestrator.service.ts              â† Workflow manager
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ agent-spawner.service.ts             â† (Not used - broken)
â”‚       â”‚   â”‚   â”œâ”€â”€ agents/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ berry-auto-deploy.service.ts         â† Auto-deployment
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ deployment-executor.service.ts       â† Executes deploys
â”‚       â”‚   â”‚   â””â”€â”€ monitoring/
â”‚       â”‚   â”‚       â””â”€â”€ health-monitor.service.ts            â† System health
â”‚       â”‚   â””â”€â”€ scripts/
â”‚       â”‚       â”œâ”€â”€ start-all-monitoring-services.ts         â† Starts all daemons
â”‚       â”‚       â””â”€â”€ host-agent-listener.ts                   â† Runs on Windows host
â”‚       â”‚
â”‚       â”œâ”€â”€ backend/                       â† APPLICATION (Production ERP)
â”‚       â””â”€â”€ frontend/                      â† APPLICATION (React UI)
â”‚
â”œâ”€â”€ .claude/
â”‚   â”œâ”€â”€ agents/                            â† AGENT DEFINITIONS
â”‚   â”‚   â”œâ”€â”€ cynthia-research.md            â† Stage 1: Research
â”‚   â”‚   â”œâ”€â”€ sylvia-critique.md             â† Stage 2: Critique
â”‚   â”‚   â”œâ”€â”€ roy-backend.md                 â† Stage 3: Backend
â”‚   â”‚   â”œâ”€â”€ jen-frontend.md                â† Stage 4: Frontend
â”‚   â”‚   â”œâ”€â”€ billy-qa.md                    â† Stage 5: QA Testing
â”‚   â”‚   â”œâ”€â”€ priya-statistics.md            â† Stage 6: Statistics (bypassed)
â”‚   â”‚   â””â”€â”€ berry-devops.md                â† Stage 7: DevOps
â”‚   â”‚
â”‚   â”œâ”€â”€ escalations/                       â† ESCALATED WORKFLOWS (Gap Fix #6)
â”‚   â”‚   â””â”€â”€ {reqId}.json                   â† Escalation details
â”‚   â”‚
â”‚   â””â”€â”€ spawned/                           â† SPAWNED AGENT TRACKING (Gap Fix #16)
â”‚       â””â”€â”€ {reqId}.json                   â† Active agent processes
â”‚
â””â”€â”€ docker-compose.agents.yml              â† Agent infrastructure
    â”œâ”€â”€ agent-backend                      â† Orchestration services
    â”œâ”€â”€ nats                               â† Message queue (WORK QUEUE)
    â”œâ”€â”€ agent-postgres                     â† Workflow persistence + fallback
    â””â”€â”€ ollama                             â† Embeddings for memory


================================================================================
REQUIREMENT LIFECYCLE - ALL POSSIBLE STATES
================================================================================

OWNER_REQUESTS.md Status Flow:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    NEW
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                        â”‚
     â–¼                                                        â”‚
IN_PROGRESS â—„â”€â”€â”€ RECOVERY (Gap Fix #2)                      â”‚
     â”‚           (Heartbeat monitor, restart recovery)       â”‚
     â”‚                                                        â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
     â”‚          â”‚          â”‚            â”‚          â”‚         â”‚
     â–¼          â–¼          â–¼            â–¼          â–¼         â”‚
COMPLETE   BLOCKED    FAILED       ERROR    ESCALATED      â”‚
     â”‚          â”‚          â”‚            â”‚          â”‚         â”‚
     â”‚          â”‚          â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
     â”‚          â”‚          â”‚            (Defined action)     â”‚
     â”‚          â”‚          â”‚                                 â”‚
     â”‚          â”‚          â””â”€â”€> RETRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚              (Max 3 retries)
     â”‚          â”‚
     â”‚          â””â”€â”€> SUB-REQUIREMENTS â”€â”€> COMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               (With monitoring recovery)
     â”‚
     â””â”€â”€> (Final state)


*** IMPORTANT: OWNER_REQUESTS.md contains ONLY status of owner requirements ***
*** Sub-requirements exist ONLY in NATS, never written to this file ***


NATS Workflow States (in agog.workflows.state.{reqId}):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PENDING         â†’ Requirement created, not yet started
ACTIVE          â†’ Workflow currently executing
STAGE_RUNNING   â†’ Agent currently working on stage
STAGE_COMPLETE  â†’ Stage finished successfully
STAGE_FAILED    â†’ Stage failed (non-blocking)
STAGE_ERROR     â†’ Stage encountered error (blocking)
STAGE_TIMEOUT   â†’ Stage exceeded timeout
BLOCKED         â†’ Sylvia blocked workflow (awaiting sub-requirements)
PAUSED          â†’ Manually paused by orchestrator
RESUMING        â†’ Resuming from blocked/paused state
COMPLETED       â†’ All stages successful
FAILED          â†’ Workflow failed (non-recoverable)
ESCALATED       â†’ Human intervention required (Gap Fix #6)
STALE           â†’ No heartbeat, likely stuck (Gap Fix #5)


================================================================================
AGENT TIMEOUT SETTINGS (Gap Fix #1)
================================================================================

*** ALL TIMEOUTS REDUCED FOR AGENT SPEED (Not human speed) ***

Cynthia (Research):        45 minutes
Sylvia (Critique):         30 minutes
Roy (Backend):             60 minutes (1 hour)
Jen (Frontend):            60 minutes (1 hour)
Billy (QA Testing):        45 minutes
Priya (Statistics):        30 minutes (optional, usually bypassed)
Berry (Deployment):        15 minutes

*** WORKFLOW MAXIMUM DURATION (Gap Fix #3): 8 hours total ***
*** HEARTBEAT TIMEOUT (Gap Fix #5): 30 minutes ***


================================================================================
STRATEGIC ORCHESTRATOR STARTUP - RECOVERY PROCESS (Gap Fix #4)
================================================================================

When Strategic Orchestrator starts (initialize()):

1. Connect to NATS and PostgreSQL
   â””â”€â”€ If connection fails â†’ Retry 5 times, exit if all fail

2. Recover In-Progress Workflows (Gap Fix #2)
   â”œâ”€â”€ Scan OWNER_REQUESTS.md for status = IN_PROGRESS
   â”œâ”€â”€ For each IN_PROGRESS requirement:
   â”‚   â”œâ”€â”€ Query NATS: agog.workflows.state.{reqId}
   â”‚   â”‚   â”œâ”€â”€ State exists â†’ Resume monitoring
   â”‚   â”‚   â””â”€â”€ State missing â†’ Restart workflow from beginning
   â”‚   â””â”€â”€ Rebuild heartbeat monitoring
   â””â”€â”€ Log: "Recovered N in-progress workflows"

3. Recover Blocked Workflows (Gap Fix #8)
   â”œâ”€â”€ Scan OWNER_REQUESTS.md for status = BLOCKED
   â”œâ”€â”€ For each BLOCKED requirement:
   â”‚   â”œâ”€â”€ Query NATS: agog.workflows.sub-requirements.{reqId}
   â”‚   â”œâ”€â”€ Get list of sub-requirements and completion status
   â”‚   â”œâ”€â”€ Rebuild subscription: subscribeToSubRequirementCompletions()
   â”‚   â””â”€â”€ If all sub-requirements already complete â†’ Resume parent
   â””â”€â”€ Log: "Recovered N blocked workflows"

4. Reconcile State Inconsistencies (Gap Fix #13)
   â”œâ”€â”€ For each requirement in OWNER_REQUESTS.md:
   â”‚   â”œâ”€â”€ Query NATS: agog.workflows.state.{reqId}
   â”‚   â”œâ”€â”€ If NATS state != file state:
   â”‚   â”‚   â”œâ”€â”€ NATS is source of truth
   â”‚   â”‚   â””â”€â”€ Update OWNER_REQUESTS.md to match NATS
   â”‚   â””â”€â”€ Log discrepancies
   â””â”€â”€ Log: "Reconciled N state inconsistencies"

5. Publish Pending Sub-Requirements (Gap Fix #15)
   â”œâ”€â”€ Query PostgreSQL: sub_requirements_pending table
   â”œâ”€â”€ For each pending sub-requirement:
   â”‚   â”œâ”€â”€ Attempt publish to NATS
   â”‚   â”œâ”€â”€ If success â†’ Mark published in PostgreSQL
   â”‚   â””â”€â”€ If fail â†’ Log, will retry next cycle
   â””â”€â”€ Log: "Published N pending sub-requirements"

6. Start Background Daemons
   â”œâ”€â”€ scanOwnerRequests() - Every 60 seconds
   â”œâ”€â”€ progressInProgressWorkflows() - Every 30 seconds
   â”œâ”€â”€ checkWorkflowHeartbeats() - Every 2 minutes (Gap Fix #5)
   â””â”€â”€ reconcileWorkflowStates() - Every 5 minutes (Gap Fix #13)

7. Subscribe to NATS Events
   â”œâ”€â”€ agog.orchestration.events.stage.blocked
   â”œâ”€â”€ agog.orchestration.events.workflow.completed
   â””â”€â”€ agog.requirements.sub.new

8. Ready
   â””â”€â”€ Log: "Strategic Orchestrator ready - monitoring N active workflows"


================================================================================
WORKFLOW EXECUTION - WITH RECOVERY MECHANISMS
================================================================================

*** CONCURRENCY LIMIT (Gap Fix #12): Maximum 5 concurrent workflows ***

Strategic Orchestrator scans OWNER_REQUESTS.md (every 60s):
â”‚
â”œâ”€â”€ Find all NEW requirements
â”œâ”€â”€ Sort by priority: P0 > P1 > P2 > P3
â”‚
â”œâ”€â”€ For each NEW requirement (in priority order):
â”‚   â”‚
â”‚   â”œâ”€â”€ Check concurrency: activeWorkflows.size < 5
â”‚   â”‚   â”œâ”€â”€ At limit â†’ Skip, will retry next scan
â”‚   â”‚   â””â”€â”€ Below limit â†’ Proceed
â”‚   â”‚
â”‚   â”œâ”€â”€ Validate requirement format
â”‚   â”‚   â”œâ”€â”€ Valid â†’ Continue
â”‚   â”‚   â””â”€â”€ Invalid â†’ Set status: ERROR, log issue
â”‚   â”‚
â”‚   â”œâ”€â”€ Update status: NEW â†’ IN_PROGRESS
â”‚   â”‚   â””â”€â”€ If update fails â†’ Log error, skip
â”‚   â”‚
â”‚   â”œâ”€â”€ Try: orchestrator.startWorkflow(reqId, title, assignedTo)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ SUCCESS
â”‚   â”‚   â”‚   â”œâ”€â”€ Add to activeWorkflows Set
â”‚   â”‚   â”‚   â”œâ”€â”€ Initialize NATS state: PENDING
â”‚   â”‚   â”‚   â”œâ”€â”€ Set workflow.startTime (for max duration check)
â”‚   â”‚   â”‚   â””â”€â”€ Start heartbeat publishing
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ FAILURE
â”‚   â”‚       â”œâ”€â”€ Log error with full context
â”‚   â”‚       â”œâ”€â”€ Update status: IN_PROGRESS â†’ FAILED
â”‚   â”‚       â”œâ”€â”€ Reason: "Failed to start workflow: {error}"
â”‚   â”‚       â””â”€â”€ Escalate workflow (Gap Fix #6)
â”‚   â”‚
â”‚   â””â”€â”€ Continue to next requirement
â”‚
â””â”€â”€ Log: "Scan complete - {count} workflows started"


*** ORCHESTRATOR SERVICE - executeStage() WITH RECOVERY ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

For each workflow stage:

1. Pre-Stage Checks
   â”œâ”€â”€ Check workflow duration (Gap Fix #3)
   â”‚   â”œâ”€â”€ currentTime - workflow.startTime > 8 hours
   â”‚   â”‚   â”œâ”€â”€ TRUE â†’ Force fail workflow
   â”‚   â”‚   â”‚   â”œâ”€â”€ Update state: FAILED
   â”‚   â”‚   â”‚   â”œâ”€â”€ Reason: "Exceeded maximum workflow duration (8 hours)"
   â”‚   â”‚   â”‚   â””â”€â”€ Escalate
   â”‚   â”‚   â””â”€â”€ FALSE â†’ Continue
   â”‚   â”‚
   â”‚   â””â”€â”€ Check heartbeat freshness (Gap Fix #5)
   â”‚       â””â”€â”€ Last heartbeat < 10 minutes ago (healthy)

2. Update Stage State
   â”œâ”€â”€ NATS state: STAGE_RUNNING
   â”œâ”€â”€ Stage metadata: { stage, agentId, startTime, timeout }
   â””â”€â”€ Publish heartbeat immediately

3. Publish Stage Start Event
   â””â”€â”€ agog.orchestration.events.stage.started.{reqId}
       {
         "reqId": "REQ-XXX",
         "stage": N,
         "agentId": "cynthia|sylvia|roy|jen|billy|priya|berry",
         "timeout": <timeout in ms>,
         "timestamp": "..."
       }

4. Wait for Deliverable + Heartbeat Loop
   â”‚
   â”œâ”€â”€ Set timeout: stage-specific (45min to 1hr)
   â”‚
   â”œâ”€â”€ Every 3 minutes: Publish heartbeat (Gap Fix #5)
   â”‚   â””â”€â”€ agog.workflows.heartbeat.{reqId}
   â”‚       { stage, agentId, timestamp }
   â”‚
   â”œâ”€â”€ Wait for: agog.deliverables.{agentId}.{stream}.{reqId}
   â”‚
   â””â”€â”€ Outcomes:
       â”‚
       â”œâ”€â”€ DELIVERABLE RECEIVED
       â”‚   â”‚
       â”‚   â”œâ”€â”€ Validate deliverable schema (Gap Fix #18)
       â”‚   â”‚   â”œâ”€â”€ VALID â†’ Proceed
       â”‚   â”‚   â””â”€â”€ INVALID
       â”‚   â”‚       â”œâ”€â”€ Log error with deliverable content
       â”‚   â”‚       â”œâ”€â”€ Publish: agog.errors.deliverable.{reqId}
       â”‚   â”‚       â”œâ”€â”€ Retry stage once
       â”‚   â”‚       â””â”€â”€ If retry also invalid â†’ Escalate
       â”‚   â”‚
       â”‚   â”œâ”€â”€ Check deliverable.status
       â”‚   â”‚   â”‚
       â”‚   â”‚   â”œâ”€â”€ Status: COMPLETE
       â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”œâ”€â”€ Stage = Sylvia
       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ decision = APPROVE â†’ Next stage
       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ decision = CONDITIONAL_APPROVAL â†’ Next stage with conditions
       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ decision = BLOCK â†’ TRIGGER SUB-REQUIREMENT FLOW
       â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”œâ”€â”€ Stage = Billy
       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ testResult = PASS
       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Berry Auto-Deploy triggered, wait for Berry deliverable
       â”‚   â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ testResult = FAIL (Gap Fix #10)
       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ Check billyfailureCount in workflow metadata
       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ billyfailureCount >= 3
       â”‚   â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ TRUE â†’ Escalate
       â”‚   â”‚   â”‚   â”‚       â”‚   â”‚   â””â”€â”€ "Excessive test failures (3+), manual intervention required"
       â”‚   â”‚   â”‚   â”‚       â”‚   â”‚
       â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ FALSE â†’ Create bug fix sub-requirements
       â”‚   â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ Increment billyfailureCount
       â”‚   â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ Parse failures into categories
       â”‚   â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ Create sub-requirements
       â”‚   â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ Update parent: BLOCKED
       â”‚   â”‚   â”‚   â”‚       â”‚       â””â”€â”€ Monitor sub-requirement completions
       â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â””â”€â”€ Any other stage â†’ Next stage
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€â”€ Status: FAILED
       â”‚   â”‚       â”œâ”€â”€ Update state: STAGE_FAILED
       â”‚   â”‚       â”œâ”€â”€ Log failure reason
       â”‚   â”‚       â”œâ”€â”€ Retry stage once
       â”‚   â”‚       â””â”€â”€ If retry also fails â†’ Escalate
       â”‚   â”‚
       â”‚   â””â”€â”€ Update state: STAGE_COMPLETE
       â”‚       â””â”€â”€ Proceed to next stage
       â”‚
       â”œâ”€â”€ TIMEOUT EXCEEDED
       â”‚   â”‚
       â”‚   â”œâ”€â”€ Stage = Priya (Gap Fix #11)
       â”‚   â”‚   â””â”€â”€ Expected, bypass Priya
       â”‚   â”‚       â””â”€â”€ Proceed to waiting for Berry deliverable
       â”‚   â”‚
       â”‚   â””â”€â”€ Any other stage
       â”‚       â”œâ”€â”€ Log timeout error
       â”‚       â”œâ”€â”€ Update state: STAGE_TIMEOUT
       â”‚       â”œâ”€â”€ Publish: agog.errors.stage.timeout.{reqId}
       â”‚       â”œâ”€â”€ Retry stage once
       â”‚       â””â”€â”€ If retry also times out â†’ Escalate
       â”‚
       â”œâ”€â”€ NATS CONNECTION LOST
       â”‚   â”œâ”€â”€ Attempt reconnection (5 retries, exponential backoff)
       â”‚   â”œâ”€â”€ SUCCESS â†’ Resume waiting for deliverable
       â”‚   â””â”€â”€ FAILURE (Gap Fix #15)
       â”‚       â”œâ”€â”€ Update state: ERROR
       â”‚       â”œâ”€â”€ Store workflow state in PostgreSQL (fallback persistence)
       â”‚       â””â”€â”€ Escalate: "NATS unavailable, workflow suspended"
       â”‚
       â””â”€â”€ AGENT ERROR EVENT RECEIVED (Gap Fix #9)
           â”œâ”€â”€ Received: agog.errors.agent.{agentId}
           â”‚   { reqId, error: "TIMEOUT|CRASH|CLI_NOT_FOUND|NATS_UNAVAILABLE", ... }
           â”‚
           â”œâ”€â”€ Error = CLI_NOT_FOUND
           â”‚   â””â”€â”€ Escalate immediately: "Claude CLI not available on host"
           â”‚
           â”œâ”€â”€ Error = NATS_UNAVAILABLE
           â”‚   â””â”€â”€ Wait for NATS recovery, don't retry agent
           â”‚
           â””â”€â”€ Error = CRASH or TIMEOUT
               â”œâ”€â”€ Retry stage once (may have been transient)
               â””â”€â”€ If retry also fails â†’ Escalate


*** HEARTBEAT MONITORING DAEMON (Gap Fix #5) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Runs every 5 minutes:

1. Query NATS: agog.workflows.heartbeat.> (all heartbeats)
2. Get list of all ACTIVE workflows from NATS
3. For each active workflow:
   â”œâ”€â”€ Check last heartbeat timestamp
   â”œâ”€â”€ If currentTime - lastHeartbeat > 10 minutes:
   â”‚   â”œâ”€â”€ Mark workflow: STALE
   â”‚   â”œâ”€â”€ Log: "Workflow {reqId} is stale (no heartbeat for 10+ min)"
   â”‚   â”œâ”€â”€ Attempt recovery:
   â”‚   â”‚   â”œâ”€â”€ Query workflow state in NATS
   â”‚   â”‚   â”œâ”€â”€ If in valid stage â†’ Restart stage
   â”‚   â”‚   â””â”€â”€ If state corrupted â†’ Escalate
   â”‚   â””â”€â”€ If recovery fails â†’ Escalate
   â””â”€â”€ Else: Workflow healthy


*** ESCALATION MECHANISM (Gap Fix #6) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

escalateWorkflow(reqId, reason, context):

1. Update OWNER_REQUESTS.md
   â””â”€â”€ Status: {current} â†’ ESCALATED

2. Update NATS
   â””â”€â”€ agog.workflows.state.{reqId}: ESCALATED

3. Publish Event
   â””â”€â”€ agog.escalations.{reqId}
       {
         "reqId": "...",
         "reason": "...",
         "previousStatus": "...",
         "context": { ... },
         "timestamp": "...",
         "priority": "CRITICAL|HIGH|MEDIUM"
       }

4. Write Escalation File
   â””â”€â”€ .claude/escalations/{reqId}.json
       (Full workflow history, error logs, deliverables)

5. Log
   â””â”€â”€ "ğŸš¨ ESCALATED: {reqId} - {reason}"

6. Future Enhancement: Send Notification
   â””â”€â”€ Email, Slack, PagerDuty, etc.

7. Remove from activeWorkflows Set
   â””â”€â”€ Free up concurrency slot


================================================================================
BLOCKED WORKFLOW & SUB-REQUIREMENTS - WITH RECOVERY
================================================================================

*** SYLVIA BLOCKS - TRIGGER SUB-REQUIREMENT FLOW ***

1. Sylvia Publishes BLOCKED Deliverable
   â””â”€â”€ agog.deliverables.sylvia.critique.{reqId}
       { status: "BLOCKED", decision: "BLOCK", blockers: [...] }

2. Orchestrator Publishes Block Event
   â””â”€â”€ agog.orchestration.events.stage.blocked.{reqId}

3. Strategic Orchestrator Handles Block
   â”‚
   â”œâ”€â”€ handleBlockedCritique(event)
   â”‚   â”‚
   â”‚   â”œâ”€â”€ Check recursion depth (Gap Fix #21)
   â”‚   â”‚   â”œâ”€â”€ Parse reqId for depth: REQ-X-SUB1-SUB2-SUB3
   â”‚   â”‚   â”œâ”€â”€ Count "SUB" occurrences = current depth
   â”‚   â”‚   â”œâ”€â”€ If depth >= 3 (max recursion depth)
   â”‚   â”‚   â”‚   â””â”€â”€> ESCALATE: "Maximum sub-requirement depth (3) exceeded"
   â”‚   â”‚   â”‚        "Requirement too complex, needs human decomposition"
   â”‚   â”‚   â””â”€â”€ If depth < 3 â†’ Proceed
   â”‚   â”‚
   â”‚   â”œâ”€â”€ fetchDeliverableFromNATS()
   â”‚   â”‚   â”œâ”€â”€ SUCCESS â†’ Parse critique
   â”‚   â”‚   â””â”€â”€ FAILURE (Gap Fix #15)
   â”‚   â”‚       â”œâ”€â”€ Retry 3 times
   â”‚   â”‚       â””â”€â”€ If all fail â†’ Escalate
   â”‚   â”‚
   â”‚   â”œâ”€â”€ parseIssuesFromCritique()
   â”‚   â”‚   â”œâ”€â”€ Issues found (1-10) â†’ Proceed
   â”‚   â”‚   â”œâ”€â”€ No issues â†’ Resume workflow (Sylvia error)
   â”‚   â”‚   â””â”€â”€ Too many issues (>10) â†’ Group similar, create max 10
   â”‚   â”‚
   â”‚   â”œâ”€â”€ createSubRequirements() (Gap Fix #21)
   â”‚   â”‚   â”œâ”€â”€ For each issue: Generate sub-requirement object
   â”‚   â”‚   â””â”€â”€ Sub-req ID includes depth: {parentId}-SUB{n}-{timestamp}
   â”‚   â”‚       â””â”€â”€ Example: REQ-X-SUB1-1234 â†’ REQ-X-SUB1-1234-SUB2-5678
   â”‚   â”‚
   â”‚   â”œâ”€â”€ publishSubRequirementsToNATS() (Gap Fix #15)
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€â”€ Try: Publish each to agog.requirements.sub.new
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€â”€ SUCCESS
   â”‚   â”‚   â”‚   â””â”€â”€ Store metadata: agog.workflows.sub-requirements.{parentId}
   â”‚   â”‚   â”‚
   â”‚   â”‚   â””â”€â”€ NATS UNAVAILABLE
   â”‚   â”‚       â”œâ”€â”€ Store in PostgreSQL: sub_requirements_pending table
   â”‚   â”‚       â”‚   { parentReqId, subReqId, title, description, ... }
   â”‚   â”‚       â”œâ”€â”€ Background daemon will publish when NATS available
   â”‚   â”‚       â””â”€â”€ Continue (don't block parent on NATS issue)
   â”‚   â”‚
   â”‚   â”œâ”€â”€ Update OWNER_REQUESTS.md: IN_PROGRESS â†’ BLOCKED
   â”‚   â”‚
   â”‚   â””â”€â”€ subscribeToSubRequirementCompletions() (Gap Fix #8)
   â”‚       â”‚
   â”‚       â””â”€â”€ Persist subscription metadata in NATS
   â”‚           â””â”€â”€ agog.workflows.sub-requirements.{parentId}
   â”‚               {
   â”‚                 parentReqId, subRequirements: [...],
   â”‚                 totalCount, completedCount: 0,
   â”‚                 completedSubRequirements: [],
   â”‚                 createdAt, status: "MONITORING"
   â”‚               }

4. Sub-Requirements Published to NATS
   â””â”€â”€ Each sub-req: agog.requirements.sub.new
       { reqId, title, priority, parent, type, status: "NEW" }

5. Strategic Orchestrator Receives Sub-Requirements
   â”‚
   â””â”€â”€ subscribeToSubRequirements()
       â”œâ”€â”€ On: agog.requirements.sub.new
       â””â”€â”€ Start workflow for each sub-requirement
           â””â”€â”€ Same 7-stage pipeline as parent

6. Monitor Sub-Requirement Completions (Gap Fix #8)
   â”‚
   â””â”€â”€ subscribeToSubRequirementCompletions()
       â”‚
       â”œâ”€â”€ Subscribe: agog.deliverables.berry.devops.>
       â”‚
       â”œâ”€â”€ For each Berry deliverable:
       â”‚   â”œâ”€â”€ Check if reqId in our sub-requirements list
       â”‚   â”œâ”€â”€ If YES:
       â”‚   â”‚   â”œâ”€â”€ Update NATS metadata:
       â”‚   â”‚   â”‚   â”œâ”€â”€ completedCount++
       â”‚   â”‚   â”‚   â””â”€â”€ completedSubRequirements.push(reqId)
       â”‚   â”‚   â”‚
       â”‚   â”‚   â”œâ”€â”€ If completedCount === totalCount:
       â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”œâ”€â”€ All sub-requirements complete
       â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”œâ”€â”€ Try: Resume parent workflow (Gap Fix #7)
       â”‚   â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Update OWNER_REQUESTS.md: BLOCKED â†’ IN_PROGRESS
       â”‚   â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Resume: orchestrator.resumeWorkflowFromStage(parentId, 2)
       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Stage 2 = Roy (backend implementation)
       â”‚   â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Error Handling:
       â”‚   â”‚   â”‚   â”‚       try {
       â”‚   â”‚   â”‚   â”‚         await resumeWorkflowFromStage(...)
       â”‚   â”‚   â”‚   â”‚       } catch (error) {
       â”‚   â”‚   â”‚   â”‚         await updateStatus(parentId, 'FAILED')
       â”‚   â”‚   â”‚   â”‚         await escalateWorkflow(parentId, 'RESUME_FAILED', {error})
       â”‚   â”‚   â”‚   â”‚       }
       â”‚   â”‚   â”‚   â”‚
       â”‚   â”‚   â”‚   â””â”€â”€ Unsubscribe from completions
       â”‚   â”‚   â”‚       â””â”€â”€ Update metadata: status = "COMPLETED"
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€â”€ Else: Continue monitoring
       â”‚   â”‚
       â”‚   â””â”€â”€ If NO: Ignore (different workflow's sub-requirement)
       â”‚
       â””â”€â”€ Timeout Handling:
           â”œâ”€â”€ If no completions after 24 hours â†’ Escalate
           â”‚   â””â”€â”€ "Sub-requirements not completing, possible stuck workflows"
           â””â”€â”€ If some complete but not all after 48 hours â†’ Escalate
               â””â”€â”€ "Partial sub-requirement completion, investigation needed"

7. Recovery on Restart (Gap Fix #8)
   â”‚
   â””â”€â”€ On Strategic Orchestrator restart:
       â”œâ”€â”€ Query NATS: agog.workflows.sub-requirements.{parentId} for all BLOCKED parents
       â”œâ”€â”€ For each with status = "MONITORING":
       â”‚   â”œâ”€â”€ Check completedCount vs totalCount
       â”‚   â”œâ”€â”€ If all complete â†’ Resume parent immediately
       â”‚   â””â”€â”€ If incomplete â†’ Rebuild subscription
       â””â”€â”€ Resume monitoring


================================================================================
7-STAGE WORKFLOW PIPELINE - FULL ERROR HANDLING
================================================================================

*** STAGE 1: RESEARCH (Cynthia) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 45 minutes
Deliverable: agog.deliverables.cynthia.research.{reqId}

Outcomes:
â”œâ”€â”€ SUCCESS (status: COMPLETE)
â”‚   â””â”€â”€> Proceed to STAGE 2 (Sylvia)
â”‚
â”œâ”€â”€ FAILED (status: FAILED)
â”‚   â”œâ”€â”€ Reason: Could not find relevant code / Requirements unclear
â”‚   â”œâ”€â”€ Retry once
â”‚   â””â”€â”€ If retry fails â†’ Escalate

â”œâ”€â”€ TIMEOUT (no deliverable after 45 minutes)
â”‚   â”œâ”€â”€ Retry once with extended timeout (+15 min)
â”‚   â””â”€â”€ If retry times out â†’ Escalate
â”‚
â””â”€â”€ AGENT CRASH/ERROR
    â”œâ”€â”€ Receive: agog.errors.agent.cynthia
    â”œâ”€â”€ Retry once
    â””â”€â”€ If retry crashes â†’ Escalate


*** STAGE 2: CRITIQUE (Sylvia) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 30 minutes
Deliverable: agog.deliverables.sylvia.critique.{reqId}

Outcomes:
â”œâ”€â”€ APPROVE (decision: APPROVE)
â”‚   â””â”€â”€> Proceed to STAGE 3 (Roy)
â”‚
â”œâ”€â”€ CONDITIONAL_APPROVAL (decision: CONDITIONAL_APPROVAL)
â”‚   â”œâ”€â”€ Store conditions in workflow metadata
â”‚   â””â”€â”€> Proceed to STAGE 3 (Roy) with conditions in context
â”‚
â”œâ”€â”€ BLOCK (decision: BLOCK)
â”‚   â””â”€â”€> TRIGGER SUB-REQUIREMENT FLOW (see above)
â”‚       â””â”€â”€ Parent waits for all sub-requirements to complete
â”‚
â”œâ”€â”€ FAILED (status: FAILED)
â”‚   â”œâ”€â”€ Retry once
â”‚   â””â”€â”€ If retry fails â†’ Assume APPROVE (risky fallback, log warning)
â”‚
â”œâ”€â”€ TIMEOUT
â”‚   â”œâ”€â”€ Retry once
â”‚   â””â”€â”€ If retry times out â†’ Assume APPROVE (risky fallback, log warning)
â”‚
â””â”€â”€ AGENT CRASH
    â””â”€â”€ Retry once, then assume APPROVE


*** STAGE 3: BACKEND IMPLEMENTATION (Roy) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 1 hour (60 minutes)
Deliverable: agog.deliverables.roy.backend.{reqId}

Git Safety (Gap Fix #19):
â”œâ”€â”€ Verify git status clean before starting
â”œâ”€â”€ Create feature branch: feature/{reqId}
â”œâ”€â”€ Make all changes on branch
â”œâ”€â”€ Commit changes: git add, git commit
â”œâ”€â”€ If commit fails â†’ Reset to origin/main, report FAILED
â””â”€â”€ Deliverable includes: branch name, commit SHA

Outcomes:
â”œâ”€â”€ SUCCESS (status: COMPLETE)
â”‚   â”œâ”€â”€ Code committed to feature branch
â”‚   â””â”€â”€> Proceed to STAGE 4 (Jen)
â”‚
â”œâ”€â”€ FAILED (status: FAILED)
â”‚   â”œâ”€â”€ Reasons: Build failure, migration failure, circular dependency
â”‚   â”œâ”€â”€ Git rollback: git reset --hard origin/main
â”‚   â”œâ”€â”€ Retry once
â”‚   â””â”€â”€ If retry fails â†’ Escalate
â”‚
â”œâ”€â”€ PARTIAL_SUCCESS (status: COMPLETE with warnings)
â”‚   â”œâ”€â”€ Some features implemented, some deferred
â”‚   â””â”€â”€> Proceed to STAGE 4 (Jen) with notes
â”‚
â”œâ”€â”€ TIMEOUT
â”‚   â”œâ”€â”€ Check git for partial commits
â”‚   â”œâ”€â”€ If work exists â†’ Mark PARTIAL_SUCCESS
â”‚   â””â”€â”€ If no work â†’ Retry once, then escalate
â”‚
â””â”€â”€ GIT OPERATION FAILED (Gap Fix #19)
    â”œâ”€â”€ git commit failed (merge conflict, dirty tree)
    â”œâ”€â”€ Rollback changes
    â”œâ”€â”€ Report FAILED with git error
    â””â”€â”€ Escalate


*** STAGE 4: FRONTEND IMPLEMENTATION (Jen) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 1 hour (60 minutes)
Deliverable: agog.deliverables.jen.frontend.{reqId}

Git Safety (Gap Fix #19):
â””â”€â”€ Same as Roy (feature branch, commit verification)

Outcomes:
â”œâ”€â”€ SUCCESS (status: COMPLETE)
â”‚   â””â”€â”€> Proceed to STAGE 5 (Billy)
â”‚
â”œâ”€â”€ FAILED (status: FAILED)
â”‚   â”œâ”€â”€ Reasons: TypeScript errors, GraphQL mismatch, render errors
â”‚   â”œâ”€â”€ May need Roy to fix backend first
â”‚   â”œâ”€â”€ Retry once
â”‚   â””â”€â”€ If retry fails â†’ Escalate
â”‚
â”œâ”€â”€ BACKEND_ONLY (no frontend needed)
â”‚   â”œâ”€â”€ Minimal/no changes
â”‚   â””â”€â”€> Proceed to STAGE 5 (Billy)
â”‚
â”œâ”€â”€ TIMEOUT
â”‚   â”œâ”€â”€ Check git for partial commits
â”‚   â””â”€â”€ Retry once, then escalate
â”‚
â””â”€â”€ GIT OPERATION FAILED
    â””â”€â”€ Same as Roy


*** STAGE 5: QA TESTING (Billy) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 45 minutes
Deliverable: agog.deliverables.billy.qa.{reqId}

Outcomes:
â”œâ”€â”€ PASS (status: COMPLETE, testResult: PASS)
â”‚   â”‚
â”‚   â”œâ”€â”€ All tests passed
â”‚   â”‚
â”‚   â””â”€â”€> TRIGGER AUTO-DEPLOYMENT (Gap Fix #11)
â”‚       â”œâ”€â”€ Berry Auto-Deploy detects Billy PASS
â”‚       â”œâ”€â”€ Publishes: agog.deliverables.berry.devops.{reqId}
â”‚       â”œâ”€â”€ Orchestrator waits for Berry deliverable (doesn't execute Berry stage)
â”‚       â””â”€â”€ Priya stage: Bypassed (optional background task)
â”‚
â”œâ”€â”€ FAIL (status: COMPLETE, testResult: FAIL) (Gap Fix #10)
â”‚   â”‚
â”‚   â”œâ”€â”€ Check billyfailureCount in workflow metadata
â”‚   â”‚
â”‚   â”œâ”€â”€ billyfailureCount >= 3
â”‚   â”‚   â””â”€â”€> ESCALATE: "Excessive test failures (3+), manual intervention required"
â”‚   â”‚
â”‚   â””â”€â”€ billyfailureCount < 3
â”‚       â”œâ”€â”€ Increment billyfailureCount
â”‚       â”œâ”€â”€ Parse failures into categories:
â”‚       â”‚   â”œâ”€â”€ Backend bugs â†’ Sub-req for Roy
â”‚       â”‚   â”œâ”€â”€ Frontend bugs â†’ Sub-req for Jen
â”‚       â”‚   â”œâ”€â”€ Logic errors â†’ Sub-req for Roy
â”‚       â”‚   â””â”€â”€ UI/UX issues â†’ Sub-req for Jen
â”‚       â”œâ”€â”€ Create bug fix sub-requirements
â”‚       â”œâ”€â”€ Publish to NATS: agog.requirements.sub.new
â”‚       â”œâ”€â”€ Update parent: BLOCKED (test failures)
â”‚       â””â”€â”€ Monitor sub-requirement completions
â”‚           â””â”€â”€ When all complete â†’ Resume from Billy (retest)
â”‚
â”œâ”€â”€ CANNOT_TEST (status: FAILED)
â”‚   â”œâ”€â”€ Reasons: Backend down, database failed, frontend won't load
â”‚   â”œâ”€â”€ Create infrastructure sub-requirement
â”‚   â””â”€â”€ Escalate if critical
â”‚
â”œâ”€â”€ TIMEOUT
â”‚   â”œâ”€â”€ Tests may be running slow
â”‚   â”œâ”€â”€ Check test progress logs
â”‚   â””â”€â”€ Retry with extended timeout or escalate
â”‚
â””â”€â”€ AGENT CRASH
    â””â”€â”€ Retry once, then escalate


*** STAGE 6: STATISTICS (Priya) - OPTIONAL/BYPASSED (Gap Fix #11) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 30 minutes
Status: OPTIONAL - Usually bypassed

Berry Auto-Deploy Bypass Logic:
â”œâ”€â”€ Billy completes â†’ Berry Auto-Deploy immediately publishes Berry deliverable
â”œâ”€â”€ Orchestrator waits for Berry deliverable (not for Priya)
â”œâ”€â”€ Priya runs in background if time permits (not required)
â””â”€â”€ No duplicate Berry execution (Berry deliverable already published)

Outcomes:
â”œâ”€â”€ SUCCESS â†’ Stats generated (nice to have)
â”œâ”€â”€ TIMEOUT â†’ Expected, no action needed
â””â”€â”€ Berry deliverable already published, workflow proceeds


*** STAGE 7: DEVOPS DEPLOYMENT (Berry) - AUTOMATED ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Timeout: 15 minutes
Deliverable: agog.deliverables.berry.devops.{reqId}

Auto-Deployment Flow (Gap Fix #11):
â”‚
â”œâ”€â”€ Berry Auto-Deploy Service
â”‚   â”œâ”€â”€ Subscribes: agog.deliverables.billy.>
â”‚   â”œâ”€â”€ On Billy PASS:
â”‚   â”‚   â”œâ”€â”€ Determine deployment type (backend/frontend/database)
â”‚   â”‚   â”œâ”€â”€ Publish deployment instructions
â”‚   â”‚   â””â”€â”€ Publish Berry deliverable (workflow completion)
â”‚   â””â”€â”€ Does NOT execute deployment (just decides)
â”‚
â””â”€â”€ Deployment Executor Service
    â”‚
    â”œâ”€â”€ Subscribes: agog.deployment.backend.restart
    â”‚              agog.deployment.database.refresh
    â”‚
    â”œâ”€â”€ Backend Restart:
    â”‚   â”œâ”€â”€ Execute: docker restart agogsaas-app-backend
    â”‚   â”œâ”€â”€ Wait: 15 seconds for startup
    â”‚   â”œâ”€â”€ Verify: curl http://localhost:4001/health
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ Healthy (200 OK)
    â”‚   â”‚   â”‚   â””â”€â”€ Publish: agog.deployment.status.{reqId} { status: "SUCCESS" }
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ Unhealthy (non-200) (Gap Fix #14)
    â”‚   â”‚       â”œâ”€â”€ AUTOMATIC ROLLBACK:
    â”‚   â”‚       â”‚   â”œâ”€â”€ Git: revert last commit
    â”‚   â”‚       â”‚   â”œâ”€â”€ Docker: restart backend again
    â”‚   â”‚       â”‚   â”œâ”€â”€ Wait: 15 seconds
    â”‚   â”‚       â”‚   â”œâ”€â”€ Verify: Health check
    â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ Healthy â†’ Publish rollback success
    â”‚   â”‚       â”‚   â”‚   â””â”€â”€ Still unhealthy â†’ CRITICAL ESCALATION
    â”‚   â”‚       â”‚   â”‚
    â”‚   â”‚       â”‚   â””â”€â”€ Run smoke tests (Gap Fix #14)
    â”‚   â”‚       â”‚       â”œâ”€â”€ Test critical APIs
    â”‚   â”‚       â”‚       â”œâ”€â”€ Test database connection
    â”‚   â”‚       â”‚       â”œâ”€â”€ Pass â†’ Rollback verified
    â”‚   â”‚       â”‚       â””â”€â”€ Fail â†’ CRITICAL ESCALATION
    â”‚   â”‚       â”‚
    â”‚   â”‚       â””â”€â”€ Publish: agog.deployment.status.{reqId} { status: "ROLLED_BACK" }
    â”‚   â”‚
    â”‚   â””â”€â”€ Container not found â†’ Escalate (infrastructure issue)
    â”‚
    â”œâ”€â”€ Database Migration (Gap Fix #20)
    â”‚   â”œâ”€â”€ Execute in transaction:
    â”‚   â”‚   BEGIN;
    â”‚   â”‚   <migration SQL>
    â”‚   â”‚   COMMIT;
    â”‚   â”‚
    â”‚   â”œâ”€â”€ On success â†’ Publish: agog.deployment.status.{reqId} { status: "SUCCESS" }
    â”‚   â”‚
    â”‚   â””â”€â”€ On error
    â”‚       â”œâ”€â”€ Automatic ROLLBACK (transaction)
    â”‚       â”œâ”€â”€ Log error
    â”‚       â””â”€â”€ Escalate: "Migration failed, rolled back"
    â”‚
    â””â”€â”€ Deployment Failure Handling
        â”œâ”€â”€ Deployment fails â†’ Rollback (Gap Fix #14)
        â”œâ”€â”€ Rollback succeeds â†’ Log, notify
        â””â”€â”€ Rollback fails â†’ CRITICAL ESCALATION to human


================================================================================
HOST AGENT LISTENER - CRASH RECOVERY (Gap Fix #16)
================================================================================

When Host Listener starts:

1. Recover Spawned Agents
   â”œâ”€â”€ Read directory: .claude/spawned/
   â”œâ”€â”€ For each {reqId}.json:
   â”‚   â”œâ”€â”€ Parse: { reqId, agentId, pid, startTime, stage }
   â”‚   â”œâ”€â”€ Check if process still running (Windows: tasklist /FI "PID eq {pid}")
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€â”€ Running
   â”‚   â”‚   â”‚   â”œâ”€â”€ Check runtime: currentTime - startTime
   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ < 2 hours â†’ Resume monitoring
   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ > 2 hours â†’ Kill process (likely stuck), cleanup file
   â”‚   â”‚   â”‚
   â”‚   â”‚   â””â”€â”€ Not running
   â”‚   â”‚       â””â”€â”€ Cleanup file (agent completed or crashed)
   â”‚   â”‚
   â”‚   â””â”€â”€ Log recovery actions
   â”‚
   â””â”€â”€ Ready to spawn new agents

2. Persist Agent Spawns
   â”œâ”€â”€ Before spawning: Write .claude/spawned/{reqId}.json
   â”œâ”€â”€ After completion: Delete file
   â””â”€â”€ On crash: Files remain for recovery


When spawning agent:

1. Write metadata:
   â””â”€â”€ .claude/spawned/{reqId}.json
       {
         "reqId": "...",
         "agentId": "cynthia|sylvia|...",
         "pid": 12345,
         "startTime": "...",
         "stage": 0,
         "timeout": 2700000
       }

2. Spawn: claude --agent .claude/agents/{agentId}.md --print
   â””â”€â”€ Environment: REQ_ID, NATS_URL, TIMEOUT

3. Monitor process outcomes:
   â”‚
   â”œâ”€â”€ SUCCESS (exit code 0)
   â”‚   â”œâ”€â”€ Agent published deliverable
   â”‚   â””â”€â”€ Cleanup: Delete .claude/spawned/{reqId}.json
   â”‚
   â”œâ”€â”€ TIMEOUT (exit code 124)
   â”‚   â”œâ”€â”€ Process killed after timeout
   â”‚   â”œâ”€â”€ Publish: agog.errors.agent.{agentId} { error: "TIMEOUT" }
   â”‚   â””â”€â”€ Cleanup file
   â”‚
   â”œâ”€â”€ CRASH (exit code > 0, != 124, != 127)
   â”‚   â”œâ”€â”€ Publish: agog.errors.agent.{agentId} { error: "CRASH", exitCode, stderr }
   â”‚   â””â”€â”€ Cleanup file
   â”‚
   â”œâ”€â”€ CLI_NOT_FOUND (exit code 127)
   â”‚   â”œâ”€â”€ Publish: agog.errors.agent.{agentId} { error: "CLI_NOT_FOUND" }
   â”‚   â””â”€â”€ Cleanup file (escalation will occur in orchestrator)
   â”‚
   â””â”€â”€ NATS_UNAVAILABLE (agent couldn't publish)
       â””â”€â”€ Publish: agog.errors.agent.{agentId} { error: "NATS_UNAVAILABLE" }


================================================================================
STATE RECONCILIATION DAEMON (Gap Fix #13)
================================================================================

Runs every 10 minutes:

1. Reconcile Workflow States
   â”œâ”€â”€ Read all requirements from OWNER_REQUESTS.md
   â”œâ”€â”€ For each requirement:
   â”‚   â”œâ”€â”€ Query NATS: agog.workflows.state.{reqId}
   â”‚   â”‚
   â”‚   â”œâ”€â”€ NATS state != file state
   â”‚   â”‚   â”œâ”€â”€ NATS is source of truth
   â”‚   â”‚   â”œâ”€â”€ Update OWNER_REQUESTS.md to match NATS
   â”‚   â”‚   â””â”€â”€ Log: "Reconciled {reqId}: {fileState} â†’ {natsState}"
   â”‚   â”‚
   â”‚   â””â”€â”€ NATS state == file state
   â”‚       â””â”€â”€ No action (consistent)
   â”‚
   â””â”€â”€ Log: "Reconciliation complete - updated {count} requirements"

2. Detect Completed Workflows (Gap Fix #17)
   â”œâ”€â”€ Find all IN_PROGRESS in OWNER_REQUESTS.md
   â”œâ”€â”€ For each IN_PROGRESS:
   â”‚   â”œâ”€â”€ Query NATS: agog.workflows.state.{reqId}
   â”‚   â”œâ”€â”€ If NATS state = COMPLETED
   â”‚   â”‚   â””â”€â”€ Update OWNER_REQUESTS.md: IN_PROGRESS â†’ COMPLETE
   â”‚   â”‚       (Catch missed completion events)
   â”‚   â””â”€â”€ Log missed completions
   â”‚
   â””â”€â”€ This prevents workflows getting stuck IN_PROGRESS when they're actually done


================================================================================
AGENT ERROR MONITORING (Gap Fix #9)
================================================================================

Strategic Orchestrator subscribes to: agog.errors.agent.>

On error event:
â”‚
â”œâ”€â”€ Parse: { reqId, agentId, error: "TIMEOUT|CRASH|CLI_NOT_FOUND|...", ... }
â”‚
â”œâ”€â”€ Error = CLI_NOT_FOUND
â”‚   â””â”€â”€ Escalate immediately: "Claude CLI not available on Windows host"
â”‚       (Cannot recover, requires infrastructure fix)
â”‚
â”œâ”€â”€ Error = NATS_UNAVAILABLE
â”‚   â”œâ”€â”€ Don't retry agent (will fail again)
â”‚   â””â”€â”€ Wait for NATS recovery, workflow will resume
â”‚
â”œâ”€â”€ Error = CRASH
â”‚   â”œâ”€â”€ Check if stage already retried
â”‚   â”œâ”€â”€ If not retried â†’ Trigger stage retry
â”‚   â””â”€â”€ If already retried â†’ Escalate with crash logs
â”‚
â””â”€â”€ Error = TIMEOUT
    â”œâ”€â”€ Check if stage already retried
    â”œâ”€â”€ If not retried â†’ Trigger stage retry (with extended timeout)
    â””â”€â”€ If already retried â†’ Escalate

Coordinate with stage timeout:
â””â”€â”€ Ensure agent error retry doesn't conflict with orchestrator stage timeout retry
    (Use workflow metadata to track retry count)


================================================================================
REQ CREATION SOURCES - ALL 4 WAYS REQUIREMENTS ARE CREATED
================================================================================

*** CRITICAL: Understand WHO can create REQs and HOW ***

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        REQ CREATION ARCHITECTURE                             â”‚
â”‚                                                                              â”‚
â”‚  There are FOUR sources of requirements in the AGOG system:                 â”‚
â”‚                                                                              â”‚
â”‚  1. OWNER (Human) â”€â”€â”€â”€â”€â”€â–º OWNER_REQUESTS.md â”€â”€â”€â”€â”€â”€â–º Strategic Orchestrator  â”‚
â”‚     - Todd adds requirements manually                    (scans every 60s)  â”‚
â”‚     - ONLY the owner writes to this file                                    â”‚
â”‚                                                                              â”‚
â”‚  2. AGENTS (Sam, Vic, Berry) â”€â”€â–º agog.requirements.new â”€â”€â–º Strategic Orch.  â”‚
â”‚     - Sam (Senior Auditor) finds audit issues            (subscribes)       â”‚
â”‚     - Vic (Security) finds security vulnerabilities                         â”‚
â”‚     - Berry (DevOps) finds infrastructure issues                            â”‚
â”‚     - Agents publish NEW REQs for issues NOT in current REQ scope           â”‚
â”‚                                                                              â”‚
â”‚  3. SYLVIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º agog.requirements.sub.new â”€â”€â–º Strategic Orch.â”‚
â”‚     - Creates sub-requirements when blocking a workflow   (subscribes)      â”‚
â”‚     - Sub-REQs address specific issues within parent REQ                    â”‚
â”‚                                                                              â”‚
â”‚  4. PROACTIVE DAEMONS â”€â”€â–º agog.recommendations.* â”€â”€â–º RecommendationPublisherâ”‚
â”‚     - Value Chain Expert, Marcus, Sarah publish           â”‚                 â”‚
â”‚     - RecommendationPublisher writes to OWNER_REQUESTS.md (human approval)  â”‚
â”‚     - Owner must approve before workflow starts                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


*** SOURCE 1: OWNER_REQUESTS.md (Owner Only) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WHO:        Todd (Product Owner) - ONLY human
WRITES TO:  project-spirit/owner_requests/OWNER_REQUESTS.md
CONSUMED:   Strategic Orchestrator scans every 60 seconds
RESULT:     Creates new workflow for each NEW requirement

Flow:
    Todd writes REQ in OWNER_REQUESTS.md
           â”‚
           â–¼
    Strategic Orchestrator scans (every 60s)
           â”‚
           â–¼
    Finds NEW status â†’ startWorkflow(reqId)
           â”‚
           â–¼
    7-stage pipeline: Cynthia â†’ Sylvia â†’ Roy â†’ Jen â†’ Billy â†’ Priya â†’ Berry


*** SOURCE 2: agog.requirements.new (Agent-Created) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WHO:        Sam (Senior Auditor), Vic (Security), Berry (DevOps)
PUBLISHES:  agog.requirements.new
CONSUMED:   Strategic Orchestrator subscribes
RESULT:     Creates new workflow immediately (no owner approval needed)

When to use:
â”œâ”€â”€ Agent finds issue NOT related to current REQ scope
â”œâ”€â”€ Pre-existing problems in codebase
â”œâ”€â”€ System-wide security/infrastructure concerns
â””â”€â”€ DO NOT block current REQ for unrelated issues

Example (Vic finds hardcoded secrets during security scan):
```typescript
nc.publish('agog.requirements.new', JSON.stringify({
  req_number: `REQ-SECURITY-VIC-${Date.now()}`,
  title: 'Fix hardcoded secrets in 24 files',
  priority: 'CRITICAL',
  source: 'vic-security-scan',
  discovered_during: 'REQ-XXX-YYY'  // Original REQ still completes
}));
```

Flow:
    Agent publishes to agog.requirements.new
           â”‚
           â–¼
    Strategic Orchestrator receives (subscribed)
           â”‚
           â–¼
    startWorkflow(reqId) immediately
           â”‚
           â–¼
    New 7-stage pipeline (separate from original workflow)


*** SOURCE 3: agog.requirements.sub.new (Sylvia Sub-Requirements) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WHO:        Sylvia (Critique) - via handleBlockedCritique()
PUBLISHES:  agog.requirements.sub.new
CONSUMED:   Strategic Orchestrator subscribes
RESULT:     Creates sub-workflows, parent waits for all to complete

When to use:
â”œâ”€â”€ Sylvia blocks a workflow due to quality/completeness issues
â”œâ”€â”€ Issues are WITHIN the current REQ scope
â”œâ”€â”€ Parent REQ becomes BLOCKED until all sub-REQs complete
â””â”€â”€ Max recursion depth: 3 levels

Flow:
    Sylvia blocks workflow (decision: BLOCK)
           â”‚
           â–¼
    handleBlockedCritique() parses issues
           â”‚
           â–¼
    Creates sub-requirements â†’ publishes to agog.requirements.sub.new
           â”‚
           â–¼
    Parent status: IN_PROGRESS â†’ BLOCKED
           â”‚
           â–¼
    Sub-REQs complete â†’ Parent resumes from Stage 2 (Roy)


*** SOURCE 4: agog.recommendations.* (Proactive Daemon Recommendations) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WHO:        Value Chain Expert, Marcus, Sarah, other proactive daemons
PUBLISHES:  agog.recommendations.strategic, agog.recommendations.inventory, etc.
CONSUMED:   RecommendationPublisher service subscribes
RESULT:     Appends to OWNER_REQUESTS.md (REQUIRES owner approval)

When to use:
â”œâ”€â”€ Daemons identify opportunities for improvement
â”œâ”€â”€ Recommendations need human review before action
â”œâ”€â”€ Strategic suggestions based on metrics/analysis
â””â”€â”€ Owner must manually approve (change NEW status) to start workflow

Flow:
    Proactive daemon generates recommendation
           â”‚
           â–¼
    Publishes to agog.recommendations.{domain}
           â”‚
           â–¼
    RecommendationPublisher receives (subscribed)
           â”‚
           â–¼
    Appends to OWNER_REQUESTS.md with status: NEW
           â”‚
           â–¼
    Owner reviews, approves (no change needed, or modifies)
           â”‚
           â–¼
    Strategic Orchestrator picks up on next scan


*** DECISION MATRIX: Which Source to Use ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

| Scenario | Use | Reason |
|----------|-----|--------|
| Issue IN current REQ scope | `loop_back_to` | Return to previous agent |
| Issue NOT in current REQ (agent) | agog.requirements.new | New workflow, don't block |
| Sylvia blocks quality issues | agog.requirements.sub.new | Sub-requirements |
| Strategic recommendation | agog.recommendations.* | Needs owner approval |
| Human wants new feature | OWNER_REQUESTS.md | Owner writes directly |


================================================================================
CRITICAL ARCHITECTURE PRINCIPLES
================================================================================

*** 1. OWNER_REQUESTS.md = OWNER INPUT + RECOMMENDATIONS ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”œâ”€â”€ Contains: Human-created requirements + daemon recommendations
â”œâ”€â”€ Recommendations: Appended by RecommendationPublisher (needs owner approval)
â”œâ”€â”€ NOT for direct agent-created requirements (use agog.requirements.new)
â”œâ”€â”€ NOT for sub-requirements (use agog.requirements.sub.new)
â”‚
â””â”€â”€ Status flow: NEW â†’ IN_PROGRESS â†’ BLOCKED/COMPLETE/FAILED/ERROR/ESCALATED
    â””â”€â”€ NATS is source of truth (Gap Fix #13), file updated async


*** 2. NATS = SYSTEM WORK QUEUE & SOURCE OF TRUTH (Gap Fix #13) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”œâ”€â”€ All work lives here (owner requirements + sub-requirements + agent-created)
â”œâ”€â”€ Priority managed in NATS (P0/P1/P2/P3)
â”œâ”€â”€ Status tracked in NATS (canonical state)
â”œâ”€â”€ Dependencies managed in NATS (parent/child relationships)
â”‚
â””â”€â”€ Subjects:
    â”œâ”€â”€ agog.requirements.new                  â† Agent-created REQs (Sam, Vic, Berry)
    â”œâ”€â”€ agog.requirements.sub.new              â† Sub-requirements (Sylvia)
    â”œâ”€â”€ agog.recommendations.*                 â† Daemon recommendations â†’ OWNER_REQUESTS.md
    â”œâ”€â”€ agog.workflows.state.{reqId}           â† Canonical workflow state
    â”œâ”€â”€ agog.workflows.heartbeat.{reqId}       â† Heartbeat (Gap Fix #5)
    â”œâ”€â”€ agog.workflows.sub-requirements.{id}   â† Sub-req metadata (Gap Fix #8)
    â”œâ”€â”€ agog.orchestration.events.*            â† Workflow events
    â”œâ”€â”€ agog.deliverables.*                    â† Agent deliverables
    â”œâ”€â”€ agog.deployment.*                      â† Deployment instructions
    â”œâ”€â”€ agog.errors.agent.*                    â† Agent errors (Gap Fix #9)
    â”œâ”€â”€ agog.errors.deliverable.*              â† Deliverable validation errors (Gap Fix #18)
    â””â”€â”€ agog.escalations.*                     â† Escalated workflows (Gap Fix #6)


*** 3. POSTGRESQL = FALLBACK PERSISTENCE (Gap Fix #15) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

When NATS unavailable:
â”œâ”€â”€ Store sub_requirements_pending
â”œâ”€â”€ Store workflow state snapshots
â””â”€â”€ Background daemon publishes to NATS when available


*** 4. SUB-REQUIREMENTS = NATS ONLY ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Never written to OWNER_REQUESTS.md
System-generated work items only


*** 5. ERROR ESCALATION ALWAYS DEFINED (Gap Fix #6) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Every error path has explicit escalation:
â”œâ”€â”€ Update status â†’ ESCALATED
â”œâ”€â”€ Publish event â†’ agog.escalations.{reqId}
â”œâ”€â”€ Write file â†’ .claude/escalations/{reqId}.json
â””â”€â”€ Future: Notify human


*** 6. RECOVERY MECHANISMS EVERYWHERE ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”œâ”€â”€ Orchestrator restart â†’ Recover all workflows (Gap Fix #2, #4, #8)
â”œâ”€â”€ Heartbeat monitoring â†’ Detect stuck workflows (Gap Fix #5)
â”œâ”€â”€ State reconciliation â†’ Fix desync (Gap Fix #13)
â”œâ”€â”€ Host Listener crash â†’ Recover spawned agents (Gap Fix #16)
â””â”€â”€ NATS unavailable â†’ Fallback persistence (Gap Fix #15)


*** 7. MAXIMUM LIMITS (Gap Fix #3, #10, #12, #21) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”œâ”€â”€ Max workflow duration: 8 hours
â”œâ”€â”€ Max Billy retries: 3 failures
â”œâ”€â”€ Max concurrent workflows: 5
â””â”€â”€ Max sub-requirement recursion depth: 3 levels


================================================================================
RUNNING SERVICES (Updated 2025-12-29)
================================================================================

Docker: agogsaas-agents-backend (10 services)
â”‚
â”œâ”€â”€ CORE SERVICES (Monitoring & Execution)
â”‚   â”‚
â”‚   â”œâ”€â”€ Strategic Orchestrator Daemon
â”‚   â”‚   â”œâ”€â”€ scanOwnerRequests() - Every 60s
â”‚   â”‚   â”œâ”€â”€ progressInProgressWorkflows() - Every 30s
â”‚   â”‚   â”œâ”€â”€ checkWorkflowHeartbeats() - Every 2min (Gap Fix #5)
â”‚   â”‚   â”œâ”€â”€ reconcileWorkflowStates() - Every 5min (Gap Fix #13)
â”‚   â”‚   â”œâ”€â”€ subscribeToBlockedWorkflows() - Event-driven
â”‚   â”‚   â”œâ”€â”€ subscribeToWorkflowCompletions() - Event-driven
â”‚   â”‚   â”œâ”€â”€ subscribeToSubRequirements() - Event-driven
â”‚   â”‚   â””â”€â”€ subscribeToAgentErrors() - Event-driven (Gap Fix #9)
â”‚   â”‚
â”‚   â”œâ”€â”€ Orchestrator Service
â”‚   â”‚   â”œâ”€â”€ Manages 7-stage workflow pipeline
â”‚   â”‚   â”œâ”€â”€ Deliverable validation (Gap Fix #18)
â”‚   â”‚   â””â”€â”€ Billy retry limit enforcement (Gap Fix #10)
â”‚   â”‚
â”‚   â”œâ”€â”€ Berry Auto-Deploy Service
â”‚   â”‚   â””â”€â”€ Listens for Billy PASS, publishes Berry deliverable
â”‚   â”‚
â”‚   â”œâ”€â”€ Deployment Executor
â”‚   â”‚   â””â”€â”€ Executes deployments
â”‚   â”‚
â”‚   â””â”€â”€ Health Monitor Service
â”‚       â””â”€â”€ System health checks
â”‚
â””â”€â”€ PROACTIVE DAEMONS (Work Generators - Added 2025-12-29)
    â”‚
    â”œâ”€â”€ Metrics Provider
    â”‚   â”œâ”€â”€ Publishes business metrics every 5 minutes
    â”‚   â””â”€â”€ Publishes to: agog.metrics.*
    â”‚
    â”œâ”€â”€ Recommendation Publisher
    â”‚   â”œâ”€â”€ Subscribes to: agog.recommendations.* (strategic, inventory, sales, procurement)
    â”‚   â”œâ”€â”€ Appends recommendations to OWNER_REQUESTS.md
    â”‚   â””â”€â”€ Commits changes to git
    â”‚
    â”œâ”€â”€ Recovery & Health Check Daemon
    â”‚   â”œâ”€â”€ Runs immediately on startup, then every 5 hours
    â”‚   â”œâ”€â”€ Detects stuck workflows, recovers them
    â”‚   â””â”€â”€ Checks NATS connectivity (Docker-aware)
    â”‚
    â”œâ”€â”€ Value Chain Expert Daemon
    â”‚   â”œâ”€â”€ Runs 5 minutes after startup, then every 5 hours
    â”‚   â”œâ”€â”€ DOCKER MODE: Publishes to agog.agent.requests.value-chain-expert
    â”‚   â”‚   â””â”€â”€ Host Listener picks up and spawns strategic-recommendation-generator
    â”‚   â””â”€â”€ HOST MODE: Spawns agent directly via Claude CLI
    â”‚
    â”œâ”€â”€ Marcus (Product Owner - Inventory Domain)
    â”‚   â”œâ”€â”€ Monitors inventory metrics via NATS
    â”‚   â””â”€â”€ Generates feature recommendations for inventory improvements
    â”‚
    â””â”€â”€ Sarah (Product Owner - Sales Domain)
        â”œâ”€â”€ Monitors sales metrics via NATS
        â””â”€â”€ Generates feature recommendations for sales improvements

Windows Host:
â”‚
â””â”€â”€ Host Agent Listener
    â”œâ”€â”€ Subscribes to: agog.orchestration.events.stage.started (workflow stages)
    â”œâ”€â”€ Subscribes to: agog.agent.requests.value-chain-expert (proactive daemon requests)
    â”œâ”€â”€ Spawns Claude CLI agents (cynthia, sylvia, roy, jen, billy, priya, berry)
    â”œâ”€â”€ Spawns strategic-recommendation-generator for value-chain-expert requests
    â”œâ”€â”€ Persists spawned agent metadata (Gap Fix #16)
    â””â”€â”€ Recovers orphaned agents on restart


*** DOCKER/HOST COMMUNICATION (Added 2025-12-29) ***
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Problem: Proactive daemons in Docker cannot spawn Claude CLI (not installed in container)
Solution: Docker publishes requests to NATS, Host Listener spawns agents

Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DOCKER CONTAINER                             â”‚
â”‚  ValueChainExpert detects Docker environment                    â”‚
â”‚  â””â”€â”€ Publishes to: agog.agent.requests.value-chain-expert       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ NATS
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WINDOWS HOST                                 â”‚
â”‚  Host Agent Listener                                            â”‚
â”‚  â””â”€â”€ Receives request                                           â”‚
â”‚  â””â”€â”€ Spawns: claude --agent strategic-recommendation-generator  â”‚
â”‚  â””â”€â”€ Agent generates recommendations â†’ OWNER_REQUESTS.md        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Files involved:
â”œâ”€â”€ agent-backend/src/utils/environment.ts (Docker detection utility)
â”œâ”€â”€ agent-backend/src/proactive/value-chain-expert.daemon.ts (publishes to NATS in Docker)
â””â”€â”€ agent-backend/scripts/host-agent-listener.ts (subscribes and spawns agent)

Docker: agogsaas-agents-nats
â”‚
â””â”€â”€ NATS JetStream (Source of truth - Gap Fix #13)

Docker: agogsaas-agents-postgres
â”‚
â””â”€â”€ PostgreSQL
    â”œâ”€â”€ Workflow persistence
    â”œâ”€â”€ Fallback persistence (Gap Fix #15)
    â””â”€â”€ sub_requirements_pending table


================================================================================
STARTUP COMMANDS (Updated 2025-12-28)
================================================================================

Method 1: Master Script (Recommended)
â”œâ”€â”€ START_SYSTEM.bat
â”‚   â”œâ”€â”€ Starts Docker containers (all daemons)
â”‚   â”œâ”€â”€ Starts Windows Host Listener
â”‚   â””â”€â”€ Shows startup progress
â”‚
â””â”€â”€ STOP_SYSTEM.bat
    â””â”€â”€ Stops everything cleanly

Method 2: Manual
â”œâ”€â”€ Step 1: docker-compose -f docker-compose.agents.yml up -d
â””â”€â”€ Step 2: agent-backend\start-listener.bat

Windows Task Scheduler:
â”œâ”€â”€ Task 1: Docker Containers (at startup)
â”‚   â””â”€â”€ docker-compose -f docker-compose.agents.yml up -d
â”‚
â””â”€â”€ Task 2: Host Listener (30s delay after startup)
    â””â”€â”€ agent-backend\start-listener.bat

Location: D:\GitHub\agogsaas\Implementation\print-industry-erp\


================================================================================
                            END OF FLOWCHART
                   Critical Workflow Gaps DEPLOYED & RUNNING
================================================================================

DEPLOYED Gap Fixes (ACTUALLY RUNNING - Verified 2025-12-29):
1.  âœ… Reduced timeouts to 1 hour or less
2.  âœ… IN_PROGRESS recovery on restart
3.  âœ… Maximum workflow duration (8 hours)
4.  âœ… Orchestrator startup recovery
5.  âœ… Workflow heartbeat monitoring (every 2 min, 30 min timeout)
6.  âœ… Escalation mechanism (status update, NATS event, file logging)
7.  âœ… Parent resumption error handling (try/catch in subscribeToSubRequirementCompletions)
8.  âœ… Sub-requirement monitoring recovery
9.  âœ… Agent error event monitoring (subscribes to agog.errors.agent.>)
10. âœ… Billy retry limit (max 3 failures, then escalate)
11. âœ… Priya bypass race condition (Berry Auto-Deploy handles)
12. âœ… Concurrency limit (max 5 concurrent workflows)
13. âœ… State reconciliation daemon (NATS = source of truth, every 5 min)
17. âœ… Workflow completion polling (handled by reconciliation daemon)
18. âœ… Deliverable validation (schema validation in waitForDeliverable)
21. âœ… Infinite recursion prevention (max depth: 3 levels)
22. âœ… Proactive daemons integrated (ValueChainExpert, Marcus, Sarah, etc.) - 2025-12-29
23. âœ… Docker/Host communication for agent spawning - 2025-12-29
    â””â”€â”€ Docker daemons publish to NATS, Host Listener spawns Claude agents

REMAINING GAPS (Not Deployed - Lower Priority):
14. â¸ï¸ Deployment rollback verification with smoke tests
15. â¸ï¸ NATS unavailable fallback (PostgreSQL)
16. â¸ï¸ Host Listener crash recovery (.claude/spawned tracking)
19. â¸ï¸ Git transaction safety (branch creation, rollback)
20. â¸ï¸ Migration transactionality (BEGIN/COMMIT/ROLLBACK)

Status: 18 of 23 gaps DEPLOYED and RUNNING
        All critical workflow stuck states are now covered
        Proactive work generation now functional
        Remaining gaps are deployment/infrastructure hardening
