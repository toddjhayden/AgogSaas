# AgogSaaS Agent Development System
# This is the DEVELOPMENT-ONLY agent orchestration stack
# NEVER deployed to production - local/CI only
# Use: docker-compose -f docker-compose.agents.yml up -d

services:
  # NATS Jetstream - Agent Communication
  nats:
    image: nats:latest
    container_name: agogsaas-agents-nats
    command:
      - "-c"
      - "/etc/nats/nats-server.conf"
    ports:
      - "4223:4222"  # Client port
      - "8223:8222"  # Monitoring port
    volumes:
      - agents_nats_data:/data
      - ../../infrastructure/nats/nats-server.conf:/etc/nats/nats-server.conf
    restart: unless-stopped
    networks:
      - agents_network

  # Agent PostgreSQL - Memory & Learning Storage
  agent-postgres:
    image: pgvector/pgvector:pg16
    container_name: agogsaas-agents-postgres
    environment:
      POSTGRES_USER: agent_user
      POSTGRES_PASSWORD: agent_dev_password_2024
      POSTGRES_DB: agent_memory
    ports:
      - "5434:5432"  # Different port from app postgres (5433)
    volumes:
      - agents_postgres_data:/var/lib/postgresql/data
      - ./agent-backend/migrations/agent-memory:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agent_user -d agent_memory"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - agents_network

  # Ollama - AI Model Server for Agents
  ollama:
    image: ollama/ollama:latest
    container_name: agogsaas-agents-ollama
    ports:
      - "11434:11434"
    volumes:
      - agents_ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - agents_network

  # SDLC Control - Uses CLOUD API at https://api.agog.fyi
  # No local database needed - all SDLC data is on VPS

  # Agent Backend - Orchestration System
  agent-backend:
    build:
      context: ./agent-backend
      dockerfile: Dockerfile
    container_name: agogsaas-agents-backend
    environment:
      NODE_ENV: development
      # NATS Configuration
      NATS_URL: nats://nats:4222
      NATS_USER: agents
      NATS_PASSWORD: ${NATS_PASSWORD:?NATS_PASSWORD environment variable is required}
      # Agent Memory Database (PostgreSQL + pgvector)
      DATABASE_URL: postgresql://agent_user:agent_dev_password_2024@agent-postgres:5432/agent_memory
      AGENT_DB_HOST: agent-postgres
      AGENT_DB_PORT: 5432
      AGENT_DB_NAME: agent_memory
      AGENT_DB_USER: agent_user
      AGENT_DB_PASSWORD: agent_dev_password_2024
      # SDLC Control - Cloud API (VPS at api.agog.fyi)
      SDLC_API_URL: ${SDLC_API_URL:-https://api.agog.fyi}
      SDLC_AGENT_ID: ${SDLC_AGENT_ID:-local-agent}
      OLLAMA_URL: http://ollama:11434
      # Mount application source code for agents to read/write
      APP_BACKEND_PATH: /workspace/app-backend
      APP_FRONTEND_PATH: /workspace/app-frontend
    ports:
      - "4002:4000"  # Agent orchestrator API
    depends_on:
      nats:
        condition: service_started
      agent-postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    volumes:
      # Agent orchestration code
      - ./agent-backend/src:/app/src
      - ./agent-backend/scripts:/app/scripts
      - ./agent-backend/package.json:/app/package.json
      - agents_backend_node_modules:/app/node_modules
      # Mount application source for agents to modify
      - ./backend:/workspace/app-backend
      - ./frontend:/workspace/app-frontend
      # Agent configuration and memory
      - ../../.claude:/app/.claude
      - ../../project-spirit:/app/project-spirit
      - ./backend/agent-output:/app/agent-output
      # Logs - persisted to host for debugging
      - ./agent-backend/logs:/app/logs
    command: npm run daemon:full
    restart: unless-stopped
    networks:
      - agents_network

volumes:
  agents_nats_data:
    name: agogsaas_agents_nats_data
  agents_postgres_data:
    name: agogsaas_agents_postgres_data
  agents_backend_node_modules:
    name: agogsaas_agents_backend_node_modules
  agents_ollama_data:
    name: agogsaas_agents_ollama_data

networks:
  agents_network:
    name: agogsaas_agents_network
    driver: bridge
