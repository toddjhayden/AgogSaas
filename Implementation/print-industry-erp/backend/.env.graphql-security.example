# GraphQL Query Complexity Control & Security Configuration
# REQ-1767925582666-3sc6l: Implement GraphQL Query Complexity Control & Security Hardening

# ======================================================================
# Query Complexity Limits
# ======================================================================

# Maximum query complexity for public (unauthenticated) users
# Default: 100 (conservative limit for anonymous access)
GRAPHQL_MAX_COMPLEXITY_PUBLIC=100

# Maximum query complexity for authenticated users
# Default: 1000 (standard limit for registered users)
GRAPHQL_MAX_COMPLEXITY=1000

# Maximum query complexity for admin users
# Default: 5000 (elevated limit for administrators)
GRAPHQL_MAX_COMPLEXITY_ADMIN=5000

# Maximum query complexity for system administrators
# Default: 10000 (highest limit for system operations)
GRAPHQL_MAX_COMPLEXITY_SYSTEM=10000

# ======================================================================
# Query Depth Limits
# ======================================================================

# Maximum query depth for public (unauthenticated) users
# Default: 5 (prevents deep nesting attacks)
GRAPHQL_MAX_DEPTH_PUBLIC=5

# Maximum query depth for authenticated users
# Default: 7 (standard depth for complex queries)
GRAPHQL_MAX_DEPTH=7

# Maximum query depth for admin users
# Default: 15 (allows complex administrative queries)
GRAPHQL_MAX_DEPTH_ADMIN=15

# Maximum query depth for system administrators
# Default: 20 (highest depth for system operations)
GRAPHQL_MAX_DEPTH_SYSTEM=20

# ======================================================================
# Security Validation Settings
# ======================================================================

# Require all GraphQL operations to be named
# Default: true in production, false in development
# Named operations improve debugging and monitoring
GRAPHQL_REQUIRE_OPERATION_NAME=true

# Maximum number of mutations per request
# Default: 10 (prevents abuse through mutation batching)
GRAPHQL_MAX_MUTATIONS_PER_REQUEST=10

# Maximum number of field aliases per query
# Default: 15 (prevents alias-based DoS attacks)
GRAPHQL_MAX_ALIASES=15

# Block GraphQL introspection queries
# Default: true in production, false in development
# Introspection can reveal schema information to attackers
GRAPHQL_BLOCK_INTROSPECTION_PRODUCTION=true

# ======================================================================
# Query Execution Timeouts
# ======================================================================

# Query execution timeout for authenticated users (milliseconds)
# Default: 30000 (30 seconds)
GRAPHQL_QUERY_TIMEOUT_MS=30000

# Query execution timeout for admin users (milliseconds)
# Default: 60000 (60 seconds)
GRAPHQL_QUERY_TIMEOUT_ADMIN_MS=60000

# Query execution timeout for system admins (milliseconds)
# Default: 120000 (120 seconds)
GRAPHQL_QUERY_TIMEOUT_SYSTEM_MS=120000

# ======================================================================
# Field Complexity Costs (Advanced Configuration)
# ======================================================================

# Base cost for scalar fields (String, Int, Boolean, etc.)
GRAPHQL_SCALAR_COST=1

# Base cost for object fields
GRAPHQL_OBJECT_COST=2

# Multiplier for list/array fields
# Actual cost = base_cost * list_multiplier * estimated_array_size
GRAPHQL_LIST_MULTIPLIER=10

# ======================================================================
# Performance & Monitoring
# ======================================================================

# Enable complexity tracking in database
# Default: true (stores query metrics for analysis)
GRAPHQL_ENABLE_COMPLEXITY_TRACKING=true

# Complexity log retention period (days)
# Default: 90 days
GRAPHQL_COMPLEXITY_LOG_RETENTION_DAYS=90

# Warn about expensive queries (percentage of limit)
# Default: 0.8 (80% of limit)
# Logs warning when query uses more than this percentage
GRAPHQL_EXPENSIVE_QUERY_THRESHOLD=0.8

# Warn about deep queries (percentage of limit)
# Default: 0.7 (70% of limit)
GRAPHQL_DEEP_QUERY_THRESHOLD=0.7

# ======================================================================
# Development Settings
# ======================================================================

# Enable verbose logging in development
GRAPHQL_DEBUG_COMPLEXITY=false

# Include execution metrics in GraphQL responses (development only)
# Adds "extensions.metrics" to responses
GRAPHQL_INCLUDE_METRICS_IN_RESPONSE=false

# ======================================================================
# Example Configurations by Environment
# ======================================================================

# PRODUCTION (Strict Security)
# GRAPHQL_MAX_COMPLEXITY_PUBLIC=100
# GRAPHQL_MAX_COMPLEXITY=1000
# GRAPHQL_MAX_DEPTH_PUBLIC=5
# GRAPHQL_MAX_DEPTH=7
# GRAPHQL_REQUIRE_OPERATION_NAME=true
# GRAPHQL_BLOCK_INTROSPECTION_PRODUCTION=true

# STAGING (Balanced Security)
# GRAPHQL_MAX_COMPLEXITY_PUBLIC=200
# GRAPHQL_MAX_COMPLEXITY=2000
# GRAPHQL_MAX_DEPTH_PUBLIC=7
# GRAPHQL_MAX_DEPTH=10
# GRAPHQL_REQUIRE_OPERATION_NAME=true
# GRAPHQL_BLOCK_INTROSPECTION_PRODUCTION=false

# DEVELOPMENT (Relaxed Security)
# GRAPHQL_MAX_COMPLEXITY_PUBLIC=500
# GRAPHQL_MAX_COMPLEXITY=5000
# GRAPHQL_MAX_DEPTH_PUBLIC=10
# GRAPHQL_MAX_DEPTH=15
# GRAPHQL_REQUIRE_OPERATION_NAME=false
# GRAPHQL_BLOCK_INTROSPECTION_PRODUCTION=false
# GRAPHQL_DEBUG_COMPLEXITY=true
# GRAPHQL_INCLUDE_METRICS_IN_RESPONSE=true

# ======================================================================
# Security Best Practices
# ======================================================================

# 1. Always use lower limits for public/unauthenticated access
# 2. Enable operation name requirement in production
# 3. Block introspection in production
# 4. Monitor complexity logs regularly
# 5. Adjust limits based on actual usage patterns
# 6. Set timeouts appropriate for your queries
# 7. Use warning thresholds to identify optimization opportunities
# 8. Review and optimize queries that frequently hit limits

# ======================================================================
# Monitoring & Alerting
# ======================================================================

# Set up alerts for:
# - Queries exceeding 80% of complexity limit
# - Queries exceeding 70% of depth limit
# - Blocked queries (complexity/depth violations)
# - High frequency of expensive queries
# - Unusual query patterns (potential attacks)

# Example Prometheus/Grafana queries:
# - rate(graphql_complexity_exceeded_total[5m])
# - histogram_quantile(0.95, graphql_query_complexity_bucket)
# - graphql_query_execution_time_seconds > 10
