# REQ-STRATEGIC-AUTO-1766516942302: Alert Rules
# Agent: Berry (DevOps Specialist)
# Purpose: Alert definitions for bin optimization monitoring

groups:
  - name: bin_optimization_critical
    interval: 1m
    rules:
      # CRITICAL: Cache is stale (>30 minutes)
      - alert: BinCacheStale
        expr: bin_utilization_cache_age_seconds > 1800
        for: 5m
        labels:
          severity: critical
          component: cache
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Bin utilization cache is stale"
          description: "Cache age is {{ $value | humanizeDuration }}, exceeding 30-minute threshold. Recommendations may be outdated."
          remediation: "1. Check pg_cron job status\n2. Manually refresh: SELECT scheduled_refresh_bin_utilization();\n3. Check for database locks or performance issues"
          runbook_url: "https://wiki.example.com/runbooks/bin-cache-stale"

      # CRITICAL: ML Model accuracy below 70%
      - alert: MLModelAccuracyLow
        expr: ml_model_accuracy_percentage < 70
        for: 1h
        labels:
          severity: critical
          component: ml-model
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "ML model accuracy critically low"
          description: "ML model accuracy is {{ $value }}%, below critical threshold of 70%"
          remediation: "1. Review recent feedback data\n2. Check for data quality issues\n3. Retrain model: mutation { trainMLModel }\n4. Consider rollback to baseline algorithm"
          runbook_url: "https://wiki.example.com/runbooks/ml-accuracy-low"

      # CRITICAL: GraphQL endpoint down
      - alert: GraphQLEndpointDown
        expr: up{job="bin-optimization-backend"} == 0
        for: 2m
        labels:
          severity: critical
          component: api
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "GraphQL API endpoint is down"
          description: "Backend service is not responding"
          remediation: "1. Check service status: systemctl status agogsaas-backend\n2. Check logs: journalctl -u agogsaas-backend -n 100\n3. Restart service if needed"
          runbook_url: "https://wiki.example.com/runbooks/api-down"

      # CRITICAL: Database connection failed
      - alert: DatabaseConnectionFailed
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          component: database
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Database connection failed"
          description: "Cannot connect to PostgreSQL database"
          remediation: "1. Check database status: systemctl status postgresql\n2. Check connection limits\n3. Check network connectivity"
          runbook_url: "https://wiki.example.com/runbooks/db-down"

  - name: bin_optimization_warnings
    interval: 5m
    rules:
      # WARNING: Cache age approaching threshold
      - alert: BinCacheDegraded
        expr: bin_utilization_cache_age_seconds > 900 and bin_utilization_cache_age_seconds <= 1800
        for: 5m
        labels:
          severity: warning
          component: cache
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Bin utilization cache is getting stale"
          description: "Cache age is {{ $value | humanizeDuration }}, approaching 30-minute threshold"
          remediation: "Monitor cache refresh job. If age continues to increase, investigate pg_cron job status."

      # WARNING: ML accuracy degraded
      - alert: MLModelAccuracyDegraded
        expr: ml_model_accuracy_percentage >= 70 and ml_model_accuracy_percentage < 80
        for: 2h
        labels:
          severity: warning
          component: ml-model
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "ML model accuracy is degraded"
          description: "ML model accuracy is {{ $value }}%, below target of 80%"
          remediation: "Review feedback patterns. Consider retraining if accuracy doesn't improve within 24 hours."

      # WARNING: Query performance degraded
      - alert: QueryPerformanceSlow
        expr: bin_utilization_query_duration_seconds{quantile="0.95"} > 0.5
        for: 10m
        labels:
          severity: warning
          component: database
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Query performance is degraded"
          description: "P95 query latency is {{ $value }}s, exceeding 500ms threshold"
          remediation: "1. Check database load\n2. Review slow query log\n3. Consider VACUUM or REINDEX on bin_utilization_cache"

      # WARNING: High recommendation rejection rate
      - alert: HighRecommendationRejectionRate
        expr: (1 - (putaway_acceptance_rate_percentage / 100)) > 0.3
        for: 1h
        labels:
          severity: warning
          component: algorithm
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "High recommendation rejection rate detected"
          description: "{{ $value | humanizePercentage }} of recommendations are being rejected"
          remediation: "1. Review rejected recommendations\n2. Check for data quality issues\n3. Gather user feedback\n4. Consider algorithm tuning"

      # WARNING: No recommendations generated recently
      - alert: NoRecentRecommendations
        expr: increase(putaway_recommendations_total[1h]) == 0
        for: 30m
        labels:
          severity: warning
          component: algorithm
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "No putaway recommendations generated recently"
          description: "No recommendations have been generated in the past hour"
          remediation: "1. Check if warehouse is operational\n2. Verify incoming inventory\n3. Check for algorithm errors in logs"

  - name: bin_optimization_performance
    interval: 5m
    rules:
      # WARNING: Batch processing time high
      - alert: BatchProcessingTimeSlow
        expr: batch_putaway_processing_time_ms{quantile="0.95"} > 2000
        for: 15m
        labels:
          severity: warning
          component: algorithm
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Batch putaway processing time is high"
          description: "P95 batch processing time is {{ $value }}ms, exceeding 2000ms target"
          remediation: "1. Check batch size\n2. Review N+1 query patterns\n3. Check database query plans\n4. Consider horizontal scaling"

      # INFO: High cache refresh frequency
      - alert: FrequentCacheRefresh
        expr: rate(bin_utilization_cache_refreshes_total[5m]) > 1
        for: 10m
        labels:
          severity: info
          component: cache
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Cache refresh frequency is high"
          description: "Cache is being refreshed {{ $value }} times per second"
          remediation: "This may indicate high transaction volume. Monitor for performance impact."

  - name: bin_optimization_data_quality
    interval: 1h
    rules:
      # WARNING: High data quality issues
      - alert: DataQualityIssuesDetected
        expr: bin_optimization_data_quality_issues_total > 100
        for: 1h
        labels:
          severity: warning
          component: data-quality
          req: REQ-STRATEGIC-AUTO-1766516942302
        annotations:
          summary: "Data quality issues detected"
          description: "{{ $value }} data quality issues found (missing dimensions, invalid capacities, etc.)"
          remediation: "1. Run data quality audit: npm run audit:data-quality\n2. Review material master data\n3. Update missing dimensions\n4. Fix invalid bin capacities"
          runbook_url: "https://wiki.example.com/runbooks/data-quality"
