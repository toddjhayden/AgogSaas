version: '0.1'
metadata:
  domain: materials
  priority: high
  estimatedEffort: 1-week
  status: draft

entity:
  name: Material
  description: |
    Represents materials used in print production (paper, ink, plates, chemicals).
    Links to inventory management and material consumption tracking.
    Foundation for inventory turnover and material yield KPIs.
  
  tables:
    - name: materials
      description: Material master data
    - name: material_inventory
      description: Current inventory levels by location and lot
      
  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    sku:
      type: string
      description: Stock keeping unit
      constraints:
        - not_null
        - unique: [tenant_id, sku]
        - indexed
    
    name:
      type: string
      description: Material name
      constraints:
        - not_null
    
    description:
      type: text
      description: Detailed material description
    
    material_type:
      type: enum
      description: Type of material
      values:
        - paper
        - ink
        - plate
        - chemical
        - adhesive
        - coating
        - packaging
        - other
      constraints:
        - not_null
        - indexed
    
    # Specifications
    specifications:
      type: jsonb
      description: Material technical specifications
      schema:
        type: object
        properties:
          # Paper specific
          basis_weight: number
          size:
            width: number
            height: number
            unit: string
          color: string
          finish: string
          grain_direction: string
          # Ink specific
          viscosity: number
          drying_time: number
          color_code: string
          # Plate specific
          plate_type: string
          thickness: number
          run_length: number
      constraints:
        - not_null
        - default: "{}"
    
    # Supplier & Costing
    supplier_id:
      type: uuid
      description: Primary supplier
      constraints:
        - foreign_key: vendors.id
    
    unit_of_measure:
      type: string
      description: Unit of measure (sheets, lbs, gallons, etc)
      constraints:
        - not_null
    
    unit_cost:
      type: decimal
      description: Cost per unit
      constraints:
        - check: unit_cost >= 0
    
    minimum_order_quantity:
      type: integer
      description: Minimum order quantity
      constraints:
        - default: 1
        - check: minimum_order_quantity > 0
    
    lead_time_days:
      type: integer
      description: Supplier lead time in days
      constraints:
        - check: lead_time_days >= 0
    
    # Storage Requirements
    storage_requirements:
      type: jsonb
      description: Storage conditions
      schema:
        type: object
        properties:
          temperature:
            min: number
            max: number
            unit: string
          humidity:
            min: number
            max: number
          special_instructions: string
      constraints:
        - default: "{}"
    
    # Safety & Compliance
    is_hazmat:
      type: boolean
      description: Hazardous material flag
      constraints:
        - not_null
        - default: false
    
    msds_url:
      type: string
      description: Material Safety Data Sheet URL
    
    certifications:
      type: jsonb
      description: Material certifications (FSC, ISO, etc)
      schema:
        type: array
        items:
          type: string
      constraints:
        - default: "[]"
    
    # Status
    status:
      type: enum
      description: Material status
      values:
        - active
        - discontinued
        - obsolete
      constraints:
        - not_null
        - default: active
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  # Material Inventory Entity
  inventory:
    name: MaterialInventory
    description: Current inventory levels by location and lot
    
    properties:
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()
      
      tenant_id:
        type: uuid
        description: Multi-tenant isolation
        constraints:
          - not_null
          - foreign_key: tenants.id
          - indexed
      
      material_id:
        type: uuid
        description: Material reference
        constraints:
          - not_null
          - foreign_key: materials.id
          - indexed
      
      location_id:
        type: uuid
        description: Storage location
        constraints:
          - foreign_key: storage_locations.id
      
      lot_number:
        type: string
        description: Lot/batch number for traceability
        constraints:
          - not_null
          - indexed
      
      quantity:
        type: decimal
        description: Current quantity on hand
        constraints:
          - not_null
          - check: quantity >= 0
      
      allocated_quantity:
        type: decimal
        description: Quantity allocated to jobs
        constraints:
          - not_null
          - default: 0
          - check: allocated_quantity >= 0
          - check: allocated_quantity <= quantity
      
      available_quantity:
        type: decimal
        description: Available quantity (quantity - allocated)
        constraints:
          - check: available_quantity >= 0
      
      received_date:
        type: timestamp
        description: Date material received
        constraints:
          - not_null
      
      expiration_date:
        type: timestamp
        description: Expiration date (if applicable)
      
      inventory_status:
        type: enum
        description: Inventory status
        values:
          - available
          - allocated
          - quarantine
          - expired
          - depleted
        constraints:
          - not_null
          - default: available
      
      unit_cost:
        type: decimal
        description: Cost per unit for this lot
        constraints:
          - check: unit_cost >= 0
      
      total_cost:
        type: decimal
        description: Total cost of this inventory lot
        constraints:
          - check: total_cost >= 0
      
      last_count_date:
        type: timestamp
        description: Last physical count date
      
      # Audit Fields
      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP
      
      updated_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP
      
      created_by:
        type: uuid
        constraints:
          - foreign_key: users.id
      
      updated_by:
        type: uuid
        constraints:
          - foreign_key: users.id

  indexes:
    - name: idx_materials_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_materials_sku
      columns: [tenant_id, sku]
      type: btree
      unique: true
    
    - name: idx_materials_type
      columns: [tenant_id, material_type]
      type: btree
    
    - name: idx_inventory_material
      columns: [tenant_id, material_id]
      type: btree
    
    - name: idx_inventory_lot
      columns: [tenant_id, lot_number]
      type: btree
    
    - name: idx_inventory_status
      columns: [tenant_id, inventory_status]
      type: btree

  kpisEnabled:
    high:
      - inventory_turnover_rate
      - material_yield_rate
      - material_waste_percentage
      - stock_to_sales_ratio
    
    medium:
      - days_inventory_outstanding
      - inventory_accuracy
      - obsolete_inventory_percentage

  relatedEntities:
    - material-consumption.yaml
    - purchase-order.yaml
    - unified-inventory.yaml

  migrationNotes: |
    Materials master data with inventory tracking by lot and location.
    Enables inventory turnover, material yield, and waste tracking KPIs.
    
    Migration Considerations:
    - Two tables: materials (master), material_inventory (transactional)
    - JSONB specifications allow material-type-specific attributes
    - Unique constraint on (tenant_id, sku)
    - Index on lot_number for traceability queries
    
    Blue-Green Deployment:
    - New tables, safe to add
    - Foreign key to vendors can be added after vendors table exists
    - Foreign key to storage_locations can be added after warehouse schema exists