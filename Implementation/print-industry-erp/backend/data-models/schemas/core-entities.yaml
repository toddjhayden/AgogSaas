version: '0.1'
metadata:
  domain: core
  priority: critical
  estimatedEffort: 2-weeks
  status: draft

entity:
  name: Job
  description: |
    Represents a print job order from quote to delivery.
    Core entity linking customer requirements to production runs.
    Required for takt time and on-time delivery KPIs.
  
  tables:
    - name: jobs
      description: Main job order tracking table
      
  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    job_number:
      type: string
      description: Human-readable job number
      constraints:
        - not_null
        - unique: [tenant_id, job_number]
        - indexed
    
    customer_id:
      type: uuid
      description: Customer placing the order
      constraints:
        - not_null
        - foreign_key: customers.id
        - indexed
    
    # Scheduling (for Takt Time KPI)
    quantity_required:
      type: integer
      description: Total quantity required for this job
      constraints:
        - not_null
        - check: quantity_required > 0
    
    available_production_hours:
      type: decimal
      description: Available hours for production (for takt time calculation)
      constraints:
        - check: available_production_hours > 0
    
    # Delivery Tracking (for On-Time Delivery KPI)
    promised_delivery_date:
      type: timestamp
      description: Promised delivery date to customer
      constraints:
        - not_null
    
    actual_delivery_date:
      type: timestamp
      description: Actual delivery date (null if not yet delivered)
    
    due_date:
      type: timestamp
      description: Internal production due date
      constraints:
        - not_null
    
    # Status
    status:
      type: enum
      description: Current job status
      values:
        - quoted
        - pending
        - approved
        - scheduled
        - in-production
        - completed
        - delivered
        - cancelled
      constraints:
        - not_null
        - default: quoted
    
    priority:
      type: integer
      description: Job priority (1=highest)
      constraints:
        - not_null
        - default: 5
        - check: priority >= 1 AND priority <= 10
    
    # Specifications
    specifications:
      type: jsonb
      description: Detailed job specifications
      schema:
        type: object
        properties:
          quantity:
            type: integer
          paper_stock:
            type: string
          color_specifications:
            type: array
          size:
            type: object
            properties:
              width: number
              height: number
              unit: string
          finishing:
            type: array
      constraints:
        - not_null
    
    # Costing
    estimated_cost:
      type: decimal
      description: Estimated total cost
      constraints:
        - check: estimated_cost >= 0
    
    actual_cost:
      type: decimal
      description: Actual total cost (calculated)
      constraints:
        - check: actual_cost >= 0
    
    # Audit Fields
    created_at:
      type: timestamp
      description: Record creation timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      description: Record last update timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      description: User who created the record
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      description: User who last updated the record
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_jobs_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_jobs_customer
      columns: [tenant_id, customer_id]
      type: btree
    
    - name: idx_jobs_status
      columns: [tenant_id, status]
      type: btree
    
    - name: idx_jobs_due_date
      columns: [tenant_id, due_date]
      type: btree
    
    - name: idx_jobs_job_number
      columns: [tenant_id, job_number]
      type: btree
      unique: true

  kpisEnabled:
    critical:
      - takt_time
      - on_time_delivery
    
    high:
      - job_profitability
      - average_order_value
      - order_fulfillment_rate
    
    medium:
      - quote_to_delivery_time
      - job_completion_rate

  relatedEntities:
    - production-run.yaml
    - invoice.yaml
    - customer.yaml (future)

  migrationNotes: |
    Critical entity for production scheduling and customer delivery tracking.
    Required for takt time and on-time delivery KPIs.
    
    Migration Considerations:
    - Use UUIDv7 for time-ordered primary keys
    - Unique constraint on (tenant_id, job_number)
    - JSONB specifications allow flexible product definitions
    - Index on due_date essential for scheduling queries
    
    Blue-Green Deployment:
    - New table, safe to add
    - Foreign key to customers can be added after customer entity exists

  ColorSpec:
    description: Color specifications for a print job
    properties:
      process: enum[CMYK, spot, digital]
      colorProfile: string
      inkCoverage: number
      densityTargets:
        cyan: number
        magenta: number
        yellow: number
        black: number
      spotColors: array[SpotColor]

  SpotColor:
    description: Specification for a spot color
    properties:
      name: string
      pantoneCode: string
      lab:
        l: number
        a: number
        b: number
      density: number

  FinishingSpec:
    description: Finishing specifications
    properties:
      type: enum[fold, cut, stitch, perfect-bind, coating]
      parameters: object
      sequence: integer
      equipment: string