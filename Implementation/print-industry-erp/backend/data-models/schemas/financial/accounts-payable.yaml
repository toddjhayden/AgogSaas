version: '0.1'
metadata:
  domain: financial
  priority: medium
  estimatedEffort: 1-week
  blocksKPIs: 3+
  status: draft

entity:
  name: AccountsPayable
  description: |
    Tracks vendor invoices and payment obligations.
    Essential for DPO, AP turnover, working capital KPIs.
    Blocks 3+ cash flow and payables KPIs.
  
  tables:
    - name: accounts_payable
      description: Vendor payables tracking

  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # Relationships
    purchase_order_id:
      type: uuid
      description: PO this AP is for
      constraints:
        - foreign_key: purchase_orders.id
        - indexed
    
    vendor_id:
      type: uuid
      description: Vendor to pay
      constraints:
        - not_null
        - foreign_key: vendors.id
        - indexed
    
    # Invoice Details
    vendor_invoice_number:
      type: varchar(50)
      description: Vendor's invoice number
      constraints:
        - not_null
    
    invoice_date:
      type: date
      description: Vendor invoice date
      constraints:
        - not_null
    
    # Amounts
    invoice_amount:
      type: decimal
      description: Original invoice total
      constraints:
        - not_null
        - check: invoice_amount > 0
    
    amount_paid:
      type: decimal
      description: Total payments made
      constraints:
        - not_null
        - default: 0
        - check: amount_paid >= 0
    
    amount_outstanding:
      type: decimal
      description: Remaining balance (calculated)
      constraints:
        - not_null
        - check: amount_outstanding = invoice_amount - amount_paid
        - check: amount_outstanding >= 0
    
    discount_available:
      type: decimal
      description: Early payment discount available
      constraints:
        - default: 0
        - check: discount_available >= 0
    
    discount_taken:
      type: decimal
      description: Discount actually taken
      constraints:
        - default: 0
        - check: discount_taken >= 0
    
    # Dates
    due_date:
      type: date
      description: Payment due date
      constraints:
        - not_null
        - check: due_date >= invoice_date
    
    discount_date:
      type: date
      description: Last date to take early payment discount
      constraints:
        - check: discount_date <= due_date
    
    last_payment_date:
      type: date
      description: Most recent payment
    
    # Aging
    days_outstanding:
      type: integer
      description: Days since invoice date (calculated)
      constraints:
        - check: days_outstanding = CURRENT_DATE - invoice_date
    
    days_until_due:
      type: integer
      description: Days until due date (negative if overdue)
      constraints:
        - check: days_until_due = due_date - CURRENT_DATE
    
    # Status
    status:
      type: varchar(20)
      description: AP status
      values:
        - pending_approval
        - approved
        - scheduled
        - paid
        - partial
        - disputed
        - on_hold
      constraints:
        - not_null
        - default: pending_approval
    
    payment_terms:
      type: varchar(50)
      description: Payment terms (e.g., Net 30, 2/10 Net 30)
      constraints:
        - not_null
    
    # Approval
    approved_by:
      type: uuid
      description: Who approved for payment
      constraints:
        - foreign_key: users.id
    
    approved_at:
      type: timestamp
      description: When approved
    
    # Payment
    payment_method:
      type: varchar(30)
      description: How vendor will be paid
      values:
        - check
        - ach
        - wire
        - credit_card
        - other
    
    payment_reference:
      type: varchar(100)
      description: Check number, ACH confirmation, etc.
    
    # GL Coding
    gl_account:
      type: varchar(20)
      description: General ledger account code
    
    cost_center:
      type: varchar(20)
      description: Department/cost center
    
    # Notes
    notes:
      type: text
      description: Payment notes, disputes, etc.
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_accounts_payable_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_accounts_payable_vendor
      columns: [vendor_id, status]
      type: btree
    
    - name: idx_accounts_payable_due_date
      columns: [tenant_id, due_date, status]
      type: btree
      description: For payment scheduling
    
    - name: idx_accounts_payable_status
      columns: [tenant_id, status]
      type: btree
    
    - name: idx_accounts_payable_purchase_order
      columns: [purchase_order_id]
      type: btree

  kpisEnabled:
    critical:
      - days_payables_outstanding
      - accounts_payable_turnover
    
    high:
      - early_payment_discount_capture_rate
      - vendor_payment_timeliness
    
    medium:
      - average_payment_period
      - ap_aging_analysis

  relatedEntities:
    - purchase-order.yaml
    - vendor.yaml (assumed to exist)
    - cash-flow.yaml
    - financial-statement.yaml

  migrationNotes: |
    Medium priority for Phase 4 - needed for cash flow KPIs.
    
    Migration Considerations:
    - Integration with accounting system
    - Payment approval workflow
    - Check printing integration
    - ACH/wire payment integration
    
    Data Population:
    - Manual entry of vendor invoices
    - Auto-create from purchase orders (3-way match)
    - OCR/email parsing for invoice capture
    
    Blue-Green Deployment:
    - New table, safe to add
    - May depend on purchase_orders table

