version: '0.1'
metadata:
  domain: financial
  priority: high
  estimatedEffort: 1-week
  blocksKPIs: 10+
  status: draft

entity:
  name: Invoice
  description: |
    Customer invoices for completed jobs.
    Essential for revenue tracking, profitability analysis, AR management.
    Blocks 10+ financial KPIs including gross margin, job profitability, revenue growth.
  
  tables:
    - name: invoices
      description: Customer invoices

  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # Business Key
    invoice_number:
      type: string
      description: Human-readable invoice number
      constraints:
        - not_null
        - indexed
    
    # References
    job_id:
      type: uuid
      description: Job being invoiced
      constraints:
        - not_null
        - foreign_key: jobs.id
        - indexed
    
    customer_id:
      type: uuid
      description: Customer receiving invoice
      constraints:
        - not_null
        - foreign_key: customers.id
        - indexed
    
    # Line Items
    line_items:
      type: jsonb
      description: Invoice line items
      schema:
        type: array
        items:
          type: object
          properties:
            description:
              type: string
            quantity:
              type: number
            unit_price:
              type: decimal
            total_price:
              type: decimal
            taxable:
              type: boolean
      constraints:
        - not_null
    
    # Amounts
    subtotal:
      type: decimal
      description: Subtotal before tax
      constraints:
        - not_null
        - check: subtotal >= 0
    
    tax:
      type: decimal
      description: Tax amount
      constraints:
        - not_null
        - default: 0
        - check: tax >= 0
    
    discount:
      type: decimal
      description: Discount amount
      constraints:
        - default: 0
        - check: discount >= 0
    
    shipping:
      type: decimal
      description: Shipping charges
      constraints:
        - default: 0
        - check: shipping >= 0
    
    total_amount:
      type: decimal
      description: Total invoice amount (subtotal + tax + shipping)
      constraints:
        - not_null
        - check: total_amount >= 0
    
    amount_paid:
      type: decimal
      description: Amount paid so far
      constraints:
        - not_null
        - default: 0
        - check: amount_paid >= 0
        - check: amount_paid <= total_amount
    
    amount_due:
      type: decimal
      description: Remaining amount due (calculated total - amount_paid)
      constraints:
        - check: amount_due >= 0
    
    # Status
    status:
      type: enum
      description: Invoice status
      values:
        - draft
        - sent
        - viewed
        - partial
        - paid
        - overdue
        - cancelled
        - refunded
      constraints:
        - not_null
        - default: draft
    
    # Dates
    issued_date:
      type: date
      description: Date invoice was issued
      constraints:
        - not_null
    
    due_date:
      type: date
      description: Payment due date
      constraints:
        - not_null
    
    paid_date:
      type: date
      description: Date invoice was fully paid
    
    # Payment Details
    payment_terms:
      type: string
      description: Payment terms (e.g., "Net 30", "Due on receipt")
      constraints:
        - not_null
        - default: "Net 30"
    
    payment_method:
      type: enum
      description: How payment was received
      values:
        - check
        - credit-card
        - debit-card
        - ach
        - wire
        - cash
        - other
    
    # Notes
    notes:
      type: text
      description: Internal notes
    
    customer_notes:
      type: text
      description: Notes visible to customer
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_invoices_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_invoices_number
      columns: [tenant_id, invoice_number]
      type: btree
      unique: true
    
    - name: idx_invoices_customer
      columns: [tenant_id, customer_id]
      type: btree
    
    - name: idx_invoices_job
      columns: [tenant_id, job_id]
      type: btree
    
    - name: idx_invoices_status
      columns: [tenant_id, status]
      type: btree
    
    - name: idx_invoices_due_date
      columns: [tenant_id, due_date, status]
      type: btree
      description: For AR aging reports
    
    - name: idx_invoices_issued_date
      columns: [tenant_id, issued_date]
      type: btree
      description: For revenue reporting

  kpisEnabled:
    critical:
      - gross_margin_by_product
      - job_profitability
      - revenue_growth
    
    high:
      - average_order_value
      - accounts_receivable_turnover
      - days_sales_outstanding
      - net_profit_margin
      - gross_profit_margin
    
    medium:
      - customer_lifetime_value
      - average_days_delinquent
      - overdues_ratio

  relatedEntities:
    - job.yaml (from core-entities.yaml)
    - financial-statement.yaml
    - accounts-receivable.yaml
    - payment.yaml (future)

  migrationNotes: |
    High priority for Phase 2 - needed for all financial KPIs.
    
    Migration Considerations:
    - Unique constraint on (tenant_id, invoice_number)
    - Consider auto-generating invoice numbers with sequence/trigger
    - JSONB line_items allows flexible invoice structures
    - Index on due_date essential for AR aging reports
    - Status transitions should be validated (draft -> sent -> paid)
    
    Blue-Green Deployment:
    - New table, safe to add
    - Foreign key to jobs table
    - Consider trigger to update Job.invoiceId when invoice created
