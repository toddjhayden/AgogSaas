version: '0.1'
metadata:
  domain: items
  priority: critical
  estimatedEffort: 2-weeks
  status: design

entity:
  name: Item
  description: |
    Unified item catalog implementing the Item Master pattern.
    Items can play multiple ROLES: material (consumed in manufacturing),
    product (sold to customers), or both (e.g., blank labels).

    KEY INSIGHT: Material and Product are ROLES, not separate classifications.

    Real-world example: Customer orders 200,000 blank labels
    - 100,000 shipped directly to customer (product role)
    - 100,000 consumed to print custom labels (material role)
    Same item, different roles based on usage context.

    Replaces separate materials and products tables with unified design.

  tables:
    # Core item catalog
    - name: items
      description: Master catalog of all items (materials, products, services)

    # Reference/lookup tables
    - name: item_types
      description: Item type classifications (SUBSTRATE, INK, FINISHED_GOOD, etc.)
    - name: item_statuses
      description: Item lifecycle statuses (ACTIVE, INACTIVE, OBSOLETE, etc.)
    - name: measurement_types
      description: Physical measurement approaches (DISCRETE, CONTINUOUS, BATCH)

    # Attribute extension tables (populated based on role flags)
    - name: item_material_attributes
      description: Material-specific attributes (procurement, consumption)
    - name: item_product_attributes
      description: Product-specific attributes (sales, marketing)
    - name: item_physical_attributes
      description: Physical characteristics (dimensions, weight, volume)

    # UOM system
    - name: units_of_measure
      description: Master list of all units of measure
    - name: item_uom_conversions
      description: Item-specific UOM conversion factors
    - name: item_uom_preferences
      description: Context-specific UOM preferences (PURCHASE, SALES, etc.)

  properties:
    # ===== ITEMS TABLE (Core catalog) =====
    items:
      # Core Identity
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()

      tenant_id:
        type: uuid
        description: Multi-tenant isolation
        constraints:
          - not_null
          - foreign_key: tenants.id
          - indexed

      item_code:
        type: string
        length: 50
        description: Unique item identifier (SKU)
        constraints:
          - not_null
          - unique: [tenant_id, item_code]
          - indexed

      item_name:
        type: string
        length: 255
        description: Item name
        constraints:
          - not_null

      description:
        type: text
        description: Detailed item description

      # Classification
      item_type_id:
        type: uuid
        description: Item type classification
        constraints:
          - not_null
          - foreign_key: item_types.id
          - indexed

      # Role Flags (What can this item DO?)
      can_be_purchased:
        type: boolean
        description: Can we buy this from vendors? (material role)
        constraints:
          - not_null
          - default: false
          - indexed

      can_be_sold:
        type: boolean
        description: Can we sell this to customers? (product role)
        constraints:
          - not_null
          - default: false
          - indexed

      can_be_manufactured:
        type: boolean
        description: Can we make this item? (has BOM)
        constraints:
          - not_null
          - default: false
          - indexed

      can_be_inventoried:
        type: boolean
        description: Do we track inventory for this item?
        constraints:
          - not_null
          - default: true

      # Physical Measurement
      measurement_type_id:
        type: uuid
        description: How this item is physically measured
        constraints:
          - not_null
          - foreign_key: measurement_types.id
          - indexed

      base_uom_id:
        type: uuid
        description: Base unit of measure for inventory tracking
        constraints:
          - not_null
          - foreign_key: units_of_measure.id
          - indexed

      # Costing
      standard_cost:
        type: decimal
        precision: 18
        scale: 4
        description: Standard unit cost (in base_uom)
        constraints:
          - check: standard_cost >= 0

      standard_price:
        type: decimal
        precision: 18
        scale: 4
        description: Standard selling price (in base_uom)
        constraints:
          - check: standard_price >= 0

      # Status
      status_id:
        type: uuid
        description: Item lifecycle status
        constraints:
          - not_null
          - foreign_key: item_statuses.id
          - indexed

      # Audit Fields
      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

      updated_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

      created_by:
        type: uuid
        constraints:
          - foreign_key: users.id

      updated_by:
        type: uuid
        constraints:
          - foreign_key: users.id

    # ===== ITEM_TYPES TABLE (Reference) =====
    item_types:
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()

      type_code:
        type: string
        length: 50
        description: Type code (SUBSTRATE, INK, ADHESIVE, FINISHED_GOOD, etc.)
        constraints:
          - not_null
          - unique

      type_name:
        type: string
        length: 100
        description: Display name for type
        constraints:
          - not_null

      description:
        type: text
        description: Type description

      is_material_type:
        type: boolean
        description: Typically used as material (consumed in manufacturing)
        constraints:
          - not_null
          - default: false

      is_product_type:
        type: boolean
        description: Typically used as product (sold to customers)
        constraints:
          - not_null
          - default: false

      display_order:
        type: integer
        description: Sort order for UI display

      is_active:
        type: boolean
        constraints:
          - not_null
          - default: true

    # ===== ITEM_STATUSES TABLE (Reference) =====
    item_statuses:
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()

      status_code:
        type: string
        length: 20
        description: Status code (ACTIVE, INACTIVE, OBSOLETE, DISCONTINUED)
        constraints:
          - not_null
          - unique

      status_name:
        type: string
        length: 50
        description: Display name for status
        constraints:
          - not_null

      description:
        type: text
        description: Status description

      allows_transactions:
        type: boolean
        description: Can this item be used in transactions when in this status?
        constraints:
          - not_null
          - default: true

      display_order:
        type: integer
        description: Sort order for UI display

      is_active:
        type: boolean
        constraints:
          - not_null
          - default: true

    # ===== MEASUREMENT_TYPES TABLE (Reference) =====
    measurement_types:
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()

      measurement_code:
        type: string
        length: 20
        description: Measurement code (DISCRETE, CONTINUOUS, BATCH)
        constraints:
          - not_null
          - unique

      measurement_name:
        type: string
        length: 50
        description: Display name for measurement type
        constraints:
          - not_null

      description:
        type: text
        description: |
          DISCRETE: Countable items (labels, boxes, sheets) - whole numbers
          CONTINUOUS: Bulk/liquid (ink, adhesive) - decimals, volume/weight
          BATCH: Lot-tracked materials - cannot mix lots in production

      allows_decimals:
        type: boolean
        description: Can quantities have decimal values?
        constraints:
          - not_null
          - default: true

      requires_lot_tracking:
        type: boolean
        description: Does this measurement type require lot tracking by default?
        constraints:
          - not_null
          - default: false

      display_order:
        type: integer
        description: Sort order for UI display

      is_active:
        type: boolean
        constraints:
          - not_null
          - default: true

    # ===== ITEM_MATERIAL_ATTRIBUTES TABLE =====
    item_material_attributes:
      item_id:
        type: uuid
        description: Reference to items table
        constraints:
          - primary_key
          - foreign_key: items.id
          - on_delete: cascade

      # Procurement
      vendor_part_number:
        type: string
        length: 100
        description: Vendor's SKU/part number for this item

      preferred_vendor_id:
        type: uuid
        description: Default vendor to purchase from
        constraints:
          - foreign_key: vendors.id
          - indexed

      lead_time_days:
        type: integer
        description: Typical delivery time from vendor
        constraints:
          - check: lead_time_days >= 0

      minimum_order_quantity:
        type: decimal
        precision: 18
        scale: 4
        description: Minimum purchase quantity
        constraints:
          - check: minimum_order_quantity >= 0

      # Classification
      material_category:
        type: string
        length: 50
        description: Material category (SUBSTRATE, INK, ADHESIVE, PACKAGING, etc.)
        constraints:
          - indexed

      material_grade:
        type: string
        length: 50
        description: Material grade (PREMIUM, STANDARD, ECONOMY)

      # Quality/Safety
      shelf_life_days:
        type: integer
        description: Expiration period after receipt
        constraints:
          - check: shelf_life_days > 0

      requires_lot_tracking:
        type: boolean
        description: Must track by lot number?
        constraints:
          - not_null
          - default: false
          - indexed

      is_hazmat:
        type: boolean
        description: Hazardous material flag
        constraints:
          - not_null
          - default: false
          - indexed

      hazmat_class:
        type: string
        length: 20
        description: UN hazmat classification (if hazmat)

      # Storage Requirements
      storage_temperature_min:
        type: decimal
        precision: 10
        scale: 2
        description: Minimum storage temperature (°F)

      storage_temperature_max:
        type: decimal
        precision: 10
        scale: 2
        description: Maximum storage temperature (°F)

      storage_humidity_min:
        type: decimal
        precision: 5
        scale: 2
        description: Minimum humidity %
        constraints:
          - check: storage_humidity_min >= 0 AND storage_humidity_min <= 100

      storage_humidity_max:
        type: decimal
        precision: 5
        scale: 2
        description: Maximum humidity %
        constraints:
          - check: storage_humidity_max >= 0 AND storage_humidity_max <= 100

      # Consumption
      scrap_factor_percent:
        type: decimal
        precision: 5
        scale: 2
        description: Expected waste % during manufacturing
        constraints:
          - not_null
          - default: 0.00
          - check: scrap_factor_percent >= 0 AND scrap_factor_percent <= 100

      # Audit
      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

      updated_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

    # ===== ITEM_PRODUCT_ATTRIBUTES TABLE =====
    item_product_attributes:
      item_id:
        type: uuid
        description: Reference to items table
        constraints:
          - primary_key
          - foreign_key: items.id
          - on_delete: cascade

      # Sales/Marketing
      customer_facing_name:
        type: string
        length: 255
        description: Marketing name (may differ from item_name)

      marketing_description:
        type: text
        description: Customer-friendly description

      marketing_category:
        type: string
        length: 50
        description: Category for website/catalog
        constraints:
          - indexed

      # Pricing
      default_sales_price:
        type: decimal
        precision: 18
        scale: 4
        description: Default selling price
        constraints:
          - check: default_sales_price >= 0

      minimum_sales_price:
        type: decimal
        precision: 18
        scale: 4
        description: Floor price (prevent underselling)
        constraints:
          - check: minimum_sales_price >= 0

      allow_discounts:
        type: boolean
        description: Can sales apply discounts?
        constraints:
          - not_null
          - default: true

      # Fulfillment
      warranty_period_days:
        type: integer
        description: Warranty duration
        constraints:
          - check: warranty_period_days >= 0

      return_policy_days:
        type: integer
        description: Return window
        constraints:
          - check: return_policy_days >= 0

      # Configuration
      allows_custom_configuration:
        type: boolean
        description: Can be customized per order?
        constraints:
          - not_null
          - default: false
          - indexed

      requires_artwork_approval:
        type: boolean
        description: Need customer approval before production?
        constraints:
          - not_null
          - default: false

      # Packaging
      units_per_case:
        type: integer
        description: How many units in shipping case
        constraints:
          - check: units_per_case > 0

      cases_per_pallet:
        type: integer
        description: How many cases per pallet
        constraints:
          - check: cases_per_pallet > 0

      # Audit
      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

      updated_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

    # ===== ITEM_PHYSICAL_ATTRIBUTES TABLE =====
    item_physical_attributes:
      item_id:
        type: uuid
        description: Reference to items table
        constraints:
          - primary_key
          - foreign_key: items.id
          - on_delete: cascade

      # Dimensions (for DISCRETE items)
      unit_length:
        type: decimal
        precision: 18
        scale: 4
        description: Length per unit
        constraints:
          - check: unit_length > 0

      unit_width:
        type: decimal
        precision: 18
        scale: 4
        description: Width per unit
        constraints:
          - check: unit_width > 0

      unit_height:
        type: decimal
        precision: 18
        scale: 4
        description: Height per unit
        constraints:
          - check: unit_height > 0

      dimension_uom_id:
        type: uuid
        description: Unit of measure for dimensions (IN, CM, MM)
        constraints:
          - foreign_key: units_of_measure.id

      # Weight (for ALL items)
      unit_weight:
        type: decimal
        precision: 18
        scale: 4
        description: Weight per unit
        constraints:
          - check: unit_weight > 0

      weight_uom_id:
        type: uuid
        description: Unit of measure for weight (LB, KG, OZ)
        constraints:
          - foreign_key: units_of_measure.id

      # Volume (for CONTINUOUS items)
      unit_volume:
        type: decimal
        precision: 18
        scale: 4
        description: Volume per unit
        constraints:
          - check: unit_volume > 0

      volume_uom_id:
        type: uuid
        description: Unit of measure for volume (GAL, L, ML)
        constraints:
          - foreign_key: units_of_measure.id

      specific_gravity:
        type: decimal
        precision: 10
        scale: 4
        description: Density (for liquids)
        constraints:
          - check: specific_gravity > 0

      # Container (for CONTINUOUS items)
      container_type:
        type: string
        length: 50
        description: Container type (DRUM, PAIL, BOTTLE, TANK)

      container_capacity:
        type: decimal
        precision: 18
        scale: 4
        description: How much container holds
        constraints:
          - check: container_capacity > 0

      # Audit
      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

      updated_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

    # ===== UNITS_OF_MEASURE TABLE =====
    units_of_measure:
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()

      uom_code:
        type: string
        length: 10
        description: UOM code (EA, GAL, LB, CASE, BOX, etc.)
        constraints:
          - not_null
          - unique

      uom_name:
        type: string
        length: 50
        description: Display name (Each, Gallon, Pound, etc.)
        constraints:
          - not_null

      uom_type:
        type: string
        length: 20
        description: UOM category (COUNT, WEIGHT, VOLUME, LENGTH, AREA)
        constraints:
          - not_null
          - indexed

      is_base_unit:
        type: boolean
        description: Is this a base unit in its type?
        constraints:
          - not_null
          - default: false

      is_active:
        type: boolean
        constraints:
          - not_null
          - default: true

      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP

    # ===== ITEM_UOM_CONVERSIONS TABLE =====
    item_uom_conversions:
      item_id:
        type: uuid
        description: Item reference
        constraints:
          - not_null
          - foreign_key: items.id
          - on_delete: cascade
          - indexed

      from_uom_id:
        type: uuid
        description: Source UOM
        constraints:
          - not_null
          - foreign_key: units_of_measure.id

      to_uom_id:
        type: uuid
        description: Target UOM
        constraints:
          - not_null
          - foreign_key: units_of_measure.id

      conversion_factor:
        type: decimal
        precision: 18
        scale: 6
        description: Multiply quantity in from_uom by this to get to_uom
        constraints:
          - not_null
          - check: conversion_factor > 0

      constraints:
        - primary_key: [item_id, from_uom_id, to_uom_id]

    # ===== ITEM_UOM_PREFERENCES TABLE =====
    item_uom_preferences:
      item_id:
        type: uuid
        description: Item reference
        constraints:
          - not_null
          - foreign_key: items.id
          - on_delete: cascade
          - indexed

      context:
        type: string
        length: 20
        description: Usage context (PURCHASE, SALES, MANUFACTURING, INVENTORY)
        constraints:
          - not_null
          - check: context IN ('PURCHASE', 'SALES', 'MANUFACTURING', 'INVENTORY')

      preferred_uom_id:
        type: uuid
        description: Preferred UOM for this context
        constraints:
          - not_null
          - foreign_key: units_of_measure.id

      constraints:
        - primary_key: [item_id, context]

  indexes:
    # Items table indexes
    - name: idx_items_tenant
      table: items
      columns: [tenant_id]
      type: btree

    - name: idx_items_code
      table: items
      columns: [tenant_id, item_code]
      type: btree
      unique: true

    - name: idx_items_type
      table: items
      columns: [item_type_id]
      type: btree

    - name: idx_items_status
      table: items
      columns: [status_id]
      type: btree

    - name: idx_items_roles
      table: items
      columns: [can_be_purchased, can_be_sold, can_be_manufactured]
      type: btree
      where: status_id IN (SELECT id FROM item_statuses WHERE status_code = 'ACTIVE')

    - name: idx_items_base_uom
      table: items
      columns: [base_uom_id]
      type: btree

    # Material attributes indexes
    - name: idx_item_material_vendor
      table: item_material_attributes
      columns: [preferred_vendor_id]
      type: btree

    - name: idx_item_material_category
      table: item_material_attributes
      columns: [material_category]
      type: btree

    - name: idx_item_material_hazmat
      table: item_material_attributes
      columns: [is_hazmat]
      type: btree
      where: is_hazmat = true

    - name: idx_item_material_lot_tracked
      table: item_material_attributes
      columns: [requires_lot_tracking]
      type: btree
      where: requires_lot_tracking = true

    # Product attributes indexes
    - name: idx_item_product_category
      table: item_product_attributes
      columns: [marketing_category]
      type: btree

    - name: idx_item_product_configurable
      table: item_product_attributes
      columns: [allows_custom_configuration]
      type: btree
      where: allows_custom_configuration = true

    # UOM indexes
    - name: idx_uom_type
      table: units_of_measure
      columns: [uom_type]
      type: btree

    - name: idx_item_uom_conv_item
      table: item_uom_conversions
      columns: [item_id]
      type: btree

    - name: idx_item_uom_pref_item
      table: item_uom_preferences
      columns: [item_id]
      type: btree

  kpisEnabled:
    high:
      - inventory_turnover_rate
      - item_profitability
      - stock_to_sales_ratio
      - item_velocity

    medium:
      - days_inventory_outstanding
      - obsolete_item_percentage
      - dual_role_item_ratio

  relatedEntities:
    - bill-of-materials.yaml
    - vendor-purchase-orders.yaml
    - sales-orders.yaml
    - production-orders.yaml
    - unified-inventory.yaml

  migrationNotes: |
    Item Master pattern replaces separate materials and products tables.

    KEY DESIGN DECISIONS:
    - Material and Product are ROLES, not separate entities
    - Same item can be both purchased AND sold (dual role)
    - Role flags (can_be_purchased, can_be_sold) drive behavior
    - Three-layer attributes: base (items), material, product
    - Multi-UOM with context-specific preferences

    REFERENCE TABLES:
    - item_types: Type classifications with role hints
    - item_statuses: Lifecycle statuses with transaction rules
    - measurement_types: Physical measurement approaches
    - units_of_measure: Master UOM list

    MIGRATION STRATEGY:
    1. Create reference tables (item_types, item_statuses, etc.)
    2. Seed reference data
    3. Create items table structure
    4. Migrate materials → items (can_be_purchased=TRUE)
    5. Migrate products → items (can_be_sold=TRUE)
    6. Populate attribute tables based on role flags
    7. Update foreign keys in dependent tables
    8. Drop old materials and products tables

    REAL-WORLD EXAMPLE:
    Blank labels (item_code: LABEL-4X6-BLANK):
    - can_be_purchased = TRUE (buy from vendors)
    - can_be_sold = TRUE (sell to customers)
    - Has material_attributes (vendor, lead time)
    - Has product_attributes (marketing name, price)
    - Used in BOM as component (material role)
    - Appears in sales orders (product role)
