version: '0.1'
metadata:
  domain: equipment
  priority: high
  estimatedEffort: 3-days
  status: draft

entity:
  name: MaintenanceRecord
  description: |
    Equipment maintenance history for preventive maintenance tracking.
    Enables PM compliance and maintenance cost KPIs.
    Links to equipment.yaml for equipment master data.
  
  tables:
    - name: maintenance_records
      description: Equipment maintenance history
      
  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    equipment_id:
      type: uuid
      description: Equipment being maintained
      constraints:
        - not_null
        - foreign_key: equipment.id
        - indexed
    
    maintenance_type:
      type: enum
      description: Type of maintenance
      values:
        - preventive
        - corrective
        - predictive
        - emergency
        - calibration
        - inspection
      constraints:
        - not_null
        - indexed
    
    scheduled_date:
      type: timestamp
      description: When maintenance was scheduled
      constraints:
        - not_null
        - indexed
    
    completed_date:
      type: timestamp
      description: When maintenance was completed (null if not completed)
    
    status:
      type: enum
      description: Maintenance record status
      values:
        - scheduled
        - in-progress
        - completed
        - cancelled
        - overdue
      constraints:
        - not_null
        - default: scheduled
        - indexed
    
    description:
      type: text
      description: Maintenance description
    
    technician_id:
      type: uuid
      description: Technician performing maintenance
      constraints:
        - foreign_key: users.id
    
    maintenance_cost:
      type: decimal
      description: Total cost of maintenance (labor + parts)
      constraints:
        - check: maintenance_cost >= 0
    
    labor_cost:
      type: decimal
      description: Labor cost component
      constraints:
        - check: labor_cost >= 0
    
    parts_cost:
      type: decimal
      description: Parts cost component
      constraints:
        - check: parts_cost >= 0
    
    parts_used:
      type: jsonb
      description: Parts used in maintenance
      schema:
        type: array
        items:
          type: object
          properties:
            part_number: string
            description: string
            quantity: integer
            cost: decimal
      constraints:
        - default: "[]"
    
    downtime_hours:
      type: decimal
      description: Equipment downtime during maintenance
      constraints:
        - check: downtime_hours >= 0
    
    readings_before:
      type: jsonb
      description: Equipment readings before maintenance
      constraints:
        - default: "{}"
    
    readings_after:
      type: jsonb
      description: Equipment readings after maintenance
      constraints:
        - default: "{}"
    
    notes:
      type: text
      description: Additional maintenance notes
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_maintenance_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_maintenance_equipment
      columns: [tenant_id, equipment_id, scheduled_date]
      type: btree
    
    - name: idx_maintenance_type
      columns: [tenant_id, maintenance_type]
      type: btree
    
    - name: idx_maintenance_status
      columns: [tenant_id, status, scheduled_date]
      type: btree
    
    - name: idx_maintenance_scheduled
      columns: [tenant_id, scheduled_date]
      type: btree

  kpisEnabled:
    critical:
      - preventive_maintenance_compliance
    
    high:
      - maintenance_cost_per_equipment
      - mean_time_to_repair
      - planned_vs_unplanned_maintenance
    
    medium:
      - maintenance_cost_percentage
      - pm_completion_rate

  relatedEntities:
    - equipment.yaml
    - equipment-status-log.yaml

  migrationNotes: |
    Maintenance record entity for PM compliance tracking.
    Enables preventive_maintenance_compliance and maintenance_cost_per_equipment KPIs.
    
    Migration Considerations:
    - Index on (equipment_id, scheduled_date) for PM tracking queries
    - Index on status for overdue maintenance reports
    - JSONB for parts_used allows flexible tracking
    - Consider partitioning by scheduled_date for large maintenance histories
    
    Blue-Green Deployment:
    - New table, safe to add
    - Foreign key to equipment must exist first
