version: '0.1'
metadata:
  domain: production
  priority: high
  estimatedEffort: 1-week
  blocksKPIs: 5+
  status: draft

entity:
  name: MaterialConsumption
  description: |
    Tracks actual material usage per job/production run.
    Essential for yield analysis, material efficiency, waste tracking.
    Blocks 5+ material and inventory KPIs.
  
  tables:
    - name: material_consumptions
      description: Material usage transactions

  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # Relationships
    production_run_id:
      type: uuid
      description: Production run consuming material
      constraints:
        - not_null
        - foreign_key: production_runs.id
        - indexed
    
    job_id:
      type: uuid
      description: Job consuming material
      constraints:
        - not_null
        - foreign_key: jobs.id
        - indexed
    
    material_id:
      type: uuid
      description: Material being consumed
      constraints:
        - not_null
        - foreign_key: materials.id
        - indexed
    
    lot_id:
      type: uuid
      description: Specific lot/batch consumed
      constraints:
        - foreign_key: lots.id
        - indexed
    
    # Quantities
    quantity_allocated:
      type: decimal
      description: Amount allocated/planned
      constraints:
        - not_null
        - check: quantity_allocated >= 0
    
    quantity_consumed:
      type: decimal
      description: Amount actually used
      constraints:
        - not_null
        - check: quantity_consumed >= 0
    
    quantity_waste:
      type: decimal
      description: Amount wasted (scrap, trim, spillage)
      constraints:
        - not_null
        - default: 0
        - check: quantity_waste >= 0
    
    quantity_returned:
      type: decimal
      description: Amount returned to inventory
      constraints:
        - not_null
        - default: 0
        - check: quantity_returned >= 0
    
    unit_of_measure:
      type: varchar(20)
      description: Unit (sheets, lbs, sqft, etc.)
      constraints:
        - not_null
    
    # Variance Analysis
    variance_quantity:
      type: decimal
      description: Consumed - allocated (calculated)
      constraints:
        - check: variance_quantity = quantity_consumed - quantity_allocated
    
    variance_percent:
      type: decimal
      description: Variance as percentage
      constraints:
        - check: variance_percent = (variance_quantity / quantity_allocated) * 100
    
    # Costing
    unit_cost:
      type: decimal
      description: Cost per unit at consumption time
      constraints:
        - not_null
        - check: unit_cost >= 0
    
    total_cost:
      type: decimal
      description: Total material cost for this consumption
      constraints:
        - not_null
        - check: total_cost = quantity_consumed * unit_cost
    
    # Timing
    consumed_at:
      type: timestamp
      description: When material was consumed
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    # Waste Classification
    waste_reason:
      type: varchar(50)
      description: Reason for waste in packaging operations
      values:
        - makeready (setup/test runs until first good piece - distinct from normal runtime trim)
        - web_break (web/substrate break during running - packaging-specific)
        - defect (quality defect, out-of-spec product)
        - trim (normal edge trim, skeletons, die-cut waste)
        - spillage (material spills, accidents)
        - rework (material scrapped due to rework operations)
        - color_adjustment (waste from color matching/adjustment)
        - registration_failure (waste from alignment/registration issues)
        - other (specify in waste_notes)
    
    waste_notes:
      type: text
      description: Details about waste
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_material_consumptions_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_material_consumptions_production_run
      columns: [production_run_id]
      type: btree
    
    - name: idx_material_consumptions_job
      columns: [job_id]
      type: btree
    
    - name: idx_material_consumptions_material
      columns: [material_id]
      type: btree
    
    - name: idx_material_consumptions_lot
      columns: [lot_id]
      type: btree
    
    - name: idx_material_consumptions_consumed_at
      columns: [tenant_id, consumed_at]
      type: btree

  kpisEnabled:
    critical:
      - material_yield_rate
      - material_waste_rate
    
    high:
      - material_variance
      - ink_consumption_rate
      - paper_waste_percentage
      - board_utilization
      - trim_waste_percentage
    
    medium:
      - material_efficiency
      - cost_per_good_unit

  relatedEntities:
    - production-run.yaml
    - job.yaml (core-entities.yaml)
    - materials.yaml
    - inventory.yaml

  migrationNotes: |
    High priority for Phase 3 - needed for material KPIs.
    
    Migration Considerations:
    - High transaction volume table
    - Consider partitioning by consumed_at (monthly)
    - Inventory adjustment integration needed
    - Foreign key to production_runs must exist first
    
    Data Population:
    - Manual entry during production
    - Automatic allocation from production plan
    - Integration with shop floor data collection
    
    Blue-Green Deployment:
    - New table, safe to add
    - Depends on production_runs table existing

