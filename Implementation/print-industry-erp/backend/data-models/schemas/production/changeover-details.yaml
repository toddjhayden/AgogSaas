version: '0.1'
metadata:
  domain: production
  priority: high
  estimatedEffort: 3-days
  blocksKPIs: 3+
  status: draft

entity:
  name: ChangeoverDetails
  description: |
    Detailed tracking of equipment changeovers from one job to another.
    Essential for understanding changeover efficiency, analyzing delay patterns,
    and optimizing production scheduling to minimize non-productive time.
    Blocks 3+ changeover efficiency and scheduling KPIs.
  
  tables:
    - name: changeover_details
      description: Job-to-job changeover tracking with delay analysis
      
  properties:
    # Core Identity
    changeover_id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # Equipment Context
    equipment_id:
      type: uuid
      description: Equipment undergoing changeover
      constraints:
        - not_null
        - foreign_key: equipment.id
        - indexed
    
    work_center_id:
      type: uuid
      description: Work center where changeover occurred
      constraints:
        - foreign_key: work_centers.work_center_id
        - indexed
    
    line_id:
      type: uuid
      description: Production line where changeover occurred
      constraints:
        - foreign_key: production_lines.line_id
        - indexed
    
    site_id:
      type: uuid
      description: Site where changeover occurred
      constraints:
        - foreign_key: sites.site_id
        - indexed
    
    # Job Transition
    previous_job_id:
      type: uuid
      description: Job that was just completed
      constraints:
        - not_null
        - foreign_key: jobs.id
        - indexed
    
    previous_production_order_id:
      type: uuid
      description: Production order that was just completed
      constraints:
        - foreign_key: production_orders.id
    
    next_job_id:
      type: uuid
      description: Job starting after changeover
      constraints:
        - not_null
        - foreign_key: jobs.id
        - indexed
    
    next_production_order_id:
      type: uuid
      description: Production order starting after changeover
      constraints:
        - foreign_key: production_orders.id
    
    # Timing
    changeover_start:
      type: timestamp
      description: When changeover began (previous job completed)
      constraints:
        - not_null
        - indexed
    
    changeover_end:
      type: timestamp
      description: When changeover completed (next job started)
      constraints:
        - not_null
        - check: changeover_end > changeover_start
    
    duration_actual_minutes:
      type: integer
      description: Actual changeover duration in minutes
      constraints:
        - not_null
        - check: duration_actual_minutes = EXTRACT(EPOCH FROM (changeover_end - changeover_start)) / 60
    
    duration_standard_minutes:
      type: integer
      description: Standard/planned changeover duration
      constraints:
        - check: duration_standard_minutes > 0
    
    duration_variance_minutes:
      type: integer
      description: Variance from standard (positive = took longer)
      constraints:
        - check: duration_variance_minutes = duration_actual_minutes - duration_standard_minutes
    
    # Changeover Type
    changeover_type:
      type: enum
      description: Type of changeover
      values:
        - job_to_job (different customer jobs)
        - material_change (same job, different substrate/ink)
        - die_change (different cutting die)
        - plate_change (different printing plates)
        - format_change (different size/format)
        - color_change (different color setup)
        - cleaning (scheduled cleaning cycle)
        - maintenance (preventive maintenance)
      constraints:
        - not_null
        - indexed
    
    changeover_complexity:
      type: enum
      description: Complexity of changeover
      values:
        - minor (similar jobs, minimal adjustment)
        - standard (typical changeover)
        - major (significant reconfiguration)
        - extreme (near-complete teardown)
      constraints:
        - not_null
    
    # Activities Performed
    activities_performed:
      type: jsonb
      description: List of changeover activities
      schema:
        type: array
        items:
          type: object
          properties:
            activity: string
            duration_minutes: integer
            completed_by: uuid
      examples:
        - [{"activity": "Remove previous die", "duration_minutes": 15, "completed_by": "user-uuid"},
           {"activity": "Install new die", "duration_minutes": 25, "completed_by": "user-uuid"},
           {"activity": "Alignment and test cuts", "duration_minutes": 35, "completed_by": "user-uuid"}]
      constraints:
        - default: "[]"
    
    # Material/Tooling Changes
    dies_changed:
      type: boolean
      description: Was die/cutting tool changed
      constraints:
        - not_null
        - default: false
    
    plates_changed:
      type: boolean
      description: Were printing plates changed
      constraints:
        - not_null
        - default: false
    
    inks_changed:
      type: boolean
      description: Were ink colors changed
      constraints:
        - not_null
        - default: false
    
    substrate_changed:
      type: boolean
      description: Was substrate/material type changed
      constraints:
        - not_null
        - default: false
    
    # Delay Analysis
    was_delayed:
      type: boolean
      description: Did changeover exceed standard time
      constraints:
        - not_null
        - check: was_delayed = (duration_actual_minutes > duration_standard_minutes)
    
    delay_duration_minutes:
      type: integer
      description: Minutes over standard time (0 if not delayed)
      constraints:
        - not_null
        - default: 0
        - check: delay_duration_minutes = GREATEST(0, duration_actual_minutes - duration_standard_minutes)
    
    reason_codes_for_delay:
      type: jsonb
      description: Reasons for delays beyond standard time
      schema:
        type: array
        items:
          type: object
          properties:
            reason_code: string
            duration_minutes: integer
            description: string
      examples:
        - [{"reason_code": "tooling_issue", "duration_minutes": 20, "description": "Die mounting bolts stripped"},
           {"reason_code": "material_unavailable", "duration_minutes": 15, "description": "Next job substrate not staged"}]
      constraints:
        - default: "[]"
    
    primary_delay_reason:
      type: enum
      description: Primary reason for delay (most common causes)
      values:
        - none (no delay)
        - tooling_issue (die/plate/tool problem)
        - material_unavailable (substrate not ready)
        - maintenance_required (unexpected repair needed)
        - operator_availability (operator not available)
        - equipment_adjustment (mechanical alignment issues)
        - quality_issue (failed quality check during setup)
        - documentation_missing (job specs/instructions unclear)
        - utility_interruption (power, air, water issue)
        - other (specify in notes)
      constraints:
        - indexed
    
    # Operator/Crew
    primary_operator_id:
      type: uuid
      description: Primary operator performing changeover
      constraints:
        - not_null
        - foreign_key: users.id
    
    crew_size:
      type: integer
      description: Number of people involved in changeover
      constraints:
        - not_null
        - default: 1
        - check: crew_size > 0
    
    crew_members:
      type: jsonb
      description: All crew members involved
      schema:
        type: array
        items:
          type: object
          properties:
            user_id: uuid
            role: string
      constraints:
        - default: "[]"
    
    # Makeready Waste
    makeready_waste_quantity:
      type: decimal
      description: Material wasted during setup/test runs
      constraints:
        - not_null
        - default: 0
        - check: makeready_waste_quantity >= 0
    
    makeready_waste_unit:
      type: varchar(20)
      description: Unit of measure for waste (sheets, kg, linear feet)
      examples:
        - "sheets"
        - "kg"
        - "linear_feet"
        - "square_meters"
    
    makeready_waste_cost:
      type: decimal
      description: Dollar value of makeready waste
      constraints:
        - check: makeready_waste_cost >= 0
    
    # Notes
    notes:
      type: text
      description: Additional observations, issues encountered
    
    # Quality Flags
    setup_approved:
      type: boolean
      description: Was setup approved (quality check passed)
      constraints:
        - not_null
        - default: false
    
    approved_by:
      type: uuid
      description: User who approved setup
      constraints:
        - foreign_key: users.id
    
    approved_at:
      type: timestamp
      description: When setup was approved
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_changeover_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_changeover_equipment
      columns: [tenant_id, equipment_id, changeover_start]
      type: btree
    
    - name: idx_changeover_jobs
      columns: [tenant_id, previous_job_id, next_job_id]
      type: btree
    
    - name: idx_changeover_delayed
      columns: [tenant_id, was_delayed, changeover_start]
      type: btree
      where: was_delayed = true
    
    - name: idx_changeover_type
      columns: [tenant_id, changeover_type, changeover_start]
      type: btree
    
    - name: idx_changeover_delay_reason
      columns: [tenant_id, primary_delay_reason]
      type: btree
      where: primary_delay_reason != 'none'
    
    - name: idx_changeover_line
      columns: [tenant_id, line_id, changeover_start]
      type: btree

  kpisEnabled:
    critical:
      - average_changeover_time
      - changeover_time_vs_standard
    
    high:
      - changeover_delay_rate
      - makeready_waste_per_changeover
      - oee_availability_loss
    
    medium:
      - changeover_efficiency_by_type
      - changeover_efficiency_by_operator
      - crew_size_optimization

  relatedEntities:
    - job.yaml (previous and next jobs)
    - production-order.yaml (production orders being transitioned)
    - equipment.yaml (equipment being changed over)
    - asset-hierarchy.yaml (work center, line, site context)
    - equipment-status-log.yaml (changeover events)
    - material-consumption.yaml (makeready waste)

  migrationNotes: |
    Changeover Details table provides granular tracking of job-to-job transitions.
    
    Key Use Cases:
    1. Changeover Time Analysis
       - Compare actual vs standard changeover times
       - Identify equipment with slow changeovers
       - Track improvement over time (SMED initiatives)
    
    2. Delay Root Cause Analysis
       - Categorize delays by reason (tooling, material, operator, etc.)
       - Quantify impact of each delay type
       - Target improvement efforts at biggest delays
    
    3. Makeready Waste Tracking
       - Link material waste to specific changeover events
       - Calculate waste as percentage of changeover cost
       - Identify high-waste changeover types
    
    4. Scheduling Optimization
       - Minimize changeovers by grouping similar jobs
       - Sequence jobs to reduce die/plate changes
       - Account for changeover time in capacity planning
    
    5. Operator Training
       - Identify operators with slow changeovers
       - Track improvement after training
       - Benchmark against best performers
    
    Data Sources:
    - equipment_status_log creates changeover_details record
    - Operator enters delay reasons during or after changeover
    - Quality inspector enters setup approval status
    - Material consumption linked for makeready waste
    
    Changeover Complexity Drivers:
    - Minor: Same substrate, same die, color change only
    - Standard: Different die, same substrate type
    - Major: Different substrate gauge, different die type
    - Extreme: Different process (flexo to gravure), complete reconfiguration
    
    SMED (Single Minute Exchange of Die) Integration:
    - Internal time: Equipment stopped (in changeover_details)
    - External time: Pre-staging (tracked separately, not downtime)
    - Goal: Convert internal to external time (reduce duration_actual_minutes)
    
    Blue-Green Deployment:
    - New table, safe to add
    - Backfill from equipment_status_log where event_type = 'changeover'
    - Link to jobs via production_run â†’ job_id mapping
    - Start tracking prospectively for new changeovers
