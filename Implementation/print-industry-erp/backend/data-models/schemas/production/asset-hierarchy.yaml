version: '0.1'
metadata:
  domain: production
  priority: high
  estimatedEffort: 1-week
  blocksKPIs: 10+
  status: draft

entity:
  name: AssetHierarchy
  description: |
    Hierarchical organization of production assets: Site > Line > Work Center > Machine.
    Critical dimensional model for capacity planning, scheduling, and performance reporting.
    Enables multi-site operations, line balancing, and bottleneck analysis.
    Blocks 10+ production planning and capacity KPIs.
  
  tables:
    - name: sites
      description: Physical production locations (plants, facilities)
    - name: production_lines
      description: Production lines within sites
    - name: work_centers
      description: Work centers within production lines
      
  properties:
    # Site Entity
    site_id:
      type: uuid
      description: UUIDv7 primary key for site
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    site_tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    site_code:
      type: varchar(20)
      description: Human-readable site code
      constraints:
        - not_null
        - unique: [site_tenant_id, site_code]
    
    site_name:
      type: varchar(100)
      description: Site name
      constraints:
        - not_null
    
    site_type:
      type: enum
      description: Type of production facility
      values:
        - manufacturing (main production)
        - finishing (post-press only)
        - warehouse (distribution)
        - hybrid (multiple capabilities)
      constraints:
        - not_null
    
    site_location:
      type: jsonb
      description: Physical address and coordinates
      schema:
        type: object
        properties:
          address: string
          city: string
          state: string
          postal_code: string
          country: string
          latitude: number
          longitude: number
    
    site_capacity_hours:
      type: integer
      description: Available production hours per week
      constraints:
        - check: site_capacity_hours > 0
    
    site_status:
      type: enum
      description: Site operational status
      values:
        - active
        - inactive
        - maintenance
        - closed
      constraints:
        - not_null
        - default: active

  # Production Line Entity
  productionLines:
    name: ProductionLine
    description: Production lines within a site (e.g., offset press line, digital line, finishing line)
    
    properties:
      line_id:
        type: uuid
        description: UUIDv7 primary key for production line
        constraints:
          - primary_key
          - default: uuid_generate_v7()
      
      line_tenant_id:
        type: uuid
        description: Multi-tenant isolation
        constraints:
          - not_null
          - foreign_key: tenants.id
          - indexed
      
      site_id:
        type: uuid
        description: Parent site
        constraints:
          - not_null
          - foreign_key: sites.site_id
          - indexed
      
      line_code:
        type: varchar(20)
        description: Line identifier
        constraints:
          - not_null
          - unique: [line_tenant_id, site_id, line_code]
      
      line_name:
        type: varchar(100)
        description: Line name
        constraints:
          - not_null
      
      line_type:
        type: enum
        description: Type of production line
        values:
          - offset_press (sheet-fed or web)
          - digital_press (toner or inkjet)
          - flexographic (corrugated, labels)
          - gravure (flexible packaging)
          - screen_printing (specialty)
          - finishing (cutting, folding, binding)
          - packaging (boxing, palletizing)
        constraints:
          - not_null
      
      line_capabilities:
        type: jsonb
        description: What this line can produce
        schema:
          type: array
          items:
            type: string
        examples:
          - ["4-color", "spot-color", "coating"]
          - ["digital-short-run", "variable-data"]
      
      line_capacity_hours:
        type: integer
        description: Available hours per week
        constraints:
          - check: line_capacity_hours > 0
      
      theoretical_max_speed:
        type: integer
        description: Maximum units per hour for this line
        constraints:
          - check: theoretical_max_speed > 0
      
      line_status:
        type: enum
        description: Line operational status
        values:
          - active
          - inactive
          - maintenance
          - retired
        constraints:
          - not_null
          - default: active
      
      # Costing
      hourly_rate:
        type: decimal
        description: Standard hourly rate for this line (for cost allocation)
        constraints:
          - check: hourly_rate >= 0

  # Work Center Entity
  workCenters:
    name: WorkCenter
    description: Work centers within a production line (logical grouping of equipment)
    
    properties:
      work_center_id:
        type: uuid
        description: UUIDv7 primary key for work center
        constraints:
          - primary_key
          - default: uuid_generate_v7()
      
      work_center_tenant_id:
        type: uuid
        description: Multi-tenant isolation
        constraints:
          - not_null
          - foreign_key: tenants.id
          - indexed
      
      line_id:
        type: uuid
        description: Parent production line
        constraints:
          - not_null
          - foreign_key: production_lines.line_id
          - indexed
      
      work_center_code:
        type: varchar(20)
        description: Work center identifier
        constraints:
          - not_null
          - unique: [work_center_tenant_id, line_id, work_center_code]
      
      work_center_name:
        type: varchar(100)
        description: Work center name
        constraints:
          - not_null
      
      work_center_type:
        type: enum
        description: Function of this work center
        values:
          - prepress (platemaking, proofing)
          - press (printing operation)
          - finishing (cutting, folding)
          - binding (stitching, perfect binding)
          - coating (varnish, lamination)
          - inspection (quality control)
          - packaging (boxing, shipping prep)
        constraints:
          - not_null
      
      # Equipment assigned to this work center
      # (equipment.yaml will have work_center_id foreign key)
      
      work_center_capacity_hours:
        type: integer
        description: Available hours per week
        constraints:
          - check: work_center_capacity_hours > 0
      
      work_center_status:
        type: enum
        description: Work center operational status
        values:
          - active
          - inactive
          - maintenance
        constraints:
          - not_null
          - default: active
      
      # Costing
      labor_rate:
        type: decimal
        description: Standard labor rate per hour
        constraints:
          - check: labor_rate >= 0
      
      overhead_rate:
        type: decimal
        description: Overhead allocation rate per hour
        constraints:
          - check: overhead_rate >= 0

  indexes:
    # Site indexes
    - name: idx_sites_tenant
      table: sites
      columns: [site_tenant_id]
      type: btree
    
    - name: idx_sites_status
      table: sites
      columns: [site_tenant_id, site_status]
      type: btree
    
    # Production line indexes
    - name: idx_lines_tenant
      table: production_lines
      columns: [line_tenant_id]
      type: btree
    
    - name: idx_lines_site
      table: production_lines
      columns: [line_tenant_id, site_id]
      type: btree
    
    - name: idx_lines_type
      table: production_lines
      columns: [line_tenant_id, line_type]
      type: btree
    
    # Work center indexes
    - name: idx_work_centers_tenant
      table: work_centers
      columns: [work_center_tenant_id]
      type: btree
    
    - name: idx_work_centers_line
      table: work_centers
      columns: [work_center_tenant_id, line_id]
      type: btree

  kpisEnabled:
    critical:
      - line_utilization
      - work_center_efficiency
      - capacity_utilization
    
    high:
      - bottleneck_identification
      - multi_site_capacity
      - line_balancing
    
    medium:
      - site_productivity
      - equipment_allocation

  relatedEntities:
    - equipment.yaml (machines belong to work centers)
    - production-run.yaml (runs occur on lines/work centers)
    - job.yaml (jobs scheduled across sites/lines)

  migrationNotes: |
    Asset hierarchy provides critical dimensional structure for capacity planning.
    
    Hierarchy levels:
    1. Site (plant/facility) - physical location
    2. Production Line - capability grouping (offset, digital, finishing)
    3. Work Center - functional area (prepress, press, bindery)
    4. Machine/Equipment - individual assets (see equipment.yaml)
    
    Migration Considerations:
    - Start with single site, expand to multi-site later
    - Equipment.yaml needs work_center_id foreign key added
    - Production-run.yaml needs line_id and work_center_id added
    - Use hierarchy for capacity queries: SUM(capacity) GROUP BY site/line/work_center
    
    Blue-Green Deployment:
    - New tables, safe to add
    - Equipment FK can be nullable initially
    - Backfill hierarchy data before making FKs required
