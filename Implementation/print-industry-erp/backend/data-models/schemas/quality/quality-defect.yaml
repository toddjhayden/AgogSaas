version: '0.1'
metadata:
  domain: quality
  priority: medium
  estimatedEffort: 1-week
  blocksKPIs: 6+
  status: draft

entity:
  name: QualityDefect
  description: |
    Tracks quality defects found during production or inspection.
    Essential for FPY, defect tracking, root cause analysis.
    Blocks 6+ quality and rework KPIs.
  
  tables:
    - name: quality_defects
      description: Quality defect records

  properties:
    # Core Identity
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    # Relationships
    production_run_id:
      type: uuid
      description: Production run where defect occurred
      constraints:
        - not_null
        - foreign_key: production_runs.id
        - indexed
    
    job_id:
      type: uuid
      description: Job with defect
      constraints:
        - not_null
        - foreign_key: jobs.id
        - indexed
    
    equipment_id:
      type: uuid
      description: Equipment where defect occurred
      constraints:
        - foreign_key: equipment.id
        - indexed
    
    # Defect Details
    defect_type:
      type: varchar(50)
      description: Category of defect
      values:
        - registration
        - color_variation
        - scratches
        - hickey
        - streaks
        - misprint
        - fold_error
        - cut_error
        - glue_defect
        - damage
        - contamination
        - other
      constraints:
        - not_null
    
    severity:
      type: varchar(20)
      description: How bad is the defect
      values:
        - critical (unusable)
        - major (rework needed)
        - minor (cosmetic)
      constraints:
        - not_null
    
    quantity_affected:
      type: integer
      description: Number of units with this defect
      constraints:
        - not_null
        - check: quantity_affected > 0
    
    # Detection
    detected_at:
      type: timestamp
      description: When defect was found
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    detected_by:
      type: uuid
      description: Who found the defect
      constraints:
        - not_null
        - foreign_key: users.id
    
    detection_stage:
      type: varchar(30)
      description: Where in process defect was found
      values:
        - in_process (during production)
        - final_inspection
        - customer (returned by customer)
      constraints:
        - not_null
    
    # Root Cause
    root_cause_category:
      type: varchar(50)
      description: Category of root cause
      values:
        - material_defect
        - equipment_malfunction
        - operator_error
        - process_variation
        - design_issue
        - environmental
        - unknown
    
    root_cause_description:
      type: text
      description: Detailed root cause analysis
    
    # Resolution
    resolution_action:
      type: varchar(30)
      description: What was done about the defect
      values:
        - scrapped
        - reworked
        - accepted_as_is
        - returned_to_vendor
      constraints:
        - not_null
    
    rework_time_minutes:
      type: integer
      description: Time spent fixing the defect
      constraints:
        - check: rework_time_minutes >= 0
    
    rework_cost:
      type: decimal
      description: Cost to rework or scrap
      constraints:
        - check: rework_cost >= 0
    
    resolved_at:
      type: timestamp
      description: When defect was resolved
    
    resolved_by:
      type: uuid
      description: Who resolved the defect
      constraints:
        - foreign_key: users.id
    
    # Prevention
    corrective_action:
      type: text
      description: What will prevent this from happening again
    
    preventive_action_taken:
      type: boolean
      description: Was preventive action implemented
      constraints:
        - default: false
    
    # Notes
    notes:
      type: text
      description: Additional details
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  indexes:
    - name: idx_quality_defects_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_quality_defects_production_run
      columns: [production_run_id]
      type: btree
    
    - name: idx_quality_defects_job
      columns: [job_id]
      type: btree
    
    - name: idx_quality_defects_detected_at
      columns: [tenant_id, detected_at]
      type: btree
    
    - name: idx_quality_defects_type_severity
      columns: [tenant_id, defect_type, severity]
      type: btree

  kpisEnabled:
    critical:
      - first_pass_yield
      - defect_rate
      - rework_rate
    
    high:
      - scrap_rate
      - quality_cost
      - root_cause_top_3
    
    medium:
      - defects_per_job
      - rework_time_average
      - customer_rejection_rate (if detection_stage = customer)

  relatedEntities:
    - production-run.yaml
    - job.yaml (core-entities.yaml)
    - equipment.yaml
    - customer-rejection.yaml

  migrationNotes: |
    Medium priority for Phase 5 - needed for quality KPIs.
    
    Migration Considerations:
    - High transaction volume table
    - Consider partitioning by detected_at (monthly)
    - Foreign key to production_runs must exist first
    - Integration with shop floor quality control systems
    
    Data Population:
    - Manual entry during inspection
    - Integration with vision systems
    - Customer complaint imports
    
    Blue-Green Deployment:
    - New table, safe to add
    - Depends on production_runs table existing

