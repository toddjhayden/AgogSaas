version: '0.1'
metadata:
  domain: equipment
  priority: high
  estimatedEffort: 1-week
  status: draft

entity:
  name: Equipment
  description: |
    Represents printing and finishing equipment with maintenance tracking.
    Links to equipment-status-log for OEE calculations.
    Includes maintenance records for PM compliance KPIs.
  
  tables:
    - name: equipment
      description: Equipment master data
    - name: maintenance_records
      description: Equipment maintenance history
      
  properties:
    # Equipment Master Data
    id:
      type: uuid
      description: UUIDv7 primary key
      constraints:
        - primary_key
        - default: uuid_generate_v7()
    
    tenant_id:
      type: uuid
      description: Multi-tenant isolation
      constraints:
        - not_null
        - foreign_key: tenants.id
        - indexed
    
    name:
      type: string
      description: Equipment name
      constraints:
        - not_null
    
    type:
      type: enum
      description: Equipment type
      values:
        - press
        - digital-press
        - cutter
        - folder
        - stitcher
        - perfect-binder
        - laminator
        - die-cutter
        - other
      constraints:
        - not_null
    
    model:
      type: string
      description: Equipment model
    
    serial_number:
      type: string
      description: Equipment serial number
      constraints:
        - unique: [tenant_id, serial_number]
    
    # Specifications
    specifications:
      type: jsonb
      description: Equipment technical specifications
      schema:
        type: object
        properties:
          max_sheet_size:
            width: number
            height: number
            unit: string
          min_sheet_size:
            width: number
            height: number
            unit: string
          max_speed:
            type: number
            description: Maximum production speed
          color_capacity:
            type: integer
      constraints:
        - not_null
        - default: "{}"
    
    # Status
    status:
      type: enum
      description: Current equipment status
      values:
        - idle
        - setup
        - running
        - maintenance
        - repair
        - offline
      constraints:
        - not_null
        - default: idle
    
    current_job_id:
      type: uuid
      description: Currently running job
      constraints:
        - foreign_key: jobs.id
    
    # Audit Fields
    created_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    updated_at:
      type: timestamp
      constraints:
        - not_null
        - default: CURRENT_TIMESTAMP
    
    created_by:
      type: uuid
      constraints:
        - foreign_key: users.id
    
    updated_by:
      type: uuid
      constraints:
        - foreign_key: users.id

  # Maintenance Records Entity
  maintenanceRecords:
    name: MaintenanceRecord
    description: Equipment maintenance history for PM compliance tracking
    
    properties:
      id:
        type: uuid
        description: UUIDv7 primary key
        constraints:
          - primary_key
          - default: uuid_generate_v7()
      
      tenant_id:
        type: uuid
        description: Multi-tenant isolation
        constraints:
          - not_null
          - foreign_key: tenants.id
          - indexed
      
      equipment_id:
        type: uuid
        description: Equipment being maintained
        constraints:
          - not_null
          - foreign_key: equipment.id
          - indexed
      
      maintenance_type:
        type: enum
        description: Type of maintenance
        values:
          - preventive
          - corrective
          - predictive
          - emergency
          - calibration
          - inspection
        constraints:
          - not_null
      
      scheduled_date:
        type: timestamp
        description: When maintenance was scheduled
        constraints:
          - not_null
      
      completed_date:
        type: timestamp
        description: When maintenance was completed (null if not completed)
      
      status:
        type: enum
        description: Maintenance record status
        values:
          - scheduled
          - in-progress
          - completed
          - cancelled
          - overdue
        constraints:
          - not_null
          - default: scheduled
      
      description:
        type: text
        description: Maintenance description
      
      technician_id:
        type: uuid
        description: Technician performing maintenance
        constraints:
          - foreign_key: users.id
      
      maintenance_cost:
        type: decimal
        description: Total cost of maintenance (labor + parts)
        constraints:
          - check: maintenance_cost >= 0
      
      parts_used:
        type: jsonb
        description: Parts used in maintenance
        schema:
          type: array
          items:
            type: object
            properties:
              part_number: string
              description: string
              quantity: integer
              cost: decimal
        constraints:
          - default: "[]"
      
      # Audit Fields
      created_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP
      
      updated_at:
        type: timestamp
        constraints:
          - not_null
          - default: CURRENT_TIMESTAMP
      
      created_by:
        type: uuid
        constraints:
          - foreign_key: users.id
      
      updated_by:
        type: uuid
        constraints:
          - foreign_key: users.id

  indexes:
    - name: idx_equipment_tenant
      columns: [tenant_id]
      type: btree
    
    - name: idx_equipment_type_status
      columns: [tenant_id, type, status]
      type: btree
    
    - name: idx_maintenance_equipment
      columns: [tenant_id, equipment_id, scheduled_date]
      type: btree
    
    - name: idx_maintenance_status
      columns: [tenant_id, status, scheduled_date]
      type: btree

  kpisEnabled:
    critical:
      - equipment_utilization_rate
      - equipment_uptime
    
    high:
      - equipment_downtime
      - mean_time_between_failures
      - preventive_maintenance_compliance
      - maintenance_cost_per_equipment
    
    medium:
      - availability_percentage
      - setup_time_average

  relatedEntities:
    - equipment-status-log.yaml
    - production-run.yaml
    - job.yaml

  migrationNotes: |
    Equipment entity with maintenance tracking for PM compliance KPI.
    MaintenanceRecord entity enables preventive_maintenance_compliance and maintenance_cost_per_equipment KPIs.
    
    Migration Considerations:
    - Two tables: equipment (master data), maintenance_records (historical tracking)
    - JSONB specifications allow flexible equipment configurations
    - Index on maintenance status and scheduled_date for PM tracking
    
    Blue-Green Deployment:
    - New tables, safe to add
    - Foreign key to jobs can be added after jobs table exists