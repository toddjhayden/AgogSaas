version: '3.8'

# K6 Load Testing Infrastructure
# REQ: REQ-P0-1768148786448-3r439 - Database stress testing
#
# This docker-compose file sets up:
# - K6 test runner
# - InfluxDB for metrics storage
# - Grafana for visualization

services:
  # InfluxDB - Time-series database for k6 metrics
  influxdb:
    image: influxdb:2.7-alpine
    container_name: k6-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=agogsaas
      - DOCKER_INFLUXDB_INIT_BUCKET=k6
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=k6-admin-token
    volumes:
      - k6-influxdb-data:/var/lib/influxdb2
    networks:
      - k6-network
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Grafana - Visualization dashboard
  grafana:
    image: grafana/grafana:10.3.0
    container_name: k6-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SERVER_ROOT_URL=http://localhost:3001
    volumes:
      - k6-grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - k6-network
    depends_on:
      influxdb:
        condition: service_healthy

  # K6 Test Runner
  k6:
    image: grafana/k6:0.49.0
    container_name: k6-runner
    networks:
      - k6-network
    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6
      - K6_INFLUXDB_ORGANIZATION=agogsaas
      - K6_INFLUXDB_BUCKET=k6
      - K6_INFLUXDB_TOKEN=k6-admin-token
      - BASE_URL=${BASE_URL:-http://host.docker.internal:4000}
      - DB_HOST=${DB_HOST:-host.docker.internal}
      - DB_PORT=${DB_PORT:-5433}
    volumes:
      - ./scenarios:/scenarios
      - ./tests:/tests
      - ./lib:/lib
      - ./config:/config
      - ./results:/results
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      influxdb:
        condition: service_healthy
    # By default, don't run any test - use docker-compose run commands
    entrypoint: ["sleep", "infinity"]

volumes:
  k6-influxdb-data:
    name: k6-influxdb-data
  k6-grafana-data:
    name: k6-grafana-data

networks:
  k6-network:
    name: k6-network
    driver: bridge
