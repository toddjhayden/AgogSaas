# =====================================================
# Workflow Automation Engine - GraphQL Schema
# REQ: REQ-STRATEGIC-AUTO-1767108044309
# =====================================================

# =====================================================
# TYPES
# =====================================================

type WorkflowDefinition {
  id: ID!
  tenantId: ID!
  name: String!
  description: String
  version: Int!
  isActive: Boolean!
  category: String
  triggerConfig: JSON!
  nodes: [WorkflowNode!]!
  routes: [WorkflowRoute!]!
  slaHours: Int
  escalationEnabled: Boolean!
  escalationUserId: ID
  createdBy: ID
  createdAt: DateTime!
  updatedAt: DateTime!
}

type WorkflowNode {
  id: ID!
  nodeType: WorkflowNodeType!
  name: String!
  approverUserId: ID
  approverRole: String
  approvalLogic: ApprovalLogicType
  serviceType: ServiceTaskType
  serviceConfig: JSON
  formFields: [FormField!]
  assignedUserId: ID
  assignedRole: String
  conditionType: ConditionType
  conditionExpression: String
  slaHours: Int
  timeoutAction: TimeoutAction
}

type WorkflowRoute {
  fromNodeId: ID!
  toNodeId: ID!
  condition: String
  isDefault: Boolean
}

type FormField {
  name: String!
  type: String!
  label: String
  required: Boolean
  options: [String!]
}

type WorkflowInstance {
  id: ID!
  tenantId: ID!
  workflowDefinitionId: ID!
  workflowName: String!
  workflowVersion: Int!
  contextEntityType: String
  contextEntityId: ID
  contextData: JSON
  status: WorkflowStatus!
  currentNodeId: String
  startedAt: DateTime!
  completedAt: DateTime
  slaDeadline: DateTime
  createdBy: ID
  createdAt: DateTime!
  updatedAt: DateTime!
  nodes: [WorkflowInstanceNode!]
  history: [WorkflowHistoryEntry!]
}

type WorkflowInstanceNode {
  id: ID!
  tenantId: ID!
  instanceId: ID!
  nodeId: ID!
  nodeName: String
  nodeType: WorkflowNodeType
  status: NodeStatus!
  assignedUserId: ID
  startedAt: DateTime
  completedAt: DateTime
  slaDeadline: DateTime
  action: NodeAction
  actionByUserId: ID
  actionDate: DateTime
  comments: String
  outputData: JSON
  createdAt: DateTime!
  retryCount: Int
  nextRetryAt: DateTime
  lastRetryError: String
  circuitBreakerOpen: Boolean
}

type WorkflowHistoryEntry {
  id: ID!
  tenantId: ID!
  instanceId: ID!
  nodeId: String
  eventType: WorkflowEventType!
  eventByUserId: ID
  eventDate: DateTime!
  eventData: JSON
  instanceSnapshot: JSON
  createdAt: DateTime!
}

type UserTask {
  taskId: ID!
  instanceId: ID!
  workflowName: String!
  taskName: String!
  nodeType: WorkflowNodeType!
  assignedUserId: ID!
  slaDeadline: DateTime
  urgencyLevel: UrgencyLevel!
  hoursRemaining: Float
  isOverdue: Boolean!
  contextEntityType: String
  contextEntityId: ID
  contextData: JSON
  taskCreatedAt: DateTime!
  tenantId: ID!
}

type WorkflowAnalytics {
  workflowDefinitionId: ID!
  workflowName: String!
  workflowVersion: Int!
  category: String
  tenantId: ID!
  totalInstances: Int!
  completedInstances: Int!
  failedInstances: Int!
  runningInstances: Int!
  escalatedInstances: Int!
  avgCompletionHours: Float
  onTimeCompletions: Int!
  lateCompletions: Int!
  slaCompliancePercentage: Float
}

# =====================================================
# ENUMS
# =====================================================

enum WorkflowNodeType {
  APPROVAL
  SERVICE_TASK
  USER_TASK
  GATEWAY
  SUB_WORKFLOW
}

enum ApprovalLogicType {
  SEQUENTIAL
  PARALLEL
  ANY_ONE
}

enum ServiceTaskType {
  AGENT_SPAWN
  HTTP_CALL
  DATABASE_QUERY
  EMAIL_SEND
}

enum ConditionType {
  AMOUNT_BASED
  FIELD_VALUE
  EXPRESSION
}

enum TimeoutAction {
  ESCALATE
  AUTO_APPROVE
  FAIL
}

enum WorkflowStatus {
  RUNNING
  COMPLETED
  FAILED
  BLOCKED
  ESCALATED
  CANCELLED
}

enum NodeStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  SKIPPED
}

enum NodeAction {
  APPROVED
  REJECTED
  COMPLETED
  FAILED
  DELEGATED
  ESCALATED
}

enum WorkflowEventType {
  STARTED
  NODE_ENTERED
  NODE_COMPLETED
  APPROVED
  REJECTED
  ESCALATED
  COMPLETED
  FAILED
  DELEGATED
  CANCELLED
  SLA_BREACHED
}

enum UrgencyLevel {
  URGENT
  WARNING
  NORMAL
}

# =====================================================
# INPUTS
# =====================================================

input CreateWorkflowDefinitionInput {
  name: String!
  description: String
  category: String
  triggerConfig: JSON!
  nodes: [WorkflowNodeInput!]!
  routes: [WorkflowRouteInput!]!
  slaHours: Int
  escalationEnabled: Boolean
  escalationUserId: ID
}

input WorkflowNodeInput {
  id: ID!
  nodeType: WorkflowNodeType!
  name: String!
  approverUserId: ID
  approverRole: String
  approvalLogic: ApprovalLogicType
  serviceType: ServiceTaskType
  serviceConfig: JSON
  formFields: [FormFieldInput!]
  assignedUserId: ID
  assignedRole: String
  conditionType: ConditionType
  conditionExpression: String
  slaHours: Int
  timeoutAction: TimeoutAction
}

input WorkflowRouteInput {
  fromNodeId: ID!
  toNodeId: ID!
  condition: String
  isDefault: Boolean
}

input FormFieldInput {
  name: String!
  type: String!
  label: String
  required: Boolean
  options: [String!]
}

input UpdateWorkflowDefinitionInput {
  name: String
  description: String
  category: String
  triggerConfig: JSON
  nodes: [WorkflowNodeInput!]
  routes: [WorkflowRouteInput!]
  slaHours: Int
  escalationEnabled: Boolean
  escalationUserId: ID
}

input StartWorkflowInput {
  workflowDefinitionId: ID!
  contextEntityType: String!
  contextEntityId: ID!
  contextData: JSON
}

# =====================================================
# WORKFLOW RECOVERY & MONITORING TYPES
# REQ: REQ-1767126043619
# =====================================================

type WorkflowCheckpoint {
  checkpointId: ID!
  instanceId: ID!
  nodeKey: String!
  stateSnapshot: JSON!
  sequenceNumber: Int!
  canRollback: Boolean!
  createdAt: DateTime!
  tenantId: ID!
}

type CheckpointSummary {
  instanceId: ID!
  totalCheckpoints: Int!
  latestSequence: Int!
  lastCheckpointAt: DateTime!
  rollbackableCheckpoints: Int!
}

type RetryState {
  instanceId: ID!
  nodeKey: String!
  attemptNumber: Int!
  nextRetryAt: DateTime!
  lastError: String!
  circuitBreakerOpen: Boolean!
}

type CircuitBreakerStatus {
  nodeKey: String!
  state: CircuitBreakerState!
  failureRate: Float!
  totalAttempts: Int!
}

enum CircuitBreakerState {
  CLOSED
  OPEN
  HALF_OPEN
}

type DLQMessage {
  dlqId: ID!
  source: DLQSource!
  payload: JSON!
  error: String!
  metadata: JSON!
  status: DLQStatus!
  assignedTo: String
  resolution: String
  createdAt: DateTime!
  updatedAt: DateTime!
  tenantId: ID!
}

enum DLQSource {
  WORKFLOW
  NATS
  ORCHESTRATOR
}

enum DLQStatus {
  PENDING
  INVESTIGATING
  REPLAYING
  DISCARDED
}

type DLQMetrics {
  totalMessages: Int!
  bySource: JSON!
  byStatus: JSON!
  oldestMessage: DateTime
  averageAgeHours: Float!
}

type DLQReplayResult {
  total: Int!
  succeeded: Int!
  failed: Int!
}

# =====================================================
# QUERIES
# =====================================================

type Query {
  # Workflow Definitions
  workflowDefinitions(
    tenantId: ID!
    isActive: Boolean
    category: String
  ): [WorkflowDefinition!]!

  workflowDefinition(id: ID!): WorkflowDefinition

  # Workflow Instances
  workflowInstances(
    status: WorkflowStatus
    entityType: String
    limit: Int
  ): [WorkflowInstance!]!

  workflowInstance(id: ID!): WorkflowInstance

  workflowInstanceHistory(instanceId: ID!): [WorkflowHistoryEntry!]!

  # User Tasks
  myPendingTasks(
    urgencyLevel: UrgencyLevel
    limit: Int
  ): [UserTask!]!

  # Analytics
  workflowAnalytics(
    workflowDefinitionId: ID
    category: String
  ): [WorkflowAnalytics!]!

  # Workflow Recovery & Monitoring (REQ: REQ-1767126043619)
  workflowCheckpoints(instanceId: ID!): [WorkflowCheckpoint!]!
  checkpointSummary(instanceId: ID!): CheckpointSummary
  latestCheckpoint(instanceId: ID!): WorkflowCheckpoint
  pendingRetries: [RetryState!]!
  circuitBreakerStatus(nodeKey: String!): CircuitBreakerStatus!
  dlqMessages(source: DLQSource, status: DLQStatus, limit: Int): [DLQMessage!]!
  dlqMessage(dlqId: ID!): DLQMessage
  dlqMetrics: DLQMetrics!
}

# =====================================================
# MUTATIONS
# =====================================================

type Mutation {
  # Workflow Definition Management
  createWorkflowDefinition(
    input: CreateWorkflowDefinitionInput!
  ): WorkflowDefinition!

  updateWorkflowDefinition(
    id: ID!
    input: UpdateWorkflowDefinitionInput!
  ): WorkflowDefinition!

  publishWorkflowDefinition(id: ID!): WorkflowDefinition!

  archiveWorkflowDefinition(id: ID!): WorkflowDefinition!

  # Workflow Execution
  startWorkflow(input: StartWorkflowInput!): WorkflowInstance!

  # User Actions on Tasks
  approveTask(
    taskId: ID!
    comments: String
  ): WorkflowInstance!

  rejectTask(
    taskId: ID!
    reason: String!
  ): WorkflowInstance!

  delegateTask(
    taskId: ID!
    delegateToUserId: ID!
  ): WorkflowInstance!

  completeUserTask(
    taskId: ID!
    formData: JSON!
  ): WorkflowInstance!

  # Instance Management
  cancelWorkflow(instanceId: ID!): WorkflowInstance!

  # Workflow Recovery & Monitoring (REQ: REQ-1767126043619)
  restoreFromCheckpoint(checkpointId: ID!): WorkflowInstance!
  validateCheckpoint(checkpointId: ID!): Boolean!
  deleteCheckpoint(checkpointId: ID!): Boolean!
  resetCircuitBreaker(nodeKey: String!): Boolean!
  replayDLQMessage(dlqId: ID!): Boolean!
  replayAllDLQMessages(source: DLQSource): DLQReplayResult!
  discardDLQMessage(dlqId: ID!, reason: String!): Boolean!
  assignDLQMessage(dlqId: ID!, assignedTo: String!): Boolean!
}

# =====================================================
# SCALARS
# =====================================================

scalar DateTime
scalar JSON
