# ============================================
# Customer Portal & Self-Service Ordering
# ============================================
# REQ: REQ-STRATEGIC-AUTO-1767048328659
# Purpose: GraphQL schema for customer portal authentication and self-service ordering
# Research: CYNTHIA_RESEARCH_DELIVERABLE_REQ-STRATEGIC-AUTO-1767048328659.md
# Critique: SYLVIA_CRITIQUE_DELIVERABLE_REQ-STRATEGIC-AUTO-1767048328659.md
# ============================================

# ============================================
# AUTHENTICATION TYPES
# ============================================

type CustomerUser {
  id: ID!
  customerId: ID!
  email: String!
  firstName: String
  lastName: String
  phone: String
  role: CustomerUserRole!
  mfaEnabled: Boolean!
  isEmailVerified: Boolean!
  isActive: Boolean!
  preferredLanguage: String
  timezone: String
  lastLoginAt: DateTime
  customer: Customer!
}

enum CustomerUserRole {
  CUSTOMER_ADMIN
  CUSTOMER_USER
  APPROVER
}

type CustomerAuthPayload {
  accessToken: String!
  refreshToken: String!
  expiresAt: DateTime!
  user: CustomerUser!
  customer: Customer!
  permissions: [String!]!
}

type MFAEnrollmentPayload {
  secret: String!
  qrCodeUrl: String!
  backupCodes: [String!]!
}

# ============================================
# ORDER AND QUOTE TYPES
# ============================================

type CustomerOrdersResult {
  orders: [SalesOrder!]!
  total: Int!
  hasMore: Boolean!
}

type CustomerQuotesResult {
  quotes: [Quote!]!
  total: Int!
  hasMore: Boolean!
}

type ArtworkFile {
  id: ID!
  orderId: ID
  quoteId: ID
  fileName: String!
  fileUrl: String!
  fileType: String!
  fileSizeBytes: Int!
  virusScanStatus: String!
  uploadedAt: DateTime!
}

type Proof {
  id: ID!
  orderId: ID!
  proofUrl: String!
  version: Int!
  status: ProofStatus!
  approvedAt: DateTime
  approvedBy: ID
  revisionNotes: String
  customerComments: String
}

enum ProofStatus {
  PENDING_REVIEW
  APPROVED
  REVISION_REQUESTED
  SUPERSEDED
}

# ============================================
# INPUT TYPES
# ============================================

input CustomerQuoteRequestInput {
  productId: ID!
  quantity: Float!
  specifications: JSON
  artworkFileUrl: String
  requestedDeliveryDate: Date
  notes: String
  customerPoNumber: String
}

input CustomerProfileUpdateInput {
  firstName: String
  lastName: String
  phone: String
  preferredLanguage: String
  timezone: String
  notificationPreferences: JSON
}

# ============================================
# AUTHENTICATION MUTATIONS
# ============================================

extend type Mutation {
  # ============================================
  # Registration & Login
  # ============================================

  """
  Register new customer portal user (self-service registration)
  Requires valid customer code for verification
  """
  customerRegister(
    customerCode: String!
    email: String!
    password: String!
    firstName: String!
    lastName: String!
  ): CustomerAuthPayload!

  """
  Customer portal login with email and password
  Optionally includes MFA code if enabled
  """
  customerLogin(
    email: String!
    password: String!
    mfaCode: String
  ): CustomerAuthPayload!

  """
  Refresh access token using refresh token
  Returns new access token and refresh token
  """
  customerRefreshToken(refreshToken: String!): CustomerAuthPayload!

  """
  Logout and invalidate refresh token
  """
  customerLogout: Boolean!

  # ============================================
  # Password Management
  # ============================================

  """
  Request password reset email
  Sends email with reset link to customer
  """
  customerRequestPasswordReset(email: String!): Boolean!

  """
  Reset password using token from email
  """
  customerResetPassword(token: String!, newPassword: String!): Boolean!

  """
  Change password (requires current password)
  """
  customerChangePassword(oldPassword: String!, newPassword: String!): Boolean!

  # ============================================
  # Email Verification
  # ============================================

  """
  Verify email address using token from email
  """
  customerVerifyEmail(token: String!): Boolean!

  """
  Resend email verification email
  """
  customerResendVerificationEmail: Boolean!

  # ============================================
  # Multi-Factor Authentication (MFA)
  # ============================================

  """
  Enroll in MFA (generates TOTP secret and QR code)
  Returns secret, QR code URL, and backup codes
  """
  customerEnrollMFA: MFAEnrollmentPayload!

  """
  Verify MFA enrollment with TOTP code
  Completes MFA setup
  """
  customerVerifyMFA(code: String!): Boolean!

  """
  Disable MFA (requires password confirmation)
  """
  customerDisableMFA(password: String!): Boolean!

  """
  Regenerate backup codes (requires password confirmation)
  Returns new set of backup codes (one-time use)
  """
  customerRegenerateBackupCodes(password: String!): [String!]!

  # ============================================
  # Profile Management
  # ============================================

  """
  Update customer user profile
  """
  customerUpdateProfile(input: CustomerProfileUpdateInput!): CustomerUser!

  # ============================================
  # Self-Service Ordering
  # ============================================

  """
  Request a quote for a product
  Optionally include artwork file URL
  """
  customerRequestQuote(input: CustomerQuoteRequestInput!): Quote!

  """
  Approve a quote and convert to sales order
  """
  customerApproveQuote(
    quoteId: ID!
    purchaseOrderNumber: String
    requestedDeliveryDate: Date
  ): SalesOrder!

  """
  Reject a quote with optional reason
  """
  customerRejectQuote(
    quoteId: ID!
    reason: String
  ): Quote!

  """
  Reorder from a previous order
  Creates new order with same specifications
  """
  customerReorder(
    originalOrderId: ID!
    quantity: Float
    requestedDeliveryDate: Date
  ): SalesOrder!

  """
  Upload artwork file for quote or order
  Returns presigned URL for direct upload to S3
  """
  customerRequestArtworkUpload(
    fileName: String!
    fileSize: Int!
    fileType: String!
    quoteId: ID
    orderId: ID
  ): ArtworkUploadUrl!

  """
  Confirm artwork upload completion
  Triggers virus scanning
  """
  customerConfirmArtworkUpload(
    fileId: ID!
    storageUrl: String!
  ): ArtworkFile!

  """
  Approve a proof
  """
  customerApproveProof(
    proofId: ID!
    comments: String
  ): Proof!

  """
  Request proof revision
  """
  customerRequestProofRevision(
    proofId: ID!
    revisionNotes: String!
  ): Proof!
}

# ============================================
# CUSTOMER PORTAL QUERIES
# ============================================

extend type Query {
  # ============================================
  # User & Account
  # ============================================

  """
  Get current customer user info
  """
  customerMe: CustomerUser!

  # ============================================
  # Orders
  # ============================================

  """
  Get customer order history with filtering
  """
  customerOrders(
    status: SalesOrderStatus
    dateFrom: Date
    dateTo: Date
    limit: Int = 50
    offset: Int = 0
  ): CustomerOrdersResult!

  """
  Get specific order by order number
  """
  customerOrder(orderNumber: String!): SalesOrder!

  # ============================================
  # Quotes
  # ============================================

  """
  Get customer quote history
  """
  customerQuotes(
    status: QuoteStatus
    limit: Int = 50
    offset: Int = 0
  ): CustomerQuotesResult!

  """
  Get specific quote by quote number
  """
  customerQuote(quoteNumber: String!): Quote!

  # ============================================
  # Products & Catalog
  # ============================================

  """
  Get products available to this customer
  Filtered by customer-specific pricing and permissions
  """
  customerProducts(
    category: String
    search: String
    limit: Int = 100
  ): [Product!]!

  # ============================================
  # Proofs
  # ============================================

  """
  Get pending proofs for customer review
  """
  customerPendingProofs: [Proof!]!

  """
  Get proof history for an order
  """
  customerOrderProofs(orderNumber: String!): [Proof!]!

  # ============================================
  # Artwork Files
  # ============================================

  """
  Get artwork files for a quote or order
  """
  customerArtworkFiles(
    quoteId: ID
    orderId: ID
  ): [ArtworkFile!]!
}

# ============================================
# ADDITIONAL TYPES
# ============================================

type ArtworkUploadUrl {
  uploadUrl: String!
  fileId: ID!
  expiresAt: DateTime!
  maxSizeBytes: Int!
  allowedFileTypes: [String!]!
}

# ============================================
# SCALARS (if not already defined)
# ============================================

scalar DateTime
scalar Date
scalar JSON
