# ============================================================================
# INVENTORY FORECASTING SCHEMA
# ============================================================================
# Purpose: Demand forecasting, safety stock, and replenishment planning
# REQ: REQ-STRATEGIC-AUTO-1766675619639 - Inventory Forecasting
# ============================================================================

# ============================================================================
# SCALAR TYPES
# ============================================================================

scalar Date
scalar DateTime
scalar JSON

# ============================================================================
# ENUMS
# ============================================================================

enum ForecastHorizonType {
  SHORT_TERM
  MEDIUM_TERM
  LONG_TERM
}

enum ForecastAlgorithm {
  SARIMA
  LIGHTGBM
  MOVING_AVERAGE
  EXP_SMOOTHING
  HOLT_WINTERS
  AUTO
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RecommendationStatus {
  PENDING
  APPROVED
  REJECTED
  CONVERTED_TO_PO
  EXPIRED
}

enum ForecastStatus {
  ACTIVE
  SUPERSEDED
  REJECTED
}

enum DemandPattern {
  STABLE
  SEASONAL
  INTERMITTENT
  LUMPY
  ERRATIC
}

# ============================================================================
# TYPES
# ============================================================================

type DemandHistory {
  demandHistoryId: ID!
  tenantId: ID!
  facilityId: ID!
  materialId: ID!

  demandDate: Date!
  year: Int!
  month: Int!
  weekOfYear: Int!
  dayOfWeek: Int!
  quarter: Int!
  isHoliday: Boolean!
  isPromotionalPeriod: Boolean!

  actualDemandQuantity: Float!
  forecastedDemandQuantity: Float
  demandUom: String!

  salesOrderDemand: Float!
  productionOrderDemand: Float!
  transferOrderDemand: Float!
  scrapAdjustment: Float!

  avgUnitPrice: Float
  promotionalDiscountPct: Float
  marketingCampaignActive: Boolean!

  forecastError: Float
  absolutePercentageError: Float

  createdAt: DateTime!
  createdBy: String
}

type MaterialForecast {
  forecastId: ID!
  tenantId: ID!
  facilityId: ID!
  materialId: ID!
  forecastModelId: ID

  forecastGenerationTimestamp: DateTime!
  forecastVersion: Int!
  forecastHorizonType: ForecastHorizonType!
  forecastAlgorithm: ForecastAlgorithm!

  forecastDate: Date!
  forecastYear: Int!
  forecastMonth: Int!
  forecastWeekOfYear: Int!

  forecastedDemandQuantity: Float!
  forecastUom: String!

  lowerBound80Pct: Float
  upperBound80Pct: Float
  lowerBound95Pct: Float
  upperBound95Pct: Float

  modelConfidenceScore: Float

  isManuallyOverridden: Boolean!
  manualOverrideQuantity: Float
  manualOverrideBy: String
  manualOverrideReason: String

  forecastStatus: ForecastStatus!

  createdAt: DateTime!
}

type SafetyStockCalculation {
  materialId: ID!
  safetyStockQuantity: Float!
  reorderPoint: Float!
  economicOrderQuantity: Float!
  calculationMethod: String!
  avgDailyDemand: Float!
  demandStdDev: Float!
  avgLeadTimeDays: Float!
  leadTimeStdDev: Float!
  serviceLevel: Float!
  zScore: Float!
}

type ForecastAccuracySummary {
  materialId: ID!
  last30DaysMape: Float
  last60DaysMape: Float
  last90DaysMape: Float
  last30DaysBias: Float
  last60DaysBias: Float
  last90DaysBias: Float
  totalForecastsGenerated: Int!
  totalActualDemandRecorded: Int!
  currentForecastAlgorithm: ForecastAlgorithm
  lastForecastGenerationDate: DateTime
}

type ForecastAccuracyMetrics {
  metricId: ID!
  tenantId: ID!
  facilityId: ID!
  materialId: ID!
  forecastModelId: ID
  measurementPeriodStart: Date!
  measurementPeriodEnd: Date!
  aggregationLevel: String!
  mape: Float
  rmse: Float
  mae: Float
  bias: Float
  trackingSignal: Float
  sampleSize: Int!
  totalActualDemand: Float!
  totalForecastedDemand: Float!
  isWithinTolerance: Boolean!
  targetMapeThreshold: Float!
  createdAt: DateTime!
}

type ReplenishmentRecommendation {
  suggestionId: ID!
  tenantId: ID!
  facilityId: ID!
  materialId: ID!
  preferredVendorId: ID
  suggestionGenerationTimestamp: DateTime!
  suggestionStatus: RecommendationStatus!
  currentOnHandQuantity: Float!
  currentAllocatedQuantity: Float!
  currentAvailableQuantity: Float!
  currentOnOrderQuantity: Float!
  safetyStockQuantity: Float!
  reorderPointQuantity: Float!
  economicOrderQuantity: Float!
  forecastedDemand30Days: Float!
  forecastedDemand60Days: Float
  forecastedDemand90Days: Float
  projectedStockoutDate: Date
  recommendedOrderQuantity: Float!
  recommendedOrderUom: String!
  recommendedOrderDate: Date!
  recommendedDeliveryDate: Date
  estimatedUnitCost: Float
  estimatedTotalCost: Float
  vendorLeadTimeDays: Int
  suggestionReason: String!
  calculationMethod: String!
  urgencyLevel: UrgencyLevel
  daysUntilStockout: Int
  createdAt: DateTime!
}

# ============================================================================
# INPUTS
# ============================================================================

input GenerateForecastInput {
  tenantId: ID!
  facilityId: ID!
  materialIds: [ID!]!
  forecastHorizonDays: Int!
  forecastAlgorithm: ForecastAlgorithm
}

input RecordDemandInput {
  tenantId: ID!
  facilityId: ID!
  materialId: ID!
  demandDate: Date!
  actualDemandQuantity: Float!
  demandUom: String!
  salesOrderDemand: Float
  productionOrderDemand: Float
  transferOrderDemand: Float
  scrapAdjustment: Float
  avgUnitPrice: Float
  promotionalDiscountPct: Float
  marketingCampaignActive: Boolean
}

input CalculateSafetyStockInput {
  tenantId: ID!
  facilityId: ID!
  materialId: ID!
  serviceLevel: Float
}

input CalculateAccuracyInput {
  tenantId: ID!
  facilityId: ID!
  materialId: ID!
  periodStart: Date!
  periodEnd: Date!
  aggregationLevel: String
}

input GenerateRecommendationsInput {
  tenantId: ID!
  facilityId: ID!
  materialIds: [ID!]
  urgencyLevelFilter: UrgencyLevel
}

# ============================================================================
# QUERIES
# ============================================================================

type Query {
  """
  Get demand history for a material within a date range
  """
  getDemandHistory(
    tenantId: ID!
    facilityId: ID!
    materialId: ID!
    startDate: Date!
    endDate: Date!
  ): [DemandHistory!]!

  """
  Get forecasts for a material within a date range
  """
  getMaterialForecasts(
    tenantId: ID!
    facilityId: ID!
    materialId: ID!
    startDate: Date!
    endDate: Date!
    forecastStatus: ForecastStatus
  ): [MaterialForecast!]!

  """
  Calculate safety stock for a material
  """
  calculateSafetyStock(
    input: CalculateSafetyStockInput!
  ): SafetyStockCalculation!

  """
  Get forecast accuracy summary for materials
  """
  getForecastAccuracySummary(
    tenantId: ID!
    facilityId: ID!
    materialIds: [ID!]
  ): [ForecastAccuracySummary!]!

  """
  Get detailed forecast accuracy metrics
  """
  getForecastAccuracyMetrics(
    tenantId: ID!
    facilityId: ID!
    materialId: ID!
    periodStart: Date
    periodEnd: Date
  ): [ForecastAccuracyMetrics!]!

  """
  Get replenishment recommendations
  """
  getReplenishmentRecommendations(
    tenantId: ID!
    facilityId: ID!
    status: RecommendationStatus
    materialId: ID
  ): [ReplenishmentRecommendation!]!
}

# ============================================================================
# MUTATIONS
# ============================================================================

type Mutation {
  """
  Generate forecasts for materials
  """
  generateForecasts(
    input: GenerateForecastInput!
  ): [MaterialForecast!]!

  """
  Record actual demand for a material
  """
  recordDemand(
    input: RecordDemandInput!
  ): DemandHistory!

  """
  Backfill historical demand from inventory transactions
  """
  backfillDemandHistory(
    tenantId: ID!
    facilityId: ID!
    startDate: Date!
    endDate: Date!
  ): Int!

  """
  Calculate forecast accuracy metrics for a material
  """
  calculateForecastAccuracy(
    input: CalculateAccuracyInput!
  ): ForecastAccuracyMetrics!

  """
  Generate replenishment recommendations
  """
  generateReplenishmentRecommendations(
    input: GenerateRecommendationsInput!
  ): [ReplenishmentRecommendation!]!
}
