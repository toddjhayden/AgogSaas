# ===================================================================
# WMS Optimization Schema
# REQ-STRATEGIC-AUTO-1766476803478: Optimize Bin Utilization Algorithm
# ===================================================================

# ===================================================================
# Types
# ===================================================================

type CrossDockOpportunity {
  shouldCrossDock: Boolean!
  reason: String!
  salesOrderId: ID
  urgency: CrossDockUrgency!
}

enum CrossDockUrgency {
  CRITICAL
  HIGH
  MEDIUM
  NONE
}

type AisleCongestionMetrics {
  aisleCode: String!
  currentActivePickLists: Int!
  avgPickTimeMinutes: Float!
  congestionScore: Float!
  congestionLevel: CongestionLevel!
}

enum CongestionLevel {
  HIGH
  MEDIUM
  LOW
  NONE
}

type EnhancedPutawayRecommendation {
  locationId: ID!
  locationCode: String!
  locationType: String!
  algorithm: String!
  confidenceScore: Float!
  mlAdjustedConfidence: Float
  reason: String!
  utilizationAfterPlacement: Float!
  availableCapacityAfter: Float!
  pickSequence: Int
  congestionPenalty: Float
  crossDockRecommendation: CrossDockOpportunity
}

type BatchPutawayResult {
  recommendations: [LotPutawayRecommendation!]!
  totalItems: Int!
  avgConfidenceScore: Float!
  crossDockOpportunities: Int!
  processingTimeMs: Int!
}

type LotPutawayRecommendation {
  lotNumber: String!
  materialId: ID!
  recommendation: EnhancedPutawayRecommendation!
}

type ReSlottingTriggerEvent {
  type: ReSlottingTriggerType!
  materialId: ID!
  materialName: String
  currentABCClass: String!
  calculatedABCClass: String!
  velocityChange: Float!
  triggeredAt: String!
  priority: String!
}

enum ReSlottingTriggerType {
  VELOCITY_SPIKE
  VELOCITY_DROP
  SEASONAL_CHANGE
  NEW_PRODUCT
  PROMOTION
}

type MaterialVelocityAnalysis {
  materialId: ID!
  materialName: String!
  currentABC: String!
  recentPicks30d: Int!
  recentValue30d: Float!
  historicalPicks150d: Int!
  historicalValue150d: Float!
  velocityChangePct: Float!
  velocitySpike: Boolean!
  velocityDrop: Boolean!
  recommendedAction: String
}

type MLAccuracyMetrics {
  overallAccuracy: Float!
  totalRecommendations: Int!
  byAlgorithm: [AlgorithmAccuracy!]!
  lastUpdated: String!
}

type AlgorithmAccuracy {
  algorithm: String!
  accuracy: Float!
  count: Int!
}

type BinUtilizationCacheEntry {
  locationId: ID!
  locationCode: String!
  locationType: String!
  zoneCode: String
  aisleCode: String
  volumeUtilizationPct: Float!
  weightUtilizationPct: Float!
  utilizationStatus: UtilizationStatus!
  availableCubicFeet: Float!
  availableWeight: Float!
  lotCount: Int!
  materialCount: Int!
  lastUpdated: String!
}

enum UtilizationStatus {
  UNDERUTILIZED
  NORMAL
  OPTIMAL
  OVERUTILIZED
}

type OptimizationRecommendation {
  type: OptimizationType!
  priority: OptimizationPriority!
  locationId: ID!
  locationCode: String!
  currentUtilization: Float
  reason: String!
  expectedImpact: String!
  materialId: ID
  materialName: String
}

enum OptimizationType {
  CONSOLIDATE
  REBALANCE
  RELOCATE
  CROSS_DOCK
  RESLOT
}

enum OptimizationPriority {
  HIGH
  MEDIUM
  LOW
}

type HealthCheckResult {
  status: HealthStatus!
  message: String!
  lastRefresh: String
  accuracy: Float
  sampleSize: Int
  aisleCount: Int
  queryTimeMs: Int
  processingTimeMs: Int
  note: String
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
}

type BinOptimizationHealthCheck {
  status: HealthStatus!
  checks: HealthChecks!
  timestamp: String!
}

type HealthChecks {
  materializedViewFreshness: HealthCheckResult!
  mlModelAccuracy: HealthCheckResult!
  congestionCacheHealth: HealthCheckResult!
  databasePerformance: HealthCheckResult!
  algorithmPerformance: HealthCheckResult!
}

# ===================================================================
# Inputs
# ===================================================================

input BatchPutawayInput {
  facilityId: ID!
  items: [PutawayItemInput!]!
}

input PutawayItemInput {
  materialId: ID!
  lotNumber: String!
  quantity: Float!
  dimensions: ItemDimensionsInput
}

input ItemDimensionsInput {
  lengthInches: Float!
  widthInches: Float!
  heightInches: Float!
  weightLbsPerUnit: Float!
}

# ===================================================================
# Queries
# ===================================================================

extend type Query {
  """
  Get enhanced batch putaway recommendations using Best Fit Decreasing algorithm
  Performance: O(n log n) vs O(nÂ²) for sequential processing
  """
  getBatchPutawayRecommendations(input: BatchPutawayInput!): BatchPutawayResult!

  """
  Get real-time aisle congestion metrics for optimization
  """
  getAisleCongestionMetrics(facilityId: ID!): [AisleCongestionMetrics!]!

  """
  Detect cross-dock opportunity for a material
  """
  detectCrossDockOpportunity(
    materialId: ID!
    quantity: Float!
  ): CrossDockOpportunity!

  """
  Get current bin utilization from cache (fast lookup)
  """
  getBinUtilizationCache(
    facilityId: ID!
    locationId: ID
    utilizationStatus: UtilizationStatus
  ): [BinUtilizationCacheEntry!]!

  """
  Get materials with velocity changes requiring re-slotting
  """
  getReSlottingTriggers(facilityId: ID!): [ReSlottingTriggerEvent!]!

  """
  Get material velocity analysis for ABC re-classification
  """
  getMaterialVelocityAnalysis(
    facilityId: ID!
    minVelocityChangePct: Float
  ): [MaterialVelocityAnalysis!]!

  """
  Get ML model accuracy metrics
  """
  getMLAccuracyMetrics: MLAccuracyMetrics!

  """
  Get optimization recommendations for warehouse
  """
  getOptimizationRecommendations(
    facilityId: ID!
    limit: Int
  ): [OptimizationRecommendation!]!

  """
  Get comprehensive health status of bin optimization system
  """
  getBinOptimizationHealth: BinOptimizationHealthCheck!
}

# ===================================================================
# Mutations
# ===================================================================

extend type Mutation {
  """
  Record putaway recommendation decision for ML training
  """
  recordPutawayDecision(
    recommendationId: ID!
    accepted: Boolean!
    actualLocationId: ID
  ): Boolean!

  """
  Trigger ML model training with recent feedback
  """
  trainMLModel: Boolean!

  """
  Refresh bin utilization cache for specific location
  """
  refreshBinUtilizationCache(locationId: ID): Boolean!

  """
  Execute automated re-slotting for triggered events
  """
  executeAutomatedReSlotting(
    facilityId: ID!
    materialIds: [ID!]
  ): Boolean!
}
