# =====================================================
# PERFORMANCE ANALYTICS SCHEMA
# =====================================================
# Real-time performance monitoring and optimization dashboard
# Tracks API performance, database query performance, and system resources
# =====================================================

type Query {
  """
  Get system-wide performance overview
  """
  performanceOverview(
    facilityId: ID
    timeRange: TimeRange!
  ): PerformanceOverview!

  """
  Get slow queries in time range
  """
  slowQueries(
    facilityId: ID
    threshold: Int = 1000
    timeRange: TimeRange!
    limit: Int = 100
  ): [QueryPerformanceMetric!]!

  """
  Get API endpoint performance statistics
  """
  endpointMetrics(
    endpoint: String
    timeRange: TimeRange!
  ): [EndpointMetric!]!

  """
  Get resource utilization time series
  """
  resourceUtilization(
    facilityId: ID
    timeRange: TimeRange!
    interval: String = "5m"
  ): [ResourceMetric!]!

  """
  Get database connection pool health
  """
  databasePoolMetrics(
    timeRange: TimeRange!
  ): DatabasePoolMetrics!

  """
  Get real-time database statistics
  """
  databaseStats: DatabaseStats!
}

type PerformanceOverview {
  timeRange: TimeRange!

  # Overall health
  healthScore: Float!
  status: HealthStatus!

  # API Performance
  avgResponseTimeMs: Float!
  p95ResponseTimeMs: Float!
  p99ResponseTimeMs: Float!
  requestsPerSecond: Float!
  errorRate: Float!

  # Database Performance
  avgQueryTimeMs: Float!
  slowQueryCount: Int!
  connectionPoolUtilization: Float!

  # Resource Utilization
  avgCpuUsagePercent: Float!
  avgMemoryUsageMB: Float!
  maxMemoryUsageMB: Float!

  # Trending
  performanceTrend: TrendDirection!
  topBottlenecks: [PerformanceBottleneck!]!
}

type QueryPerformanceMetric {
  id: ID!
  queryHash: String!
  queryPreview: String!
  executionTimeMs: Int!
  rowsReturned: Int!
  endpoint: String!
  timestamp: DateTime!
  occurrenceCount: Int!
}

type EndpointMetric {
  endpoint: String!
  method: String!

  # Volume metrics
  totalRequests: Int!
  successfulRequests: Int!
  failedRequests: Int!

  # Performance metrics
  avgResponseTimeMs: Float!
  p50ResponseTimeMs: Float!
  p95ResponseTimeMs: Float!
  p99ResponseTimeMs: Float!
  maxResponseTimeMs: Float!

  # Data transfer
  avgRequestSizeBytes: Int!
  avgResponseSizeBytes: Int!

  # Trending
  trend: TrendDirection!
}

type ResourceMetric {
  timestamp: DateTime!
  cpuUsagePercent: Float!
  memoryUsedMB: Int!
  memoryTotalMB: Int!
  eventLoopLagMs: Float!
  activeConnections: Int!
  heapUsedMB: Int!
  heapTotalMB: Int!
}

type DatabasePoolMetrics {
  currentConnections: Int!
  idleConnections: Int!
  waitingRequests: Int!
  totalQueries: Int!
  avgQueryTimeMs: Float!
  utilizationPercent: Float!

  # Time series data
  utilizationHistory: [PoolUtilizationPoint!]!
}

type PoolUtilizationPoint {
  timestamp: DateTime!
  utilizationPercent: Float!
  activeConnections: Int!
  queuedRequests: Int!
}

type PerformanceBottleneck {
  type: BottleneckType!
  severity: Severity!
  description: String!
  impact: String!
  recommendation: String!
  affectedEndpoints: [String!]!
}

enum BottleneckType {
  SLOW_QUERY
  HIGH_CPU
  MEMORY_LEAK
  CONNECTION_POOL_EXHAUSTION
  N_PLUS_ONE_QUERY
  UNINDEXED_QUERY
  LARGE_PAYLOAD
}

enum TimeRange {
  LAST_HOUR
  LAST_6_HOURS
  LAST_24_HOURS
  LAST_7_DAYS
  LAST_30_DAYS
  CUSTOM
}

enum TrendDirection {
  IMPROVING
  STABLE
  DEGRADING
  CRITICAL
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  CRITICAL
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

type DatabaseStats {
  connectionStats: ConnectionStats!
  queryStats: QueryStats!
  tableStats: TableStats!
  performanceStats: PerformanceStats!
}

type ConnectionStats {
  total: Int!
  active: Int!
  idle: Int!
  waiting: Int!
  maxConnections: Int!
}

type QueryStats {
  totalQueries: Int!
  avgQueryTimeMs: Float!
  slowQueries: Int!
  cacheHitRatio: Float!
}

type TableStats {
  totalTables: Int!
  totalRows: Int!
  totalSizeMB: Float!
  indexSizeMB: Float!
}

type PerformanceStats {
  transactionsPerSecond: Float!
  blocksRead: Int!
  blocksHit: Int!
  tuplesReturned: Int!
  tuplesFetched: Int!
}

scalar DateTime
