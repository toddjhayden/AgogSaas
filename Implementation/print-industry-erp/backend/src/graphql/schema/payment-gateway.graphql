# =====================================================
# PAYMENT GATEWAY SCHEMA
# =====================================================
# Stripe, ACH, Payment Methods, Gateway Transactions
# Created: 2025-12-30
# REQ-STRATEGIC-AUTO-1767084329261
# =====================================================

"""
PaymentGatewayTransaction - Transaction log from payment gateway
"""
type PaymentGatewayTransaction {
  id: ID!
  tenantId: ID!
  paymentId: ID

  # Gateway Details
  gatewayProvider: String!
  gatewayTransactionId: String!
  gatewayCustomerId: String
  gatewayPaymentMethodId: String

  # Transaction Details
  transactionType: String!
  amount: Float!
  currencyCode: String!
  status: String!

  # Customer Info
  customerId: ID
  customerEmail: String

  # Gateway Response
  gatewayResponseCode: String
  gatewayResponseMessage: String
  gatewayFeeAmount: Float
  netAmount: Float

  # Idempotency
  idempotencyKey: String
  webhookEventId: String
  webhookReceivedAt: DateTime

  # Dates
  initiatedAt: DateTime!
  completedAt: DateTime

  # Error Handling
  errorMessage: String
  errorCode: String
  retryCount: Int
  lastRetryAt: DateTime

  # Audit
  createdAt: DateTime!
  createdBy: ID
  updatedAt: DateTime
  updatedBy: ID
}

"""
CustomerPaymentMethod - Tokenized customer payment methods (cards, bank accounts)
"""
type CustomerPaymentMethod {
  id: ID!
  tenantId: ID!
  customerId: ID!

  # Payment Method Details
  paymentMethodType: String!
  isDefault: Boolean!

  # Gateway Integration (TOKENIZED - PCI COMPLIANT)
  gatewayProvider: String!
  gatewayPaymentMethodId: String!
  gatewayCustomerId: String

  # Masked Display Info
  displayName: String
  cardBrand: String
  cardLast4: String
  cardExpMonth: Int
  cardExpYear: Int
  cardFunding: String
  bankLast4: String
  bankName: String
  bankAccountType: String

  # Verification Status
  isActive: Boolean!
  verified: Boolean!
  verificationDate: DateTime
  verificationMethod: String

  # Audit
  createdAt: DateTime!
  createdBy: ID
  updatedAt: DateTime
  updatedBy: ID
}

"""
PaymentResult - Result of payment processing operation
"""
type PaymentResult {
  success: Boolean!
  payment: Payment
  gatewayTransaction: PaymentGatewayTransaction
  requiresAction: Boolean
  clientSecret: String
  errorMessage: String
  errorCode: String
}

# =====================================================
# INPUT TYPES
# =====================================================

"""
ProcessCardPaymentInput - Input for processing card payment
"""
input ProcessCardPaymentInput {
  tenantId: ID!
  customerId: ID!
  invoiceIds: [ID!]!
  amount: Float!
  currencyCode: String!
  paymentMethodId: String! # Stripe PaymentMethod ID (pm_xxx)
  savePaymentMethod: Boolean
  facilityId: ID
  notes: String
}

"""
ProcessACHPaymentInput - Input for processing ACH payment
"""
input ProcessACHPaymentInput {
  tenantId: ID!
  customerId: ID!
  invoiceIds: [ID!]!
  amount: Float!
  currencyCode: String!
  bankAccountId: String! # Stripe Bank Account ID
  facilityId: ID
  notes: String
}

"""
SavePaymentMethodInput - Input for saving payment method
"""
input SavePaymentMethodInput {
  tenantId: ID!
  customerId: ID!
  paymentMethodId: String! # From Stripe.js client-side tokenization
  setAsDefault: Boolean
}

"""
VerifyBankAccountInput - Input for verifying bank account
"""
input VerifyBankAccountInput {
  tenantId: ID!
  customerId: ID!
  bankAccountId: String!
  amounts: [Float!]! # Micro-deposit amounts
}

"""
RefundPaymentInput - Input for refunding payment
"""
input RefundPaymentInput {
  tenantId: ID!
  paymentId: ID!
  amount: Float # Optional - full refund if not specified
  reason: String
}

# =====================================================
# QUERIES
# =====================================================

extend type Query {
  """
  Get customer payment methods
  """
  customerPaymentMethods(
    tenantId: ID!
    customerId: ID!
  ): [CustomerPaymentMethod!]!

  """
  Get payment gateway transaction by ID
  """
  paymentGatewayTransaction(
    id: ID!
  ): PaymentGatewayTransaction

  """
  Get payment gateway transactions with filters
  """
  paymentGatewayTransactions(
    tenantId: ID!
    customerId: ID
    status: String
    startDate: Date
    endDate: Date
    limit: Int
    offset: Int
  ): [PaymentGatewayTransaction!]!
}

# =====================================================
# MUTATIONS
# =====================================================

extend type Mutation {
  """
  Process card payment via Stripe
  """
  processCardPayment(
    input: ProcessCardPaymentInput!
  ): PaymentResult!

  """
  Process ACH payment via Stripe
  """
  processACHPayment(
    input: ProcessACHPaymentInput!
  ): PaymentResult!

  """
  Save payment method for customer
  """
  savePaymentMethod(
    input: SavePaymentMethodInput!
  ): CustomerPaymentMethod!

  """
  Remove payment method
  """
  removePaymentMethod(
    tenantId: ID!
    paymentMethodId: ID!
  ): Boolean!

  """
  Verify bank account with micro-deposits
  """
  verifyBankAccount(
    input: VerifyBankAccountInput!
  ): CustomerPaymentMethod!

  """
  Refund payment
  """
  refundPayment(
    input: RefundPaymentInput!
  ): PaymentResult!
}
