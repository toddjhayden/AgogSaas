# Network Policies - 5-Tier Security Zones
# Implements Todd's security architecture

---
# Namespace Labels for Security Zones
apiVersion: v1
kind: Namespace
metadata:
  name: agogsaas-blue
  labels:
    security-zone: "restricted"
    environment: "blue"
---
apiVersion: v1
kind: Namespace
metadata:
  name: agogsaas-green
  labels:
    security-zone: "restricted"
    environment: "green"
---
# Zone 1: Standard Access (Frontend)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-policy
  namespace: agogsaas-blue
spec:
  podSelector:
    matchLabels:
      app: frontend
      tier: web
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
  egress:
  # Allow to backend API
  - to:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 4000
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
# Zone 2: Restricted Access (Backend API)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-policy
  namespace: agogsaas-blue
spec:
  podSelector:
    matchLabels:
      app: backend
      tier: api
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from frontend
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 4000
  # Allow from ingress for direct API access
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 4000
  egress:
  # Allow to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow to NATS
  - to:
    - namespaceSelector:
        matchLabels:
          name: default
      podSelector:
        matchLabels:
          app: nats
    ports:
    - protocol: TCP
      port: 4222
  # Allow to Ollama
  - to:
    - podSelector:
        matchLabels:
          app: ollama
    ports:
    - protocol: TCP
      port: 11434
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS for external APIs
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
---
# Zone 3: Secure Access (Database)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-policy
  namespace: agogsaas-blue
spec:
  podSelector:
    matchLabels:
      app: postgres
      tier: database
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow from backend
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 5432
  # Allow from same StatefulSet (for replication)
  - from:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Allow from monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 5432
  egress:
  # Allow to other PostgreSQL instances (for replication)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Allow to other regions (cross-region replication)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 5432
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
# Zone 4: High-Security Access (Redis - Session Data)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-policy
  namespace: agogsaas-blue
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow from backend
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 6379
  # Allow from monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 6379
  egress:
  # Redis doesn't need outbound (standalone mode)
  # Allow DNS for cluster mode
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
# Zone 5: Vault-Level Access (Ollama - AI Models)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ollama-policy
  namespace: agogsaas-blue
spec:
  podSelector:
    matchLabels:
      app: ollama
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow from backend
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 11434
  # Allow from monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 11434
  egress:
  # Allow HTTPS for model downloads
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
# Default Deny All (for Green environment)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: agogsaas-green
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

# ============================================================================
# NETWORK POLICY NOTES
# ============================================================================
#
# 5-TIER SECURITY ZONES (from MASTER_BUILD_PLAN.md):
# 1. Standard: Frontend (public access)
# 2. Restricted: Backend API (authenticated users)
# 3. Secure: Database (backend only)
# 4. High-Security: Redis/Session Data (backend only)
# 5. Vault: AI Models/Ollama (backend only, audit logged)
#
# REQUIREMENTS:
# - Network Policy support in CNI (Calico, Cilium, etc.)
# - Not supported by default kubenet
#
# TESTING:
# - Verify isolation: kubectl run test --rm -it --image=busybox -- wget -O- http://postgres:5432
# - Should be blocked if policy working
#
# GREEN ENVIRONMENT:
# - Copy all policies from Blue to Green
# - Maintain identical security posture
#
# MONITORING:
# - Enable CNI logging for denied connections
# - Alert on repeated policy violations
#
