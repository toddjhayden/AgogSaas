# AgogSaaS Regional Cloud Deployment
# Regions: US-EAST, EU-CENTRAL, APAC
# Architecture: Blue-Green deployment with full redundancy
# Purpose: High-availability regional cloud infrastructure

version: '3.8'

networks:
  regional-network:
    driver: bridge

volumes:
  # Blue Environment
  postgres-blue-data:
  redis-blue-data:
  ollama-blue-data:

  # Green Environment
  postgres-green-data:
  redis-green-data:
  ollama-green-data:

  # Shared Infrastructure
  nats-data:
  prometheus-data:
  grafana-data:
  nginx-certs:

services:
  # ============================================================================
  # BLUE ENVIRONMENT - Currently Active
  # ============================================================================

  postgres-blue:
    image: pgvector/pgvector:pg16
    container_name: regional-postgres-blue
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-agogsaas}
      POSTGRES_USER: ${DB_USER:-agogsaas_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      ENVIRONMENT: blue
      REGION: ${REGION}
    volumes:
      - postgres-blue-data:/var/lib/postgresql/data
      - ../../Implementation/print-industry-erp/backend/migrations:/docker-entrypoint-initdb.d
      - ./postgres/replication-setup.sh:/docker-entrypoint-initdb.d/99-replication.sh
    ports:
      - "5432:5432"
    networks:
      - regional-network
    command: |
      postgres
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c max_connections=200
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-agogsaas_user} -d ${DB_NAME:-agogsaas}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "agog.environment=blue"
      - "agog.tier=regional-cloud"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

  redis-blue:
    image: redis:7-alpine
    container_name: regional-redis-blue
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis-blue-data:/data
    ports:
      - "6379:6379"
    networks:
      - regional-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "agog.environment=blue"
      - "agog.tier=regional-cloud"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  backend-blue:
    build:
      context: ../../Implementation/print-industry-erp/backend
      dockerfile: Dockerfile.production
    container_name: regional-backend-blue
    restart: unless-stopped
    depends_on:
      postgres-blue:
        condition: service_healthy
      redis-blue:
        condition: service_healthy
      nats:
        condition: service_started
      ollama-blue:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 4000
      ENVIRONMENT: blue
      REGION: ${REGION}
      # Database
      DATABASE_URL: postgresql://${DB_USER:-agogsaas_user}:${DB_PASSWORD}@postgres-blue:5432/${DB_NAME:-agogsaas}
      # Redis
      REDIS_URL: redis://redis-blue:6379
      # NATS
      NATS_URL: nats://nats:4222
      # Ollama
      OLLAMA_URL: http://ollama-blue:11434
      OLLAMA_ENABLED: "true"
      # Security
      JWT_SECRET: ${JWT_SECRET}
      # GraphQL
      GRAPHQL_PLAYGROUND: "false"
      GRAPHQL_INTROSPECTION: "false"
      # Multi-Region
      CROSS_REGION_SYNC_ENABLED: "true"
      OTHER_REGIONS: ${OTHER_REGIONS}
      # Edge Sync
      EDGE_SYNC_ENABLED: "true"
    ports:
      - "4001:4000"
    networks:
      - regional-network
    labels:
      - "agog.environment=blue"
      - "agog.tier=regional-cloud"
      - "agog.region=${REGION}"
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend-blue:
    build:
      context: ../../Implementation/print-industry-erp/frontend
      dockerfile: Dockerfile.production
    container_name: regional-frontend-blue
    restart: unless-stopped
    depends_on:
      - backend-blue
    environment:
      VITE_API_URL: http://nginx/graphql
      VITE_ENVIRONMENT: blue
      VITE_REGION: ${REGION}
    ports:
      - "3001:80"
    networks:
      - regional-network
    labels:
      - "agog.environment=blue"
      - "agog.tier=regional-cloud"
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  ollama-blue:
    image: ollama/ollama:latest
    container_name: regional-ollama-blue
    restart: unless-stopped
    volumes:
      - ollama-blue-data:/root/.ollama
    ports:
      - "11435:11434"
    networks:
      - regional-network
    labels:
      - "agog.environment=blue"
      - "agog.tier=regional-cloud"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # GREEN ENVIRONMENT - Deployment Target
  # ============================================================================

  postgres-green:
    image: pgvector/pgvector:pg16
    container_name: regional-postgres-green
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-agogsaas}
      POSTGRES_USER: ${DB_USER:-agogsaas_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      ENVIRONMENT: green
      REGION: ${REGION}
    volumes:
      - postgres-green-data:/var/lib/postgresql/data
      - ../../Implementation/print-industry-erp/backend/migrations:/docker-entrypoint-initdb.d
      - ./postgres/replication-setup.sh:/docker-entrypoint-initdb.d/99-replication.sh
    ports:
      - "5433:5432"
    networks:
      - regional-network
    command: |
      postgres
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c max_connections=200
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-agogsaas_user} -d ${DB_NAME:-agogsaas}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "agog.environment=green"
      - "agog.tier=regional-cloud"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

  redis-green:
    image: redis:7-alpine
    container_name: regional-redis-green
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis-green-data:/data
    ports:
      - "6380:6379"
    networks:
      - regional-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "agog.environment=green"
      - "agog.tier=regional-cloud"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  backend-green:
    build:
      context: ../../Implementation/print-industry-erp/backend
      dockerfile: Dockerfile.production
    container_name: regional-backend-green
    restart: unless-stopped
    depends_on:
      postgres-green:
        condition: service_healthy
      redis-green:
        condition: service_healthy
      nats:
        condition: service_started
      ollama-green:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 4000
      ENVIRONMENT: green
      REGION: ${REGION}
      # Database
      DATABASE_URL: postgresql://${DB_USER:-agogsaas_user}:${DB_PASSWORD}@postgres-green:5432/${DB_NAME:-agogsaas}
      # Redis
      REDIS_URL: redis://redis-green:6379
      # NATS
      NATS_URL: nats://nats:4222
      # Ollama
      OLLAMA_URL: http://ollama-green:11434
      OLLAMA_ENABLED: "true"
      # Security
      JWT_SECRET: ${JWT_SECRET}
      # GraphQL
      GRAPHQL_PLAYGROUND: "false"
      GRAPHQL_INTROSPECTION: "false"
      # Multi-Region
      CROSS_REGION_SYNC_ENABLED: "true"
      OTHER_REGIONS: ${OTHER_REGIONS}
      # Edge Sync
      EDGE_SYNC_ENABLED: "true"
    ports:
      - "4002:4000"
    networks:
      - regional-network
    labels:
      - "agog.environment=green"
      - "agog.tier=regional-cloud"
      - "agog.region=${REGION}"
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend-green:
    build:
      context: ../../Implementation/print-industry-erp/frontend
      dockerfile: Dockerfile.production
    container_name: regional-frontend-green
    restart: unless-stopped
    depends_on:
      - backend-green
    environment:
      VITE_API_URL: http://nginx/graphql
      VITE_ENVIRONMENT: green
      VITE_REGION: ${REGION}
    ports:
      - "3002:80"
    networks:
      - regional-network
    labels:
      - "agog.environment=green"
      - "agog.tier=regional-cloud"
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  ollama-green:
    image: ollama/ollama:latest
    container_name: regional-ollama-green
    restart: unless-stopped
    volumes:
      - ollama-green-data:/root/.ollama
    ports:
      - "11436:11434"
    networks:
      - regional-network
    labels:
      - "agog.environment=green"
      - "agog.tier=regional-cloud"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # SHARED INFRASTRUCTURE
  # ============================================================================

  nats:
    image: nats:latest
    container_name: regional-nats
    restart: unless-stopped
    command: |
      --jetstream
      --store_dir=/data
      --max_mem_store=4GB
      --max_file_store=100GB
      --cluster_name=${REGION}
      --http_port=8222
    volumes:
      - nats-data:/data
    ports:
      - "4222:4222"  # Client
      - "8222:8222"  # Monitoring
      - "6222:6222"  # Cluster routing
    networks:
      - regional-network
    labels:
      - "agog.tier=shared-infrastructure"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 6G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ============================================================================
  # NGINX - Load Balancer & Reverse Proxy
  # ============================================================================

  nginx:
    image: nginx:alpine
    container_name: regional-nginx
    restart: unless-stopped
    depends_on:
      - backend-blue
      - backend-green
      - frontend-blue
      - frontend-green
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/blue-green.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx-certs:/etc/nginx/certs
    ports:
      - "80:80"
      - "443:443"
    networks:
      - regional-network
    environment:
      ACTIVE_ENVIRONMENT: ${ACTIVE_ENVIRONMENT:-blue}
    labels:
      - "agog.tier=load-balancer"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # MONITORING - Prometheus + Grafana
  # ============================================================================

  prometheus:
    image: prom/prometheus:latest
    container_name: regional-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - regional-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    labels:
      - "agog.tier=monitoring"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  grafana:
    image: grafana/grafana:latest
    container_name: regional-grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      - "3000:3000"
    networks:
      - regional-network
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: https://grafana.${REGION}.agogsaas.com
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    labels:
      - "agog.tier=monitoring"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  # ============================================================================
  # ALERTMANAGER - Alert Routing
  # ============================================================================

  alertmanager:
    image: prom/alertmanager:latest
    container_name: regional-alertmanager
    restart: unless-stopped
    volumes:
      - ./prometheus/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    ports:
      - "9093:9093"
    networks:
      - regional-network
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    labels:
      - "agog.tier=monitoring"
      - "agog.region=${REGION}"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

# ============================================================================
# REGIONAL DEPLOYMENT NOTES
# ============================================================================
#
# REGIONS:
# - US-EAST (Virginia, AWS us-east-1 or Azure East US)
# - EU-CENTRAL (Frankfurt, AWS eu-central-1 or Azure West Europe)
# - APAC (Singapore, AWS ap-southeast-1 or Azure Southeast Asia)
#
# HARDWARE REQUIREMENTS (per region):
# - 16+ vCPUs, 64GB+ RAM, 1TB+ SSD
# - High-availability: Multi-AZ deployment
# - Auto-scaling: 3-10 backend replicas based on load
#
# DEPLOYMENT:
# 1. Copy .env.regional.example to .env
# 2. Configure REGION, DB_PASSWORD, JWT_SECRET
# 3. Run: docker-compose -f docker-compose.regional.yml up -d
# 4. Verify: ./scripts/health-check.sh
#
# BLUE-GREEN DEPLOYMENT:
# - Deploy to GREEN: docker-compose up -d backend-green frontend-green
# - Smoke test GREEN: ./scripts/smoke-test.sh green
# - Switch traffic: ./scripts/switch-blue-green.sh green
# - Monitor for 24h
# - Rollback if issues: ./scripts/switch-blue-green.sh blue
#
# MULTI-REGION REPLICATION:
# - PostgreSQL logical replication between regions
# - NATS clustering for cross-region messaging
# - See: ./scripts/setup-replication.sh
#
# MONITORING:
# - Prometheus: http://localhost:9090
# - Grafana: http://localhost:3000
# - NATS: http://localhost:8222
#
