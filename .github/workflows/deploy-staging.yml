name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip integration tests'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  STAGING_URL: https://staging.agogsaas.com

jobs:
  # =============================================================================
  # Build and Push Docker Images
  # =============================================================================
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      backend-tag: ${{ steps.meta-backend.outputs.tags }}
      frontend-tag: ${{ steps.meta-frontend.outputs.tags }}
      image-digest-backend: ${{ steps.build-backend.outputs.digest }}
      image-digest-frontend: ${{ steps.build-frontend.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push backend image
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: Implementation/print-industry-erp/backend
          file: Implementation/print-industry-erp/backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha,scope=backend-staging
          cache-to: type=gha,mode=max,scope=backend-staging
          platforms: linux/amd64

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push frontend image
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: Implementation/print-industry-erp/frontend
          file: Implementation/print-industry-erp/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha,scope=frontend-staging
          cache-to: type=gha,mode=max,scope=frontend-staging
          platforms: linux/amd64
          build-args: |
            VITE_GRAPHQL_URL=${{ env.STAGING_URL }}/graphql

      - name: Image size report
        run: |
          echo "Docker image sizes:"
          docker images | grep -E "(backend|frontend)" | grep staging || true

  # =============================================================================
  # Deploy to Staging Environment
  # =============================================================================
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: staging
      url: ${{ env.STAGING_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to staging server
        run: |
          echo "Deploying to staging environment..."

          # Copy deployment script
          scp -i ~/.ssh/staging_key \
            deployment/scripts/deploy-staging.sh \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/tmp/

          # Execute deployment
          ssh -i ~/.ssh/staging_key \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "bash /tmp/deploy-staging.sh \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:staging-${{ github.sha }} \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:staging-${{ github.sha }}"

      - name: Wait for deployment
        run: |
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          ssh -i ~/.ssh/staging_key \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "cd /opt/agogsaas && docker-compose exec -T backend npm run migrate"

      - name: Verify deployment
        run: |
          echo "Verifying deployment health..."
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f ${{ env.STAGING_URL }}/health; then
              echo "Staging environment is healthy!"
              exit 0
            fi

            echo "Health check failed, retrying... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          echo "Deployment verification failed after $MAX_RETRIES attempts"
          exit 1

  # =============================================================================
  # Integration Tests
  # =============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        run: |
          npm install -g newman
          npm install -g k6

      - name: Run API tests
        run: |
          echo "Running API integration tests against staging..."

          # Basic GraphQL health check
          curl -X POST ${{ env.STAGING_URL }}/graphql \
            -H "Content-Type: application/json" \
            -d '{"query":"{ __typename }"}' \
            | grep "Query" || exit 1

          echo "API tests passed!"

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."

          # Test backend health
          curl -f ${{ env.STAGING_URL }}/health || exit 1

          # Test frontend
          curl -f ${{ env.STAGING_URL }} | grep "AgogSaaS" || exit 1

          # Test GraphQL endpoint
          curl -X POST ${{ env.STAGING_URL }}/graphql \
            -H "Content-Type: application/json" \
            -d '{"query":"{ __typename }"}' \
            | grep "Query" || exit 1

          echo "All smoke tests passed!"

      - name: Performance test
        run: |
          echo "Running basic performance test..."

          # Create k6 test script
          cat > test.js << 'EOF'
          import http from 'k6/http';
          import { check } from 'k6';

          export let options = {
            vus: 10,
            duration: '30s',
          };

          export default function () {
            let res = http.get('${{ env.STAGING_URL }}/health');
            check(res, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            });
          }
          EOF

          k6 run test.js || echo "Performance test completed with warnings"

  # =============================================================================
  # Deployment Notification
  # =============================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, integration-tests]
    if: always()

    steps:
      - name: Deployment success notification
        if: needs.deploy.result == 'success' && needs.integration-tests.result == 'success'
        run: |
          echo "Staging deployment successful!"
          echo "URL: ${{ env.STAGING_URL }}"
          echo "Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:staging-${{ github.sha }}"
          echo "Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:staging-${{ github.sha }}"

          # Send Slack notification if webhook is configured
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "Staging Deployment Successful",
                "attachments": [{
                  "color": "good",
                  "fields": [
                    {"title": "Environment", "value": "Staging", "short": true},
                    {"title": "Commit", "value": "${{ github.sha }}", "short": true},
                    {"title": "Author", "value": "${{ github.actor }}", "short": true},
                    {"title": "URL", "value": "${{ env.STAGING_URL }}", "short": true}
                  ]
                }]
              }'
          fi

      - name: Deployment failure notification
        if: needs.deploy.result == 'failure' || needs.integration-tests.result == 'failure'
        run: |
          echo "Staging deployment failed!"

          # Send Slack notification if webhook is configured
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "Staging Deployment Failed",
                "attachments": [{
                  "color": "danger",
                  "fields": [
                    {"title": "Environment", "value": "Staging", "short": true},
                    {"title": "Commit", "value": "${{ github.sha }}", "short": true},
                    {"title": "Author", "value": "${{ github.actor }}", "short": true},
                    {"title": "Logs", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false}
                  ]
                }]
              }'
          fi
          exit 1

  # =============================================================================
  # Rollback on Failure
  # =============================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy, integration-tests]
    if: failure()

    steps:
      - name: Rollback to previous version
        run: |
          echo "Rolling back staging deployment..."

          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key

          # Trigger rollback script on staging server
          ssh -i ~/.ssh/staging_key \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "cd /opt/agogsaas && docker-compose down && docker-compose up -d"

          echo "Rollback completed"
