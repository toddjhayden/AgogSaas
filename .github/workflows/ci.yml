name: Continuous Integration

on:
  push:
    branches:
      - master
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - master
      - develop

env:
  NODE_VERSION: '20'
  BACKEND_DIR: Implementation/print-industry-erp/backend
  FRONTEND_DIR: Implementation/print-industry-erp/frontend
  AGENT_BACKEND_DIR: Implementation/print-industry-erp/agent-backend

jobs:
  # =============================================================================
  # Security Checks - Run First
  # =============================================================================
  security-check:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          echo "Scanning for exposed secrets..."
          # Check for common secret patterns
          if grep -r "PRIVATE_KEY\|SECRET_KEY\|API_KEY.*=.*['\"].*['\"]" . --exclude-dir={node_modules,.git,dist,build}; then
            echo "ERROR: Potential secrets found in code!"
            exit 1
          fi
          echo "No secrets detected"

      - name: Check .env files not committed
        run: |
          if git ls-files | grep -E "^\.env$|\.env\.local$"; then
            echo "ERROR: .env files should not be committed!"
            exit 1
          fi
          echo ".env files check passed"

  # =============================================================================
  # Lint and Type Check
  # =============================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: security-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/package-lock.json
            ${{ env.FRONTEND_DIR }}/package-lock.json
            ${{ env.AGENT_BACKEND_DIR }}/package-lock.json

      - name: Install backend dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Install agent-backend dependencies
        working-directory: ${{ env.AGENT_BACKEND_DIR }}
        run: npm ci

      - name: Lint backend
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run lint

      - name: Lint frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run lint

      - name: TypeScript check backend
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run build

      - name: TypeScript check frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run build

      - name: TypeScript check agent-backend
        working-directory: ${{ env.AGENT_BACKEND_DIR }}
        run: npm run build

  # =============================================================================
  # Unit Tests
  # =============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: agogsaas_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      nats:
        image: nats:latest
        options: >-
          --health-cmd "nc -z localhost 4222"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 4222:4222

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/package-lock.json
            ${{ env.FRONTEND_DIR }}/package-lock.json
            ${{ env.AGENT_BACKEND_DIR }}/package-lock.json

      - name: Install backend dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Install agent-backend dependencies
        working-directory: ${{ env.AGENT_BACKEND_DIR }}
        run: npm ci

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/agogsaas_test
        run: |
          echo "Setting up test database..."
          PGPASSWORD=test_password psql -h localhost -U test_user -d agogsaas_test -f ${{ env.BACKEND_DIR }}/migrations/V1.0.0__enable_extensions.sql || true
          PGPASSWORD=test_password psql -h localhost -U test_user -d agogsaas_test -f ${{ env.BACKEND_DIR }}/migrations/V1.0.1__create_monitoring_tables.sql || true

      - name: Run backend tests
        working-directory: ${{ env.BACKEND_DIR }}
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/agogsaas_test
          NATS_URL: nats://localhost:4222
          NODE_ENV: test
        run: npm test -- --coverage --maxWorkers=2

      - name: Run frontend tests
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm test -- --coverage

      - name: Upload backend coverage
        uses: codecov/codecov-action@v5
        with:
          files: ${{ env.BACKEND_DIR }}/coverage/lcov.info
          flags: backend
          name: backend-coverage

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v5
        with:
          files: ${{ env.FRONTEND_DIR }}/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  # =============================================================================
  # Build Docker Images (verify only, don't push)
  # =============================================================================
  docker-build:
    name: Verify Docker Builds
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BACKEND_DIR }}
          file: ${{ env.BACKEND_DIR }}/Dockerfile
          push: false
          tags: agogsaas-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.FRONTEND_DIR }}
          file: ${{ env.FRONTEND_DIR }}/Dockerfile
          push: false
          tags: agogsaas-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================================================
  # Smoke Tests
  # =============================================================================
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services with Docker Compose
        run: |
          # Create test .env
          cp .env.example .env
          echo "DB_PASSWORD=test_password" >> .env

          # Start services
          docker-compose up -d

          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Run smoke tests
        run: |
          chmod +x tests/smoke/smoke-test.sh
          cd tests/smoke
          ./smoke-test.sh || (docker-compose logs && exit 1)

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # =============================================================================
  # CI Summary
  # =============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [security-check, lint, test, docker-build, smoke-test]
    if: success()

    steps:
      - name: CI passed
        run: |
          echo "All CI checks passed successfully!"
          echo "Ready for deployment."

  ci-failure:
    name: CI Failure
    runs-on: ubuntu-latest
    needs: [security-check, lint, test, docker-build, smoke-test]
    if: failure()

    steps:
      - name: CI failed
        run: |
          echo "CI checks failed. Please review the errors above."
          exit 1
